# Inline Annotated R Markdown: 01_prepare_data_Inline_Annotated

## Code Chunk 1
```{r}
sample_metadata <- read_excel("~/btp_metagenomics/data/Merged_Metadata.xlsx") %>%
    rename(sample=1)
```

## Code Chunk 2
```{r}
read_counts <- read_tsv("data/DMB0167_counts.tsv.gz") %>%
    rename(genome=1) %>% 
    select(one_of(c("genome",sample_metadata$sample)))  # Select specific columns from the data
```

## Code Chunk 3
```{r}
genome_metadata <- read_tsv("data/DMB0167_mag_info.tsv.gz") %>%
    rename(length=mag_size)%>%
  semi_join(., read_counts, by = "genome") %>% 
  arrange(match(genome,read_counts$genome))
```

## Code Chunk 4
```{r}
genome_coverage <- read_tsv("data/DMB0167_coverage.tsv.gz") %>%
    rename(genome=1) %>% 
    select(one_of(c("genome",sample_metadata$sample)))%>%   # Select specific columns from the data
  semi_join(., genome_metadata, by = "genome")%>%
  arrange(match(genome, read_counts$genome))
```

## Code Chunk 5
```{r}
genome_tree <- read_tree("data/DMB0167.tree.gz")
genome_tree$tip.label <- str_replace_all(genome_tree$tip.label,"'", "") #remove single quotes in MAG names
genome_tree <- keep.tip(genome_tree, tip=genome_metadata$genome) # keep only MAG tips
```

## Code Chunk 6
```{r}
library(rairtable)
Sys.setenv(AIRTABLE_API_KEY = "patmRpNHp5cMxwd8y.ac9b4c3710ad0a2ab334ec3ffa971fb97834f96d0244640f0cedacf0f1d44e22")
##
```

## Code Chunk 7
```{r}
# STEP 1: Get annotation URLs from Airtable
anno_urls <- airtable(
  base = "appWbHBNLE6iAsMRV",
  table = "tblMzd3oyaJhdeQcs",
  view = "viwx4daClBXQW02LB"
) %>%
  read_airtable(fields = c("ID", "mag_name", "number_genes", "anno_url"), id_to_col = TRUE) %>%
  filter(  # Filter the data to include only rows that meet certain conditions
    mag_name %in% paste0(genome_metadata$genome, ".fa"),
    number_genes > 0,
    !is.na(anno_url),
    anno_url != ""
  ) %>%
  pull(anno_url)

# STEP 2: Download and merge annotations with explicit column names
successful_data <- list()
successful_urls <- c()
failed_urls <- c()

if (length(anno_urls) > 0) {
  walk(anno_urls, function(url) {
    tryCatch({
      df <- suppressMessages(read_tsv(
        url,
        col_types = cols(),
        col_names = c("gene", "genome", "contig"),
        skip = 0  # change to 1 if you want to skip header row
      ))

      # Keep only the first 3 columns (ignore extras)
      df <- df[, 1:3]

      successful_data <<- append(successful_data, list(df))
      successful_urls <<- c(successful_urls, url)
    }, error = function(e) {
      message("❌ Failed to read: ", url)
      failed_urls <<- c(failed_urls, url)
    })
  })

  # Save merged data
  if (length(successful_data) > 0) {
    bind_rows(successful_data) %>%
      write_tsv("data/genome_annotations.tsv.xz")
    message("✅ Merged annotations saved to data/genome_annotations.tsv.xz")
  } else {
    message("⚠️ No data was successfully read.")
  }

  # Save logs
  if (length(successful_urls) > 0) {
    write_lines(successful_urls, "data/successful_annotation_urls.txt")
  }
  if (length(failed_urls) > 0) {
    write_lines(failed_urls, "data/failed_annotation_urls.txt")
  }

} else {
  message("⚠️ No valid annotation URLs found.")
}

#
```

## Code Chunk 8
```{r}
min_coverage=0.3
read_counts_filt <- genome_coverage %>%
  mutate(across(where(is.numeric), ~ ifelse(. > min_coverage, 1, 0))) %>%  # Add or modify columns in the dataset
  mutate(across(-1, ~ . * read_counts[[cur_column()]]))  # Add or modify columns in the dataset
```

## Code Chunk 9
```{r}
readlength=150
genome_counts <- read_counts %>%
  mutate(across(where(is.numeric), ~ . / (genome_metadata$length / readlength) ))  # Add or modify columns in the dataset
```

## Code Chunk 10
```{r}
readlength=150
genome_counts_filt <- read_counts_filt %>%
  mutate(across(where(is.numeric), ~ . / (genome_metadata$length / readlength) ))  # Add or modify columns in the dataset
```

## Code Chunk 11
```{r}
genome_gifts <- distill(genome_annotations,GIFT_db,genomecol=2,annotcol=c(9,10,19), verbosity=F)
```

## Code Chunk 12
```{r}
phylum_colors <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
    right_join(genome_metadata, by=join_by(phylum == phylum)) %>%
    arrange(match(genome, genome_tree$tip.label)) %>%
    select(phylum, colors) %>%   # Select specific columns from the data
    unique() %>%
    arrange(phylum) %>%
    pull(colors, name=phylum)
```

## Code Chunk 13
```{r}
save(sample_metadata, 
     genome_metadata, 
     read_counts, 
     genome_counts, 
     genome_counts_filt, 
     genome_tree,
     genome_gifts,
     phylum_colors,
     file = "data/data.Rdata")
```

