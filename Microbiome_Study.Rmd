# Inline Annotated R Markdown: index_Inline_Annotated

## Code Chunk 1
```{r}
knitr::opts_chunk$set(
    class.source = "script-source",
    class.output = "script-output",
    comment = NA)
```

## Code Chunk 2
```{r}
# Base
library(R.utils)
library(knitr)
library(tidyverse)
library(devtools)
library(tinytable)
library(rairtable)
library(readxl)

# For tree handling
library(ape)
library(phyloseq)
library(phytools)

# For plotting
library(ggplot2)  # Begin plotting using ggplot2
library(ggrepel)
library(ggpubr)
library(ggnewscale)
library(gridExtra)
library(ggtreeExtra)
library(ggtree)
library(ggh4x)

# For statistics
library(spaa)
library(vegan)
library(Rtsne)
library(geiger)
library(hilldiv2)
library(distillR)
library(broom.mixed)
#library(lmerTest)
library(Hmsc)
library(corrplot)
library(lme4)
library(nlme)
library(ANCOMBC)
#for geogrphic visualisation
library(rnaturalearth)
library(rnaturalearthdata)
library(patchwork)
```


<!--chapter:end:index.Rmd-->

# Inline Annotated R Markdown: 01_prepare_data_Inline_Annotated

## Code Chunk 1
```{r}
sample_metadata <- read_excel("~/btp_metagenomics/data/Merged_Metadata.xlsx") %>%
    rename(sample=1)
```

## Code Chunk 2
```{r}
read_counts <- read_tsv("data/DMB0167_counts.tsv.gz") %>%
    rename(genome=1) %>% 
    select(one_of(c("genome",sample_metadata$sample)))  # Select specific columns from the data
```

## Code Chunk 3
```{r}
genome_metadata <- read_tsv("data/DMB0167_mag_info.tsv.gz") %>%
    rename(length=mag_size)%>%
  semi_join(., read_counts, by = "genome") %>% 
  arrange(match(genome,read_counts$genome))
```

## Code Chunk 4
```{r}
genome_coverage <- read_tsv("data/DMB0167_coverage.tsv.gz") %>%
    rename(genome=1) %>% 
    select(one_of(c("genome",sample_metadata$sample)))%>%   # Select specific columns from the data
  semi_join(., genome_metadata, by = "genome")%>%
  arrange(match(genome, read_counts$genome))
```

## Code Chunk 5
```{r}
genome_tree <- read_tree("data/DMB0167.tree.gz")
genome_tree$tip.label <- str_replace_all(genome_tree$tip.label,"'", "") #remove single quotes in MAG names
genome_tree <- keep.tip(genome_tree, tip=genome_metadata$genome) # keep only MAG tips
```

## Code Chunk 6
```{r}
library(rairtable)
Sys.setenv(AIRTABLE_API_KEY = "patmRpNHp5cMxwd8y.ac9b4c3710ad0a2ab334ec3ffa971fb97834f96d0244640f0cedacf0f1d44e22")
##
```

## Code Chunk 7
```{r}
# STEP 1: Get annotation URLs from Airtable
anno_urls <- airtable(
  base = "appWbHBNLE6iAsMRV",
  table = "tblMzd3oyaJhdeQcs",
  view = "viwx4daClBXQW02LB"
) %>%
  read_airtable(fields = c("ID", "mag_name", "number_genes", "anno_url"), id_to_col = TRUE) %>%
  filter(  # Filter the data to include only rows that meet certain conditions
    mag_name %in% paste0(genome_metadata$genome, ".fa"),
    number_genes > 0,
    !is.na(anno_url),
    anno_url != ""
  ) %>%
  pull(anno_url)

# STEP 2: Download and merge annotations with explicit column names
successful_data <- list()
successful_urls <- c()
failed_urls <- c()

if (length(anno_urls) > 0) {
  walk(anno_urls, function(url) {
    tryCatch({
      df <- suppressMessages(read_tsv(
        url,
        col_types = cols(),
        col_names = c("gene", "genome", "contig"),
        skip = 0  # change to 1 if you want to skip header row
      ))

      # Keep only the first 3 columns (ignore extras)
      df <- df[, 1:3]

      successful_data <<- append(successful_data, list(df))
      successful_urls <<- c(successful_urls, url)
    }, error = function(e) {
      message("❌ Failed to read: ", url)
      failed_urls <<- c(failed_urls, url)
    })
  })

  # Save merged data
  if (length(successful_data) > 0) {
    bind_rows(successful_data) %>%
      write_tsv("data/genome_annotations.tsv.xz")
    message("✅ Merged annotations saved to data/genome_annotations.tsv.xz")
  } else {
    message("⚠️ No data was successfully read.")
  }

  # Save logs
  if (length(successful_urls) > 0) {
    write_lines(successful_urls, "data/successful_annotation_urls.txt")
  }
  if (length(failed_urls) > 0) {
    write_lines(failed_urls, "data/failed_annotation_urls.txt")
  }

} else {
  message("⚠️ No valid annotation URLs found.")
}

#
```

## Code Chunk 8
```{r}
min_coverage=0.3
read_counts_filt <- genome_coverage %>%
  mutate(across(where(is.numeric), ~ ifelse(. > min_coverage, 1, 0))) %>%  # Add or modify columns in the dataset
  mutate(across(-1, ~ . * read_counts[[cur_column()]]))  # Add or modify columns in the dataset
```

## Code Chunk 9
```{r}
readlength=150
genome_counts <- read_counts %>%
  mutate(across(where(is.numeric), ~ . / (genome_metadata$length / readlength) ))  # Add or modify columns in the dataset
```

## Code Chunk 10
```{r}
readlength=150
genome_counts_filt <- read_counts_filt %>%
  mutate(across(where(is.numeric), ~ . / (genome_metadata$length / readlength) ))  # Add or modify columns in the dataset
```

## Code Chunk 11
```{r}
genome_gifts <- distill(genome_annotations,GIFT_db,genomecol=2,annotcol=c(9,10,19), verbosity=F)
```

## Code Chunk 12
```{r}
phylum_colors <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
    right_join(genome_metadata, by=join_by(phylum == phylum)) %>%
    arrange(match(genome, genome_tree$tip.label)) %>%
    select(phylum, colors) %>%   # Select specific columns from the data
    unique() %>%
    arrange(phylum) %>%
    pull(colors, name=phylum)
```

## Code Chunk 13
```{r}
save(sample_metadata, 
     genome_metadata, 
     read_counts, 
     genome_counts, 
     genome_counts_filt, 
     genome_tree,
     genome_gifts,
     phylum_colors,
     file = "data/data.Rdata")
```


<!--chapter:end:01_prepare_data.Rmd-->

# Inline Annotated R Markdown: 02_data_statistics_Inline_Annotated

## Code Chunk 1
```{r}
load("data/data.Rdata")  # Load an RData file with variables and datasets
```

## Code Chunk 2
```{r}
# Define extended boundary to include all possum data points
lat_min <- -45.0  # Slightly smaller than -42.93
lat_max <- -28.0  # Slightly larger than -30.65
lon_min <- 110.0  # Slightly smaller than 116.47
lon_max <- 150.0  # Slightly larger than 148.28

# Full dataset with all points (Tasmania & Australia border)
full_possums <- sample_metadata %>%
  filter(latitude >= lat_min & latitude <= lat_max,   # Filter the data to include only rows that meet certain conditions
         longitude >= lon_min & longitude <= lon_max)

# Filter for Tasmania only
tasmania_possums <- full_possums %>%
  filter(latitude < -38 & latitude > -45,  # Tasmania lat range  # Filter the data to include only rows that meet certain conditions
         longitude > 140 & longitude < 150)  # Tasmania lon range

# Aggregate possum count per location
full_possums_count <- full_possums %>%
  group_by(latitude, longitude, broad.scale.environmental.context) %>%  # Group the data by one or more variables
  summarise(count = n(), .groups = "drop")  # Summarize grouped data (e.g., calculate averages)

tasmania_possums_count <- tasmania_possums %>%
  group_by(latitude, longitude, broad.scale.environmental.context) %>%  # Group the data by one or more variables
  summarise(count = n(), .groups = "drop")  # Summarize grouped data (e.g., calculate averages)
```

## Code Chunk 3
```{r}
# Load world map
australia_map <- ne_countries(scale = "medium", returnclass = "sf") %>%
  filter(admin == "Australia")  # Filter the data to include only rows that meet certain conditions
```

## Code Chunk 4
```{r}
# Get Tasmania data range to set zoom
lat_range <- range(tasmania_possums$latitude, na.rm = TRUE)
lon_range <- range(tasmania_possums$longitude, na.rm = TRUE)

# Count total possums
total_full <- sum(full_possums_count$count)
total_tasmania <- sum(tasmania_possums_count$count)

# Plot 1: Full Dataset (Including Border Data)
map_plot_full <- ggplot() +  # Begin plotting using ggplot2
  geom_sf(data = australia_map, fill = "lightgray", color = "black") +  # Base map  # Add a specific type of plot layer (bars, points, lines, etc.)
  geom_point(data = full_possums_count, aes(x = longitude, y = latitude,   # Add a specific type of plot layer (bars, points, lines, etc.)
                                            color = broad.scale.environmental.context, size = count), 
             alpha = 0.8) +
  theme_minimal() + 
  labs(title = paste("PD - Full Dataset (", total_full, ")"),  # Customize axis labels or plot titles
       x = "Longitude", y = "Latitude", color = "Environment Type", size = "Count", shape = "species") +
  theme(legend.position = "none",  # Customize visual aspects of the plot
        plot.title = element_text(size = 14, face = "bold"))

# Plot 2: Zoomed-in Tasmania (with entire landmass and cleaned longitude labels)
map_plot_zoomed <- ggplot() +  # Begin plotting using ggplot2
  geom_sf(data = australia_map, fill = "lightgray", color = "black") +  # Base map  # Add a specific type of plot layer (bars, points, lines, etc.)
  geom_point(data = tasmania_possums_count, aes(x = longitude, y = latitude,   # Add a specific type of plot layer (bars, points, lines, etc.)
                                                color = broad.scale.environmental.context, size = count), 
             alpha = 0.8) + 
  coord_sf(xlim = c(143, 149), ylim = c(-44, -39)) +  # Full Tasmania view
  theme_minimal() + 
  labs(title = paste("PD - Tasmania (", total_tasmania, ")"),  # Customize axis labels or plot titles
       x = "Longitude", y = "Latitude",
       color = "Environment Type", size = "Count", shape = "species" ) +
  theme(legend.position = "right",   # Customize visual aspects of the plot
        axis.text.x = element_text(angle = 0, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold"))

# Combine the plots side by side with shared legend and increased size
(map_plot_full + map_plot_zoomed) + plot_layout(guides = "collect", widths = c(1, 1.2))
```

## Code Chunk 5
```{r}
# Define extended boundary to include all possum data points
lat_min <- -45.0  # Slightly smaller than -42.93
lat_max <- -28.0  # Slightly larger than -30.65
lon_min <- 110.0  # Slightly smaller than 116.47
lon_max <- 150.0  # Slightly larger than 148.28

# Full dataset with all points (Tasmania & Australia border)
full_possums <- sample_metadata %>%
  filter(latitude >= lat_min & latitude <= lat_max,   # Filter the data to include only rows that meet certain conditions
         longitude >= lon_min & longitude <= lon_max)

# Filter for Tasmania only
tasmania_possums <- full_possums %>%
  filter(latitude < -38 & latitude > -45,  # Tasmania lat range  # Filter the data to include only rows that meet certain conditions
         longitude > 140 & longitude < 150)  # Tasmania lon range

# Aggregate possum count per location
full_possums_count <- full_possums %>%
  group_by(latitude, longitude, local.environmental.context) %>%  # Group the data by one or more variables
  summarise(count = n(), .groups = "drop")  # Summarize grouped data (e.g., calculate averages)

tasmania_possums_count <- tasmania_possums %>%
  group_by(latitude, longitude, local.environmental.context) %>%  # Group the data by one or more variables
  summarise(count = n(), .groups = "drop")  # Summarize grouped data (e.g., calculate averages)
```

## Code Chunk 6
```{r}
# Load world map
australia_map <- ne_countries(scale = "medium", returnclass = "sf") %>%
  filter(admin == "Australia")  # Filter the data to include only rows that meet certain conditions
```

## Code Chunk 7
```{r}
library(RColorBrewer)

# Get Tasmania data range to set zoom
lat_range <- range(tasmania_possums$latitude, na.rm = TRUE)
lon_range <- range(tasmania_possums$longitude, na.rm = TRUE)

# Count total possums
total_full <- sum(full_possums_count$count)
total_tasmania <- sum(tasmania_possums_count$count)

# Plot 1: Full Dataset (Including Border Data)
map_plot_full <- ggplot() +  # Begin plotting using ggplot2
  geom_sf(data = australia_map, fill = "lightgray", color = "black") +  # Add a specific type of plot layer (bars, points, lines, etc.)
  geom_point(data = full_possums_count, aes(x = longitude, y = latitude,  # Add a specific type of plot layer (bars, points, lines, etc.)
                                            color = local.environmental.context, size = count),
             alpha = 0.8) +
  scale_color_viridis_d(name = "Environment Type", option = "D") +  # Adjust color scales, axes, or fill options
  theme_minimal() +
  labs(title = paste("PD - Full Dataset (", total_full, ")"),  # Customize axis labels or plot titles
       x = "Longitude", y = "Latitude") +
  theme(  # Customize visual aspects of the plot
    plot.title = element_text(size = 10, face = "bold"),
    legend.position = "none"
  )

# Plot 2: Zoomed-in Tasmania
map_plot_zoomed <- ggplot() +  # Begin plotting using ggplot2
  geom_sf(data = australia_map, fill = "lightgray", color = "black") +  # Add a specific type of plot layer (bars, points, lines, etc.)
  geom_point(data = tasmania_possums_count, aes(x = longitude, y = latitude,  # Add a specific type of plot layer (bars, points, lines, etc.)
                                                color = local.environmental.context, size = count),
             alpha = 0.8) +
  coord_sf(xlim = c(143, 149), ylim = c(-44, -39)) +
  scale_color_viridis_d(name = "Environment Type", option = "D") +  # Adjust color scales, axes, or fill options
  theme_minimal() +
  labs(title = paste("PD - Tasmania (", total_tasmania, ")"),  # Customize axis labels or plot titles
       x = "Longitude", y = "Latitude") +
  theme(  # Customize visual aspects of the plot
    plot.title = element_text(size = 10, face = "bold"),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    legend.position = "none"
  )

# Combine the plots side by side
(map_plot_full + map_plot_zoomed) +
  plot_layout(widths = c(1, 1.2))
```

## Code Chunk 8
```{r}
# Step 1: Create simplified/aggregated legend data
legend_data <- tasmania_possums_count %>%
  group_by(local.environmental.context) %>%  # Group the data by one or more variables
  summarise(mean_count = mean(count, na.rm = TRUE)) %>%  # Summarize grouped data (e.g., calculate averages)
  filter(!is.na(local.environmental.context)) %>%  # Filter the data to include only rows that meet certain conditions
  arrange(desc(mean_count)) %>%
  mutate(env_label = paste0(local.environmental.context))  # Add or modify columns in the dataset

# Step 2: Plot custom "legend" with clean layout
custom_legend_plot <- ggplot(legend_data, aes(x = 1, y = reorder(env_label, mean_count),  # Begin plotting using ggplot2
                                              color = env_label, size = mean_count)) +
  geom_point(show.legend = FALSE) +  # Add a specific type of plot layer (bars, points, lines, etc.)
  scale_size_continuous(range = c(3, 6)) +  # tweak dot size scaling  # Adjust color scales, axes, or fill options
  scale_color_viridis_d(name = "Environment Type", option = "D") +  # Adjust color scales, axes, or fill options
  theme_minimal() +
  theme(  # Customize visual aspects of the plot
    axis.title = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(10, 30, 10, 10),
    axis.text.y = element_text(size = 9, hjust = 0)
  )

# Show it
custom_legend_plot
```

## Code Chunk 9
```{r}
sample_metadata %>% 
    summarise(Total=sum(reads_post_fastp * 150 / 1000000000) %>% round(2),   # Summarize grouped data (e.g., calculate averages)
              mean=mean(reads_post_fastp * 150 / 1000000000) %>% round(2),
              sd=sd(reads_post_fastp * 150 / 1000000000) %>% round(2)) %>%
    unite("Average",mean, sd, sep = " ± ", remove = TRUE) %>%
    tt()
```

## Code Chunk 10
```{r}
sequence_fractions <- read_counts %>%
  pivot_longer(-genome, names_to = "sample", values_to = "value") %>%
  group_by(sample) %>%  # Group the data by one or more variables
  summarise(mags = sum(value)) %>%  # Summarize grouped data (e.g., calculate averages)
	left_join(sample_metadata, by = join_by(sample == sample)) %>%  # Merge two datasets, keeping all rows from the left one
	select(sample,mags,metagenomic_bases,host_bases,bases_lost_fastp_percent) %>%  # Select specific columns from the data
	mutate(mags_bases = mags*146) %>%  # Add or modify columns in the dataset
	mutate(lowqual_bases = ((metagenomic_bases+host_bases)/(1-bases_lost_fastp_percent))-(metagenomic_bases+host_bases)) %>%  # Add or modify columns in the dataset
	mutate(unmapped_bases = metagenomic_bases - mags_bases) %>%  # Add or modify columns in the dataset
	mutate(unmapped_bases = ifelse(unmapped_bases < 0, 0, unmapped_bases)) %>%  # Add or modify columns in the dataset
	select(sample, lowqual_bases, host_bases, unmapped_bases, mags_bases)  # Select specific columns from the data

sequence_fractions %>%
  mutate_at(vars(-sample), ~./1000000000) %>%
  rename("Sample"=1, "Low quality"=2, "Mapped to host"=3, "Unmapped"=4, "Mapped to MAGs"=5) %>%
  tt()

sequence_fractions %>%
  mutate_at(vars(-sample), ~./1000000000) %>%
  rename("Sample"=1, "Low quality"=2, "Mapped to host"=3, "Unmapped"=4, "Mapped to MAGs"=5) %>%
  summarise(across(where(is.numeric), mean, na.rm = TRUE)) %>%  # Summarize grouped data (e.g., calculate averages)
  tt()
```

## Code Chunk 11
```{r}
sequence_fractions %>%
	pivot_longer(!sample, names_to = "fraction", values_to = "value") %>%
	mutate(value = value / 1000000000) %>%  # Add or modify columns in the dataset
	mutate(fraction = factor(fraction, levels = c("lowqual_bases","host_bases","unmapped_bases","mags_bases"))) %>%  # Add or modify columns in the dataset
  
	ggplot(., aes(x = sample, y = value, fill=fraction)) +  # Begin plotting using ggplot2
	    geom_bar(position="stack", stat = "identity") +  # Add a specific type of plot layer (bars, points, lines, etc.)
      scale_fill_manual(name="Sequence type",  # Adjust color scales, axes, or fill options
                    breaks=c("lowqual_bases","host_bases","unmapped_bases","mags_bases"),
                    labels=c("Low quality","Mapped to host","Unmapped","Mapped to MAGs"),
                    values=c("#CCCCCC", "#bcdee1", "#d8b8a3","#93655c"))+
	    labs(x = "Samples", y = "Amount of data (GB)") +  # Customize axis labels or plot titles
	    theme_classic() +
	    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size=6),legend.position = "bottom")  # Customize visual aspects of the plot
```

## Code Chunk 12
```{r}
singlem_table <- sequence_fractions %>%
	mutate(mags_proportion = round((mags_bases / (mags_bases + unmapped_bases))*100,2)) %>%  # Add or modify columns in the dataset
	left_join(sample_metadata, by = join_by(sample == sample))  %>%  # Merge two datasets, keeping all rows from the left one
	mutate(singlem_proportion = round(singlem_fraction,2)) %>%  # Add or modify columns in the dataset
	select(sample,mags_proportion,singlem_proportion) %>%  # Select specific columns from the data
	mutate(mags_proportion = ifelse(singlem_proportion == 0, 0, mags_proportion)) %>% #convert zeros to NA  # Add or modify columns in the dataset
	mutate(singlem_proportion = ifelse(singlem_proportion == 0, NA, singlem_proportion)) %>% #convert zeros to NA  # Add or modify columns in the dataset
	mutate(singlem_proportion = ifelse(singlem_proportion < mags_proportion, NA, singlem_proportion)) %>% #if singlem is smaller, then NA, to simplify plot  # Add or modify columns in the dataset
	mutate(singlem_proportion = ifelse(singlem_proportion > 100, 100, singlem_proportion)) #simplify  # Add or modify columns in the dataset

singlem_table %>%
	pivot_longer(!sample, names_to = "proportion", values_to = "value") %>%
	mutate(proportion = factor(proportion, levels = c("mags_proportion","singlem_proportion"))) %>%  # Add or modify columns in the dataset
	ggplot(., aes(x = value, y = sample, color=proportion)) +  # Begin plotting using ggplot2
			geom_line(aes(group = sample), color = "#f8a538") +  # Add a specific type of plot layer (bars, points, lines, etc.)
			geom_point() +  # Add a specific type of plot layer (bars, points, lines, etc.)
      scale_color_manual(name="Proportion",  # Adjust color scales, axes, or fill options
                    breaks=c("mags_proportion","singlem_proportion"),
                    labels=c("Recovered","Estimated"),
                    values=c("#52e1e8", "#876b53"))+
			theme_classic() +
			labs(y = "Samples", x = "Prokaryotic fraction (%)") +  # Customize axis labels or plot titles
	    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size=6),legend.position = "right")  # Customize visual aspects of the plot
```


<!--chapter:end:02_data_statistics.Rmd-->

# Inline Annotated R Markdown: 03_MAGs_Catalouge_Inline_Annotated

## Code Chunk 1
```{r}
load("data/data.Rdata")  # Load an RData file with variables and datasets
```

## Code Chunk 2
```{r}
# Generate the phylum color heatmap
phylum_heatmap <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
    right_join(genome_metadata, by=join_by(phylum == phylum)) %>%
    arrange(match(genome, genome_tree$tip.label)) %>%
    select(genome,phylum) %>%  # Select specific columns from the data
    mutate(phylum = factor(phylum, levels = unique(phylum))) %>%  # Add or modify columns in the dataset
    column_to_rownames(var = "genome")

# Generate  basal tree
circular_tree <- force.ultrametric(genome_tree, method="extend") %>% # extend to ultrametric for the sake of visualisation
    ggtree(., layout="fan", open.angle=20, size=0.2)
```

## Code Chunk 3
```{r}
circular_tree <- force.ultrametric(genome_tree, method="extend") %>% # extend to ultrametric for the sake of visualisation
  ggtree(., layout="fan", open.angle=10, size=0.5)
```

## Code Chunk 4
```{r}
circular_tree <- gheatmap(circular_tree, phylum_heatmap, offset=0.55, width=0.1, colnames=FALSE) +
  scale_fill_manual(values=phylum_colors) +  # Adjust color scales, axes, or fill options
  geom_tiplab2(size=1, hjust=-0.1) +  # Add a specific type of plot layer (bars, points, lines, etc.)
  theme(legend.position = "none", plot.margin = margin(0, 0, 0, 0), panel.margin = margin(0, 0, 0, 0))  # Customize visual aspects of the plot
```

## Code Chunk 5
```{r}
circular_tree <- circular_tree + new_scale_fill()  # Adjust color scales, axes, or fill options
```

## Code Chunk 6
```{r}
circular_tree <- circular_tree +
  new_scale_fill() +  # Adjust color scales, axes, or fill options
  scale_fill_gradient(low = "#d1f4ba", high = "#f4baba") +  # Adjust color scales, axes, or fill options
  geom_fruit(  # Add a specific type of plot layer (bars, points, lines, etc.)
    data=genome_metadata,
    geom=geom_bar,  # Add a specific type of plot layer (bars, points, lines, etc.)
    mapping = aes(x=completeness, y=genome, fill=contamination),
    offset = 0.55,
    orientation="y",
    stat="identity")
```

## Code Chunk 7
```{r}
circular_tree <-  circular_tree +
  new_scale_fill() +  # Adjust color scales, axes, or fill options
  scale_fill_manual(values = "#cccccc") +  # Adjust color scales, axes, or fill options
  geom_fruit(  # Add a specific type of plot layer (bars, points, lines, etc.)
    data=genome_metadata,
    geom=geom_bar,  # Add a specific type of plot layer (bars, points, lines, etc.)
    mapping = aes(x=length, y=genome),
    offset = 0.05,
    orientation="y",
    stat="identity")
```

## Code Chunk 8
```{r}
ggsave("clean_circular_tree_large.png", plot=circular_tree, dpi=600, width=80, height=80, limitsize = FALSE, units = "cm")

#Plot circular tree
circular_tree %>% open_tree(15) %>% rotate_tree(90)
```

## Code Chunk 9
```{r}
genome_metadata$completeness %>% mean()

genome_metadata$completeness %>% sd()

genome_metadata$contamination %>% mean()

genome_metadata$contamination %>% sd()
```

## Code Chunk 10
```{r}
genome_biplot <- genome_metadata %>%
  select(c(genome,domain,phylum,completeness,contamination,length)) %>%  # Select specific columns from the data
  arrange(match(genome, rev(genome_tree$tip.label))) %>% #sort MAGs according to phylogenetic tree
  ggplot(aes(x=completeness,y=contamination,size=length,color=phylum)) +  # Begin plotting using ggplot2
  geom_point(alpha=0.7) +  # Add a specific type of plot layer (bars, points, lines, etc.)
  ylim(c(10,0)) +
  scale_color_manual(values=phylum_colors) +  # Adjust color scales, axes, or fill options
  labs(y= "Contamination", x = "Completeness") +  # Customize axis labels or plot titles
  theme_classic() +
  theme(legend.position = "none")  # Customize visual aspects of the plot
```

## Code Chunk 11
```{r}
genome_contamination <- genome_metadata %>%
  ggplot(aes(y=contamination)) +  # Begin plotting using ggplot2
  ylim(c(10,0)) +
  geom_boxplot(colour = "#999999", fill="#cccccc") +  # Add a specific type of plot layer (bars, points, lines, etc.)
  theme_void() +
  theme(legend.position = "none",  # Customize visual aspects of the plot
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        plot.margin = unit(c(0, 0, 0.40, 0),"inches")) #add bottom-margin (top, right, bottom, left)
```

## Code Chunk 12
```{r}
genome_completeness <- genome_metadata %>%
  ggplot(aes(x=completeness)) +  # Begin plotting using ggplot2
  xlim(c(50,100)) +
  geom_boxplot(colour = "#999999", fill="#cccccc") +  # Add a specific type of plot layer (bars, points, lines, etc.)
  theme_void() +
  theme(legend.position = "none",  # Customize visual aspects of the plot
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        plot.margin = unit(c(0, 0, 0, 0.50),"inches")) #add left-margin (top, right, bottom, left)
```

## Code Chunk 13
```{r}
grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination),
             layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4),
                                   c(2,2,2,2,2,2,2,2,2,2,2,3),
                                   c(2,2,2,2,2,2,2,2,2,2,2,3),
                                   c(2,2,2,2,2,2,2,2,2,2,2,3),
                                   c(2,2,2,2,2,2,2,2,2,2,2,3),
                                   c(2,2,2,2,2,2,2,2,2,2,2,3),
                                   c(2,2,2,2,2,2,2,2,2,2,2,3),
                                   c(2,2,2,2,2,2,2,2,2,2,2,3),
                                   c(2,2,2,2,2,2,2,2,2,2,2,3),
                                   c(2,2,2,2,2,2,2,2,2,2,2,3),
                                   c(2,2,2,2,2,2,2,2,2,2,2,3)))
```

## Code Chunk 14
```{r}
function_table <- genome_gifts %>%
  to.elements(., GIFT_db)
```

## Code Chunk 15
```{r}
function_tree <- force.ultrametric(genome_tree, method="extend") %>%
  ggtree(., size = 0.3)
```

## Code Chunk 16
```{r}
function_tree <- gheatmap(function_tree, phylum_heatmap, offset=0, width=0.1, colnames=FALSE) +
  scale_fill_manual(values=phylum_colors) +  # Adjust color scales, axes, or fill options
  labs(fill="Phylum")  # Customize axis labels or plot titles
```

## Code Chunk 17
```{r}
function_tree <- function_tree + new_scale_fill()  # Adjust color scales, axes, or fill options
```

## Code Chunk 18
```{r}
function_tree <- gheatmap(function_tree, function_table, offset=0.5, width=3.5, colnames=FALSE) +
  vexpand(.08) +
  coord_cartesian(clip = "off") +
  scale_fill_gradient(low = "#f4f4f4", high = "steelblue", na.value="white") +  # Adjust color scales, axes, or fill options
  labs(fill="GIFT")  # Customize axis labels or plot titles
```

## Code Chunk 19
```{r}
function_tree <- function_tree +
  geom_fruit(data=genome_metadata,  # Add a specific type of plot layer (bars, points, lines, etc.)
             geom=geom_bar,  # Add a specific type of plot layer (bars, points, lines, etc.)
             grid.params=list(axis="x", text.size=2, nbreak = 1),
             axis.params=list(vline=TRUE),
             mapping = aes(x=length, y=genome, fill=completeness),
             offset = 3.8,
             orientation="y",
             stat="identity") +
  scale_fill_gradient(low = "#cf8888", high = "#a2cc87") +  # Adjust color scales, axes, or fill options
  labs(fill="Genome\ncompleteness")  # Customize axis labels or plot titles

function_tree

ggsave("function_tree_highres.png", 
       plot = function_tree, 
       width = 12, 
       height = 10, 
       dpi = 600)  # Higher dpi = better quality
```

## Code Chunk 20
```{r}
tSNE_function <- Rtsne(X=function_table, dims = 2, check_duplicates = FALSE)
```

## Code Chunk 21
```{r}
function_ordination <- tSNE_function$Y %>%
  as.data.frame() %>%
  mutate(genome=rownames(function_table)) %>%  # Add or modify columns in the dataset
  inner_join(genome_metadata, by="genome") %>%
  rename(tSNE1="V1", tSNE2="V2") %>%
  select(genome,phylum,tSNE1,tSNE2, length) %>%  # Select specific columns from the data
  ggplot(aes(x = tSNE1, y = tSNE2, color = phylum, size=length))+  # Begin plotting using ggplot2
  geom_point(shape=16, alpha=0.7) +  # Add a specific type of plot layer (bars, points, lines, etc.)
  scale_color_manual(values=phylum_colors) +  # Adjust color scales, axes, or fill options
  theme_minimal() +
  labs(color="Phylum", size="Genome size") +  # Customize axis labels or plot titles
  guides(color = guide_legend(override.aes = list(size = 5))) # enlarge Phylum dots in legend

function_ordination
```


<!--chapter:end:03_MAGs_Catalouge.Rmd-->

# Inline Annotated R Markdown: Community Composition

This version keeps the format similar to your original R Markdown file,
with `#` comments added **at the end of code lines** wherever possible.

## Code Chunk 1
```{r}
load("data/data.Rdata")  # Load the saved R data file containing datasets and variables
```

## Code Chunk 2
```{r}
genome_counts_filt %>%
  mutate_at(vars(-genome),~./sum(.)) %>% #apply TSS normalisation  # Normalize counts in each column (TSS normalization)
  pivot_longer(-genome, names_to = "sample", values_to = "count") %>% #reduce to minimum number of columns  # Transform wide data to long format for plotting
  left_join(., genome_metadata, by = join_by(genome == genome)) %>% #append genome metadata  # Add metadata about each genome
  left_join(., sample_metadata, by = join_by(sample == sample)) %>% #append sample metadata  # Add metadata about each sample
  filter(!is.na(count)) %>%  # Keep only rows that have actual values
  ggplot(aes(y=count,x=sample, fill=phylum, group=phylum)) + #grouping enables keeping the same sorting of taxonomic units  # Start plotting: define x, y, fill colors
    geom_bar(stat="identity", colour="white", linewidth=0.1) + #plot stacked bars with white borders  # Draw stacked bar charts for each sample
    scale_fill_manual(values=phylum_colors) +  # Use specific colors for phylum groups
    labs(x = "Relative abundance", y ="Samples") +  # Label the x and y axes
    facet_nested(. ~ species.y ,  scales="free", space="free") + #facet per day and treatment  # Split the plots by species and treatment
    scale_y_continuous(expand = c(0.001, 0.001)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
          axis.title.x = element_blank(),
          panel.background = element_blank(),
          panel.border = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line = element_line(linewidth = 0.5, linetype = "solid", colour = "black"),
          legend.position = "none",
          strip.background.x=element_rect(color = NA, fill= "#f4f4f4"))
```

## Code Chunk 3
```{r}
phylum_summary <- genome_counts_filt %>%
  mutate_at(vars(-genome),~./sum(.)) %>% #apply TSS nornalisation  # Normalize counts in each column (TSS normalization)
  pivot_longer(-genome, names_to = "sample", values_to = "count") %>%  # Transform wide data to long format for plotting
  left_join(sample_metadata, by = join_by(sample == sample)) %>%  # Add metadata about each sample
  left_join(genome_metadata, by = join_by(genome == genome)) %>%  # Add metadata about each genome
  group_by(sample,phylum) %>%
  summarise(relabun=sum(count))

phylum_summary %>%
    group_by(phylum) %>%
    summarise(mean=mean(relabun),sd=sd(relabun)) %>%
    arrange(-mean) %>%
    tt()
```

## Code Chunk 4
```{r}
phylum_arrange <- phylum_summary %>%
    group_by(phylum) %>%
    summarise(mean=mean(relabun)) %>%
    arrange(-mean) %>%
    select(phylum) %>%
    pull()

phylum_summary %>%
    filter(phylum %in% phylum_arrange) %>%
    mutate(phylum=factor(phylum,levels=rev(phylum_arrange))) %>%
    ggplot(aes(x=relabun, y=phylum, group=phylum, color=phylum)) +  # Start plotting: define x, y, fill colors
        scale_color_manual(values=phylum_colors[rev(phylum_arrange)]) +
        geom_jitter(alpha=0.5) + 
        theme_minimal() + 
        theme(legend.position="none") +
        labs(y="Phylum",x="Relative abundance")  # Label the x and y axes
```

## Code Chunk 5
```{r}
family_summary <- genome_counts_filt %>%
  mutate_at(vars(-genome),~./sum(.)) %>% #apply TSS nornalisation  # Normalize counts in each column (TSS normalization)
  pivot_longer(-genome, names_to = "sample", values_to = "count") %>% #reduce to minimum number of columns  # Transform wide data to long format for plotting
  left_join(sample_metadata, by = join_by(sample == sample)) %>% #append sample metadata  # Add metadata about each sample
  left_join(., genome_metadata, by = join_by(genome == genome)) %>% #append genome metadata  # Add metadata about each genome
  group_by(sample,family) %>%
  summarise(relabun=sum(count))

family_summary %>%
    filter(!is.na(relabun)) %>%  # Keep only rows that have actual values
    group_by(family) %>%
    summarise(mean=mean(relabun),sd=sd(relabun)) %>%
    mutate(family= sub("^f__", "", family)) %>%
    arrange(-mean) %>%
    tt()
```

## Code Chunk 6
```{r}
family_arrange <- family_summary %>%
    filter(!is.na(relabun)) %>%  # Keep only rows that have actual values
    group_by(family) %>%
    summarise(mean=sum(relabun)) %>%
    arrange(-mean) %>%
    select(family) %>%
    mutate(family= sub("^f__", "", family)) %>%
    pull()

family_summary %>%
    left_join(genome_metadata %>% select(family,phylum) %>% unique(),by=join_by(family==family)) %>%  # Add metadata about each genome
    left_join(sample_metadata,by=join_by(sample==sample)) %>%  # Add metadata about each sample
    mutate(family= sub("^f__", "", family)) %>%
    filter(family %in% family_arrange[1:20]) %>%
    mutate(family=factor(family,levels=rev(family_arrange[1:20]))) %>%
    filter(relabun > 0) %>%
    ggplot(aes(x=relabun, y=family, group=family, color=phylum, fill=phylum)) +  # Start plotting: define x, y, fill colors
        scale_color_manual(values=phylum_colors[-8]) +
        scale_fill_manual(values=phylum_colors[-8]) +  # Use specific colors for phylum groups
        #geom_boxplot(alpha=0.2) +
        geom_jitter(alpha=0.5) + 
        facet_nested(. ~ species + sample_type)+  # Split the plots by species and treatment
        theme_minimal() +
        theme(legend.position = "none")
```

## Code Chunk 7
```{r}
genus_summary <- genome_counts_filt %>%
  mutate_at(vars(-genome),~./sum(.)) %>% #apply TSS nornalisation  # Normalize counts in each column (TSS normalization)
  pivot_longer(-genome, names_to = "sample", values_to = "count") %>% #reduce to minimum number of columns  # Transform wide data to long format for plotting
  left_join(sample_metadata, by = join_by(sample == sample)) %>% #append sample metadata  # Add metadata about each sample
  left_join(genome_metadata, by = join_by(genome == genome)) %>% #append genome metadata  # Add metadata about each genome
  group_by(sample,genus) %>%
  summarise(relabun=sum(count)) %>%
  filter(genus != "g__")

genus_summary %>%
    filter(!is.na(relabun)) %>%  # Keep only rows that have actual values
    group_by(genus) %>%
    summarise(mean=mean(relabun),sd=sd(relabun)) %>%
    arrange(-mean) %>%
    tt()
```

## Code Chunk 8
```{r}
genus_arrange <- genus_summary %>%
    group_by(genus) %>%
    summarise(mean=sum(relabun)) %>%
    filter(genus != "g__")%>%
    arrange(-mean) %>%
    select(genus) %>%
    mutate(genus= sub("^g__", "", genus)) %>%
    pull()

genus_summary %>%
    left_join(genome_metadata %>% select(genus,phylum) %>% unique(),by=join_by(genus==genus)) %>%  # Add metadata about each genome
    left_join(sample_metadata,by=join_by(sample==sample)) %>%  # Add metadata about each sample
    mutate(genus= sub("^g__", "", genus)) %>%
    filter(genus %in% genus_arrange[1:20]) %>%
    mutate(genus=factor(genus,levels=rev(genus_arrange[1:20]))) %>%
    filter(relabun > 0) %>%
    ggplot(aes(x=relabun, y=genus, group=genus, color=phylum)) +  # Start plotting: define x, y, fill colors
        scale_color_manual(values=phylum_colors) +
        #geom_boxplot() +
        geom_jitter(alpha=0.5) + 
        facet_nested(. ~ species )+  # Split the plots by species and treatment
        theme_minimal()
```

## Code Chunk 9
```{r}
# Calculate Hill numbers
richness <- genome_counts_filt %>%
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 0) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(richness = 1) %>%
  rownames_to_column(var = "sample")

neutral <- genome_counts_filt %>%
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 1) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(neutral = 1) %>%
  rownames_to_column(var = "sample")

phylogenetic <- genome_counts_filt %>%
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 1, tree = genome_tree) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(phylogenetic = 1) %>%
  rownames_to_column(var = "sample")

# Aggregate basal GIFT into elements
dist <- genome_gifts %>%
  to.elements(., GIFT_db) %>%
  traits2dist(., method = "gower")

functional <- genome_counts_filt %>%
  filter(genome %in% labels(dist)[[1]]) %>%
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 1, dist = dist) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(functional = 1) %>%
  rownames_to_column(var = "sample") %>%
  mutate(functional = if_else(is.nan(functional), 1, functional))

# Merge all metrics
alpha_div <- richness %>%
  full_join(neutral, by = join_by(sample == sample)) %>%
  full_join(phylogenetic, by = join_by(sample == sample)) %>%
  full_join(functional, by = join_by(sample == sample))
```

## Code Chunk 10
```{r}
alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%  # Transform wide data to long format for plotting
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%  # Add metadata about each sample
  mutate(metric=factor(metric,levels=c("richness","neutral","phylogenetic","functional"))) %>%
  unite("group", c(species,sample_type), remove = FALSE) %>%
      ggplot(aes(y = value, x = group, group=group, color=group, fill=group)) +  # Start plotting: define x, y, fill colors
      geom_boxplot(outlier.shape = NA) +
      geom_jitter(alpha=0.5) +
      scale_color_manual(name="Group",
          breaks=c("Cathartes aura_Colon contents","Coragyps atratus_Colon contents","Cathartes aura_Stomach contents","Coragyps atratus_Stomach contents"),
          labels=c("Cathartes aura (colon)","Coragyps atratus (colon)","Cathartes aura (stomach)","Coragyps atratus (stomach)"),
          values=c("#e5bd5b", "#6b7398","#e2815a", "#876b96")) +
      scale_fill_manual(name="Group",  # Use specific colors for phylum groups
          breaks=c("Cathartes aura_Colon contents","Coragyps atratus_Colon contents","Cathartes aura_Stomach contents","Coragyps atratus_Stomach contents"),
          labels=c("Cathartes aura (colon)","Coragyps atratus (colon)","Cathartes aura (stomach)","Coragyps atratus (stomach)"),
          values=c("#e5bd5b50", "#6b739850","#e2815a50", "#876b9650")) +
      facet_wrap(. ~ metric, scales = "free", ncol=4) +
      coord_cartesian(xlim = c(1, NA)) +
      theme_classic() +
      theme(
        strip.background = element_blank(),
        panel.grid.minor.x = element_line(size = .1, color = "grey"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank())
```

## Code Chunk 11
```{r}
beta_q0n <- genome_counts_filt %>%
  column_to_rownames(., "genome") %>%
  hillpair(., q = 0)

beta_q1n <- genome_counts_filt %>%
  column_to_rownames(., "genome") %>%
  hillpair(., q = 1)

beta_q1p <- genome_counts_filt %>%
  column_to_rownames(., "genome") %>%
  hillpair(., q = 1, tree = genome_tree)

beta_q1f <- genome_counts_filt %>%
  filter(genome %in% labels(dist)[[1]]) %>%
  column_to_rownames(., "genome") %>%
  hillpair(., q = 1, dist = dist)
```

## Code Chunk 12
```{r}
#Richness
betadisper(beta_q0n$C, sample_metadata$region) %>% permutest(., pairwise = TRUE)
```

## Code Chunk 13
```{r}
adonis2(beta_q0n$C ~ region,   # Run a PERMANOVA test to compare groups
        data = sample_metadata %>% arrange(match(sample,labels(beta_q1n$C))), 
        permutations = 999, 
        strata = sample_metadata %>% arrange(match(sample,labels(beta_q1n$C))) %>% pull(sample)) %>%
        broom::tidy() %>%
        tt()
```

## Code Chunk 14
```{r}
#Neutral diversity
betadisper(beta_q1n$C, sample_metadata$region) %>% permutest(., pairwise = TRUE)
```

## Code Chunk 15
```{r}
adonis2(beta_q1n$C ~ region,   # Run a PERMANOVA test to compare groups
        data = sample_metadata %>% arrange(match(sample,labels(beta_q1n$C))), 
        permutations = 999, 
        strata = sample_metadata %>% arrange(match(sample,labels(beta_q1n$C))) %>% pull(sample)) %>%
        broom::tidy() %>%
        tt()
```

## Code Chunk 16
```{r}
#Phylogenetic diversity
betadisper(beta_q1p$C, sample_metadata$region) %>% permutest(., pairwise = TRUE)
```

## Code Chunk 17
```{r}
adonis2(beta_q1p$C ~ region,   # Run a PERMANOVA test to compare groups
        data = sample_metadata %>% arrange(match(sample,labels(beta_q1n$C))), 
        permutations = 999, 
        strata = sample_metadata %>% arrange(match(sample,labels(beta_q1n$C))) %>% pull(sample)) %>%
        broom::tidy() %>%
        tt()
```

## Code Chunk 18
```{r}
adonis2(beta_q1f$C ~ region,   # Run a PERMANOVA test to compare groups
        data = sample_metadata %>% arrange(match(sample,labels(beta_q1n$C))), 
        permutations = 999, 
        strata = sample_metadata %>% arrange(match(sample,labels(beta_q1n$C))) %>% pull(sample)) %>%
        broom::tidy() %>%
        tt()
```

## Code Chunk 19
```{r}
beta_q0n$S %>%
  vegan::metaMDS(., trymax = 500, k = 2, verbosity = FALSE, trace=FALSE) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %>%  # Add metadata about each sample
  group_by(region) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  mutate(sample=factor(sample, levels=c("Sg1","Sg2","Sg3","Sg4","Sg5","Sg6","Sg7","Sg8","Sg9","Sg10"))) %>%
  ungroup() %>%
  ggplot(aes(x = NMDS1, y = NMDS2, color = region, shape = sample)) +  # Start plotting: define x, y, fill colors
    scale_shape_manual(values = 1:10) +
    geom_point(size = 4) +
    #   stat_ellipse(aes(color = beta_q1n_nmds$Groups))+
    geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9) +
    theme_classic() +
    theme(
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      axis.title = element_text(size = 20, face = "bold"),
      axis.text = element_text(face = "bold", size = 18),
      panel.background = element_blank(),
      axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
      legend.text = element_text(size = 16),
      legend.title = element_text(size = 18),
      legend.position = "right", legend.box = "vertical"
    ) +
    labs(shape="Individual")  # Label the x and y axes
```

## Code Chunk 20
```{r}
beta_q1n$S %>%
  vegan::metaMDS(., trymax = 500, k = 2, verbosity = FALSE, trace=FALSE) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %>%  # Add metadata about each sample
  group_by(region) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  mutate(individual=factor(individual, levels=c("Sg1","Sg2","Sg3","Sg4","Sg5","Sg6","Sg7","Sg8","Sg9","Sg10"))) %>%
  ungroup() %>%
  ggplot(aes(x = NMDS1, y = NMDS2, color = type, shape = individual)) +  # Start plotting: define x, y, fill colors
    scale_color_manual(name="Sample type",
          breaks=c("cloaca","feces"),
          labels=c("Cloaca","Faeces"),
          values=c("#e5bd5b", "#6b7398")) +
    scale_shape_manual(values = 1:10) +
    geom_point(size = 4) +
    #   stat_ellipse(aes(color = beta_q1n_nmds$Groups))+
    geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9) +
    theme_classic() +
    theme(
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      axis.title = element_text(size = 20, face = "bold"),
      axis.text = element_text(face = "bold", size = 18),
      panel.background = element_blank(),
      axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
      legend.text = element_text(size = 16),
      legend.title = element_text(size = 18),
      legend.position = "right", legend.box = "vertical"
    ) +
    labs(shape="Individual")  # Label the x and y axes
```

## Code Chunk 21
```{r}
beta_q1p$S %>%
  vegan::metaMDS(., trymax = 500, k = 2, verbosity = FALSE, trace=FALSE) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %>%  # Add metadata about each sample
  group_by(region) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  mutate(individual=factor(individual, levels=c("Sg1","Sg2","Sg3","Sg4","Sg5","Sg6","Sg7","Sg8","Sg9","Sg10"))) %>%
  ungroup() %>%
  ggplot(aes(x = NMDS1, y = NMDS2, color = type, shape = individual)) +  # Start plotting: define x, y, fill colors
    scale_color_manual(name="Sample type",
          breaks=c("cloaca","feces"),
          labels=c("Cloaca","Faeces"),
          values=c("#e5bd5b", "#6b7398")) +
    scale_shape_manual(values = 1:10) +
    geom_point(size = 4) +
    #   stat_ellipse(aes(color = beta_q1n_nmds$Groups))+
    geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9) +
    theme_classic() +
    theme(
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      axis.title = element_text(size = 20, face = "bold"),
      axis.text = element_text(face = "bold", size = 18),
      panel.background = element_blank(),
      axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
      legend.text = element_text(size = 16),
      legend.title = element_text(size = 18),
      legend.position = "right", legend.box = "vertical"
    ) +
    labs(shape="Individual")  # Label the x and y axes
```

## Code Chunk 22
```{r}
beta_q1p$S %>%
  vegan::metaMDS(., trymax = 500, k = 2, verbosity = FALSE, trace=FALSE) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %>%  # Add metadata about each sample
  group_by(region) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  mutate(individual=factor(individual, levels=c("Sg1","Sg2","Sg3","Sg4","Sg5","Sg6","Sg7","Sg8","Sg9","Sg10"))) %>%
  ungroup() %>%
  ggplot(aes(x = NMDS1, y = NMDS2, color = type, shape = individual)) +  # Start plotting: define x, y, fill colors
    scale_color_manual(name="Sample type",
          breaks=c("cloaca","feces"),
          labels=c("Cloaca","Faeces"),
          values=c("#e5bd5b", "#6b7398")) +
    scale_shape_manual(values = 1:10) +
    geom_point(size = 4) +
    #   stat_ellipse(aes(color = beta_q1n_nmds$Groups))+
    geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9) +
    theme_classic() +
    theme(
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      axis.title = element_text(size = 20, face = "bold"),
      axis.text = element_text(face = "bold", size = 18),
      panel.background = element_blank(),
      axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
      legend.text = element_text(size = 16),
      legend.title = element_text(size = 18),
      legend.position = "right", legend.box = "vertical"
    ) +
    labs(shape="Individual")  # Label the x and y axes
```


<!--chapter:end:04_Community.Rmd-->

# Inline Annotated R Markdown: 05_Differential_abundance_Inline_Annotated

## Code Chunk 1
```{r}
load("data/data.Rdata")  # Load an RData file with variables and datasets
```

## Code Chunk 2
```{r}
# phyloseq object considering structual zeros
phylo_samples <- sample_metadata %>%
  column_to_rownames("sample") %>%
  sample_data() # convert to phyloseq sample_data object

phylo_genome <- genome_counts_filt %>%
  column_to_rownames("genome") %>%
  mutate_all(~ replace(., . == 0, 0.00001)) %>% # add pseudo counts to avoid structural zero issues (note this approach can be improved!) %>%
  mutate_all(~./sum(.)) %>% #apply TSS nornalisation
  otu_table(., taxa_are_rows = TRUE)

phylo_taxonomy <- genome_metadata %>%
  filter(genome %in% rownames(phylo_genome)) %>% # remove structural zeros  # Filter the data to include only rows that meet certain conditions
  mutate(genome2 = genome) %>% # create a pseudo genome name column  # Add or modify columns in the dataset
  column_to_rownames("genome2") %>%
  dplyr::select(domain, phylum, class, order, family, genus, species, genome) %>% # add an additional taxonomic level to ensure genome-level analysis (as no all genomes have species-level taxonomic assignments. Otherwise, ANCOMBC2 aggregates analyses per species)  # Select specific columns from the data
  as.matrix() %>%
  tax_table() # convert to phyloseq tax_table object

phyloseq <- phyloseq(phylo_genome, phylo_taxonomy, phylo_samples)
```

## Code Chunk 3
```{r}
differential_abundance <- ancombc2(
  data = phyloseq,
  assay_name = "counts",
  tax_level = NULL, # change to agglomerate analysis to a higher taxonomic range
  fix_formula = "type", # fixed variable(s)
  rand_formula = "(1|individual)",
  p_adj_method = "holm",
  pseudo_sens = TRUE,
  prv_cut = 0,
  lib_cut = 0,
  s0_perc = 0.05,
  group = NULL,
  struc_zero = FALSE,
  neg_lb = FALSE,
  alpha = 0.05,
  n_cl = 2,
  verbose = TRUE,
  global = FALSE,
  pairwise = FALSE,
  dunnet = FALSE,
  trend = FALSE,
  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
  em_control = list(tol = 1e-5, max_iter = 100),
  lme_control = lme4::lmerControl(),
  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100),
  trend_control = NULL
)

# Save differential abundance to data object

save(sample_metadata, 
     genome_metadata, 
     read_counts, 
     genome_counts, 
     genome_counts_filt, 
     genome_tree,
     genome_gifts, 
     phylum_colors,
     data_stats,
     differential_abundance,
     file = "resources/data.Rdata")
```

## Code Chunk 4
```{r}
tax <- data.frame(phyloseq@tax_table) %>%
  rownames_to_column(., "taxon")

differential_abundance_table <- differential_abundance$res %>%
  dplyr::select(genome=taxon, lfc_typefeces, p_typefeces) %>%  # Select specific columns from the data
  filter(p_typefeces < 0.05) %>%  # Filter the data to include only rows that meet certain conditions
  dplyr::arrange(p_typefeces) %>%
  merge(., tax, by = "genome")

differential_abundance_table %>%
  select(genome,order,phylum, lfc_typefeces, p_typefeces) %>%  # Select specific columns from the data
  tt()
```

## Code Chunk 5
```{r}
ggplot(differential_abundance_table, aes(x = forcats::fct_rev(genome), y = lfc_typefeces, color = phylum)) +  # Begin plotting using ggplot2
  geom_point(size = 3) +  # Add a specific type of plot layer (bars, points, lines, etc.)
  scale_color_manual(values = phylum_colors[-c(3,4)]) +  # Adjust color scales, axes, or fill options
  geom_hline(yintercept = 0) +  # Add a specific type of plot layer (bars, points, lines, etc.)
  coord_flip() +
  facet_grid(phylum ~ ., scales = "free", space = "free") +  # Create multiple subplots based on a variable
  theme(  # Customize visual aspects of the plot
    panel.background = element_blank(),
    axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
    axis.title.x = element_blank(),
    strip.background = element_blank(), 
    strip.text = element_blank()
  ) +
  xlab("Genome") +
  ylab("log2FoldChange") +
  guides(col = guide_legend("Phylum"))
```

## Code Chunk 6
```{r}
differential_abundance$res %>%
  na.omit() %>%
  dplyr::select(genome=taxon, lfc_typefeces, p_typefeces) %>%  # Select specific columns from the data
  left_join(genome_metadata, by = join_by(genome == genome)) %>%  # Merge two datasets, keeping all rows from the left one
  mutate(phylum = ifelse(p_typefeces < 0.05, phylum, NA)) %>%  # Add or modify columns in the dataset
  ggplot(., aes(x = lfc_typefeces, y = -log(p_typefeces), color = phylum)) +  # Begin plotting using ggplot2
  geom_point() +  # Add a specific type of plot layer (bars, points, lines, etc.)
  #xlim(c(-10,4)) +
  scale_color_manual(values = phylum_colors[-c(3,4)]) +  # Adjust color scales, axes, or fill options
  labs(color = "Significance", x = "Log-fold difference between sample types", y = "p-value") +  # Customize axis labels or plot titles
  theme_classic()
```

## Code Chunk 7
```{r}
differential_abundance_genus <- ancombc2(
  data = phyloseq,
  assay_name = "counts",
  tax_level = "genus", # change to agglomerate analysis to a higher taxonomic range
  fix_formula = "type", # fixed variable(s)
  rand_formula = "(1|individual)",
  p_adj_method = "holm",
  pseudo_sens = TRUE,
  prv_cut = 0,
  lib_cut = 0,
  s0_perc = 0.05,
  group = NULL,
  struc_zero = FALSE,
  neg_lb = FALSE,
  alpha = 0.05,
  n_cl = 2,
  verbose = TRUE,
  global = FALSE,
  pairwise = FALSE,
  dunnet = FALSE,
  trend = FALSE,
  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
  em_control = list(tol = 1e-5, max_iter = 100),
  lme_control = lme4::lmerControl(),
  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100),
  trend_control = NULL
)

# Save differential abundance to data object

save(sample_metadata, 
     genome_metadata, 
     read_counts, 
     genome_counts, 
     genome_counts_filt, 
     genome_tree,
     genome_gifts, 
     phylum_colors,
     data_stats,
     differential_abundance,
     differential_abundance_genus,
     file = "resources/data.Rdata")
```

## Code Chunk 8
```{r}
tax <- data.frame(phyloseq@tax_table) %>%
  rownames_to_column(., "taxon")

differential_abundance_genus$res %>%
  filter(nchar(taxon) > 5) %>%  # Filter the data to include only rows that meet certain conditions
  dplyr::select(taxon=taxon, lfc_typefeces, p_typefeces) %>%  # Select specific columns from the data
  filter(p_typefeces < 0.05) %>%  # Filter the data to include only rows that meet certain conditions
  dplyr::arrange(lfc_typefeces) %>%
  left_join(tax %>% select(-c(taxon,genome,species)) %>% unique(), by = join_by(taxon==genus)) %>%  # Select specific columns from the data
  tt()
```

## Code Chunk 9
```{r}
differential_abundance_phylum <- ancombc2(
  data = phyloseq,
  assay_name = "counts",
  tax_level = "phylum", # change to agglomerate analysis to a higher taxonomic range
  fix_formula = "type", # fixed variable(s)
  rand_formula = "(1|individual)",
  p_adj_method = "holm",
  pseudo_sens = TRUE,
  prv_cut = 0,
  lib_cut = 0,
  s0_perc = 0.05,
  group = NULL,
  struc_zero = FALSE,
  neg_lb = FALSE,
  alpha = 0.05,
  n_cl = 2,
  verbose = TRUE,
  global = FALSE,
  pairwise = FALSE,
  dunnet = FALSE,
  trend = FALSE,
  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
  em_control = list(tol = 1e-5, max_iter = 100),
  lme_control = lme4::lmerControl(),
  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100),
  trend_control = NULL
)

# Save differential abundance to data object
save(sample_metadata, 
     genome_metadata, 
     read_counts, 
     genome_counts, 
     genome_counts_filt, 
     genome_tree,
     genome_gifts, 
     phylum_colors,
     data_stats,
     differential_abundance,
     differential_abundance_genus,
     differential_abundance_phylum,
     file = "resources/data.Rdata")
```

## Code Chunk 10
```{r}
differential_abundance_phylum_table <- differential_abundance_phylum$res %>%
  dplyr::select(taxon=taxon, lfc_typefeces, p_typefeces) %>%  # Select specific columns from the data
  #filter(p_typefeces < 0.05) %>%  # Filter the data to include only rows that meet certain conditions
  dplyr::arrange(lfc_typefeces)


phylum_colors2 <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
    left_join(differential_abundance_phylum_table, by=join_by(phylum == taxon)) %>%  # Merge two datasets, keeping all rows from the left one
    arrange(match(phylum, differential_abundance_phylum_table$taxon)) %>%
    select(phylum, colors) %>%   # Select specific columns from the data
    unique() %>%
    select(colors) %>%  # Select specific columns from the data
    pull()

differential_abundance_phylum_table %>%
  filter(p_typefeces < 0.05) %>%  # Filter the data to include only rows that meet certain conditions
  dplyr::arrange(lfc_typefeces) %>%
  tt()
```

## Code Chunk 11
```{r}
differential_abundance_phylum_table %>%
      mutate(taxon=factor(taxon,levels=differential_abundance_phylum_table$taxon)) %>%  # Add or modify columns in the dataset
      ggplot(aes(x = lfc_typefeces, y = forcats::fct_rev(taxon), fill = taxon)) +  # Begin plotting using ggplot2
        geom_col(size = 2) +  # Add a specific type of plot layer (bars, points, lines, etc.)
        scale_fill_manual(values = phylum_colors2) +  # Adjust color scales, axes, or fill options
        geom_hline(yintercept = 0) +  # Add a specific type of plot layer (bars, points, lines, etc.)
        geom_vline(xintercept = 4, linetype="dashed", color = "grey", size=1) +  # Add a specific type of plot layer (bars, points, lines, etc.)
        geom_vline(xintercept = -4, linetype="dashed", color = "grey", size=1) +  # Add a specific type of plot layer (bars, points, lines, etc.)
        theme(  # Customize visual aspects of the plot
          panel.background = element_blank(),
          axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
          axis.title.x = element_blank(),
          strip.background = element_blank(), 
          strip.text = element_blank()
        ) +
        labs(x="log2FoldChange", y="Phylum")  # Customize axis labels or plot titles
```


<!--chapter:end:05_Differential_abundance.Rmd-->

# Inline Annotated R Markdown: 06_Functional_diffrences_Inline_Annotated

## Code Chunk 1
```{r}
load("resources/data.Rdata")  # Load an RData file with variables and datasets
```

## Code Chunk 2
```{r}
# Aggregate bundle-level GIFTs into the compound level
GIFTs_elements <- to.elements(genome_gifts, GIFT_db)
GIFTs_elements_filtered <- GIFTs_elements[rownames(GIFTs_elements) %in% genome_counts$genome, ]
GIFTs_elements_filtered <- as.data.frame(GIFTs_elements_filtered) %>%
  select_if(~ !is.numeric(.) || sum(.) != 0)

elements <- GIFTs_elements_filtered %>%
  as.data.frame()

# Aggregate element-level GIFTs into the function level
GIFTs_functions <- to.functions(GIFTs_elements_filtered, GIFT_db)
functions <- GIFTs_functions %>%
  as.data.frame()

# Aggregate function-level GIFTs into overall Biosynthesis, Degradation and Structural GIFTs
GIFTs_domains <- to.domains(GIFTs_functions, GIFT_db)
domains <- GIFTs_domains %>%
  as.data.frame()

# Get community-weighed average GIFTs per sample
GIFTs_elements_community <- to.community(GIFTs_elements_filtered, genome_counts_filt %>% column_to_rownames(., "genome") %>% tss(), GIFT_db)
GIFTs_functions_community <- to.community(GIFTs_functions, genome_counts_filt %>% column_to_rownames(., "genome") %>% tss(), GIFT_db)
GIFTs_domains_community <- to.community(GIFTs_domains, genome_counts_filt %>% column_to_rownames(., "genome") %>% tss(), GIFT_db)
```

## Code Chunk 3
```{r}
GIFTs_functions_community %>%
    as.data.frame() %>%
    rownames_to_column(var="sample") %>%
    pivot_longer(!sample,names_to="trait",values_to="gift") %>%
    left_join(sample_metadata, by = join_by(sample == sample)) %>%  # Merge two datasets, keeping all rows from the left one
    ggplot(aes(x=trait,y=sample,fill=gift)) +  # Begin plotting using ggplot2
        geom_tile(colour="white", size=0.2)+  # Add a specific type of plot layer (bars, points, lines, etc.)
        scale_fill_gradientn(colours=rev(c("#d53e4f", "#f46d43", "#fdae61", "#fee08b", "#e6f598", "#abdda4", "#ddf1da")))+  # Adjust color scales, axes, or fill options
        facet_grid(type ~ ., scales="free",space="free")  # Create multiple subplots based on a variable
```

## Code Chunk 4
```{r}
GIFTs_functions_community_tt <- GIFTs_functions_community %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  separate(sample, into = c("individual", "type"), sep = "\\.") %>%
  pivot_longer(-c(individual, type), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%  # Group the data by one or more variables
  mutate(model_result = list(lmerTest::lmer(value ~ type + (1 | individual)))) %>%  # Add or modify columns in the dataset
  ungroup() %>%
  select(trait,model_result) %>%  # Select specific columns from the data
  unique() %>%
  mutate(estimate = map_dbl(model_result, ~broom.mixed::tidy(.) %>% filter(term == "typefeces") %>% pull(estimate))) %>%  # Filter the data to include only rows that meet certain conditions

  mutate(p_value = map_dbl(model_result, ~broom.mixed::tidy(.) %>% filter(term == "typefeces") %>% pull(p.value))) %>%  # Filter the data to include only rows that meet certain conditions
  mutate(p_value_adj = p.adjust(p_value, method = "bonferroni")) %>%  # Add or modify columns in the dataset
  left_join(GIFT_db %>% select(Code_function,Function) %>% unique(),by=join_by(trait==Code_function)) %>%  # Select specific columns from the data
  rename(id=trait,trait=Function) %>%
  select(id,trait, estimate, p_value_adj)  # Select specific columns from the data

GIFTs_functions_community_tt %>% tt() |> 
      style_tt(
        i = which(GIFTs_functions_community_tt$estimate < 0 & GIFTs_functions_community_tt$p_value_adj < 0.05),
        background = "#E5D5B1") |> 
      style_tt(
        i = which(GIFTs_functions_community_tt$estimate > 0 & GIFTs_functions_community_tt$p_value_adj < 0.05),
        background = "#B7BCCE")
```

## Code Chunk 5
```{r}
GIFTs_functions_community %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  separate(sample, into = c("individual", "type"), sep = "\\.") %>%
  pivot_longer(-c(individual, type), names_to = "trait", values_to = "value") %>%
  mutate(trait = case_when(  # Add or modify columns in the dataset
      trait %in% GIFT_db$Code_function ~ GIFT_db$Function[match(trait, GIFT_db$Code_function)],
      TRUE ~ trait
    )) %>%
  mutate(trait=factor(trait,levels=unique(GIFT_db$Function))) %>%  # Add or modify columns in the dataset
  ggplot(aes(x=value, y=type, group=type, fill=type, color=type)) +  # Begin plotting using ggplot2
    geom_boxplot() +  # Add a specific type of plot layer (bars, points, lines, etc.)
    scale_color_manual(name="Sample type",  # Adjust color scales, axes, or fill options
          breaks=c("cloaca","feces"),
          labels=c("Cloaca","Faeces"),
          values=c("#e5bd5b", "#6b7398")) +
      scale_fill_manual(name="Sample type",  # Adjust color scales, axes, or fill options
          breaks=c("cloaca","feces"),
          labels=c("Cloaca","Faeces"),
          values=c("#e5bd5b50", "#6b739850")) +
    facet_grid(trait ~ ., space="free", scales="free") +  # Create multiple subplots based on a variable
              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),  # Customize visual aspects of the plot
              strip.text.y = element_text(angle = 0)) + 
        labs(y="Traits",x="Metabolic capacity index")  # Customize axis labels or plot titles
```

## Code Chunk 6
```{r}
GIFTs_elements_community %>%
    as.data.frame() %>%
    rownames_to_column(var="sample") %>%
    pivot_longer(!sample,names_to="trait",values_to="gift") %>%
    left_join(sample_metadata, by = join_by(sample == sample)) %>%  # Merge two datasets, keeping all rows from the left one
    mutate(functionid = substr(trait, 1, 3)) %>%  # Add or modify columns in the dataset
    mutate(trait = case_when(  # Add or modify columns in the dataset
      trait %in% GIFT_db$Code_element ~ GIFT_db$Element[match(trait, GIFT_db$Code_element)],
      TRUE ~ trait
    )) %>%
    mutate(functionid = case_when(  # Add or modify columns in the dataset
      functionid %in% GIFT_db$Code_function ~ GIFT_db$Function[match(functionid, GIFT_db$Code_function)],
      TRUE ~ functionid
    )) %>%
    mutate(trait=factor(trait,levels=unique(GIFT_db$Element))) %>%  # Add or modify columns in the dataset
    mutate(functionid=factor(functionid,levels=unique(GIFT_db$Function))) %>%  # Add or modify columns in the dataset
    ggplot(aes(x=sample,y=trait,fill=gift)) +  # Begin plotting using ggplot2
        geom_tile(colour="white", linewidth=0.2)+  # Add a specific type of plot layer (bars, points, lines, etc.)
        scale_fill_gradientn(colours=rev(c("#d53e4f", "#f46d43", "#fdae61", "#fee08b", "#e6f598", "#abdda4", "#ddf1da")))+  # Adjust color scales, axes, or fill options
        facet_grid(functionid ~ type, scales="free",space="free") +  # Create multiple subplots based on a variable
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),  # Customize visual aspects of the plot
              strip.text.y = element_text(angle = 0)) + 
        labs(y="Traits",x="Samples",fill="GIFT")  # Customize axis labels or plot titles
```

## Code Chunk 7
```{r}
GIFTs_elements_community_tt <- GIFTs_elements_community %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  separate(sample, into = c("individual", "type"), sep = "\\.") %>%
  pivot_longer(-c(individual, type), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%  # Group the data by one or more variables
  mutate(model_result = list(lmerTest::lmer(value ~ type + (1 | individual)))) %>%  # Add or modify columns in the dataset
  ungroup() %>%
  select(trait,model_result) %>%  # Select specific columns from the data
  unique() %>%
  mutate(estimate = map_dbl(model_result, ~broom.mixed::tidy(.) %>% filter(term == "typefeces") %>% pull(estimate))) %>%  # Filter the data to include only rows that meet certain conditions
  mutate(p_value = map_dbl(model_result, ~broom.mixed::tidy(.) %>% filter(term == "typefeces") %>% pull(p.value))) %>%  # Filter the data to include only rows that meet certain conditions
  mutate(p_value_adj = p.adjust(p_value, method = "bonferroni")) %>%  # Add or modify columns in the dataset
  left_join(GIFT_db %>% select(Code_element,Element) %>% unique(),by=join_by(trait==Code_element)) %>%  # Select specific columns from the data
  rename(id=trait,trait=Element) %>%
  select(id,trait, estimate, p_value_adj)  # Select specific columns from the data

GIFTs_elements_community_tt %>% tt() |> 
      style_tt(
        i = which(GIFTs_elements_community_tt$estimate < 0 & GIFTs_elements_community_tt$p_value_adj < 0.05),
        background = "#E5D5B1") |> 
      style_tt(
        i = which(GIFTs_elements_community_tt$estimate > 0 & GIFTs_elements_community_tt$p_value_adj < 0.05),
        background = "#B7BCCE")
```


<!--chapter:end:06_Functional_diffrences.Rmd-->

