---
title: "AlberdiLab | Fix et al 2025"
subtitle: "Brush-tail possum metagenomics"
author:
  - Lukas Fix, Antton Alberdi, Raphael Eisenhofer 
date: "Last update: `r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
bibliography: [book.bib, packages.bib]
url: https://alberdilab.github.io/calotriton_metagenomics
description: |
  Data analysis code for the study on the gut microbiomes of brushtail possums in tasmania.
link-citations: yes
github-repo: https://github.com/alberdilab/btp_metagenomics.git
---

## Libaries 
```{r}
# Base
library(R.utils)
library(knitr)
library(tidyverse)
library(devtools)
library(tinytable)
library(rairtable)
library(readxl)

# For tree handling
library(ape)
library(phyloseq)
library(phytools)

# For plotting
library(ggplot2)  # Begin plotting using ggplot2
library(ggrepel)
library(ggpubr)
library(ggnewscale)
library(gridExtra)
library(ggtreeExtra)
library(ggtree)
library(ggh4x)
library(GGally)

# For statistics
library(spaa)
library(vegan)
library(Rtsne)
library(geiger)
library(hilldiv2)
library(distillR)
library(broom.mixed)
library(emmeans)
library(vegan)
#library(lmerTest)
library(Hmsc)
library(corrplot)
library(lme4)
library(nlme)
library(ANCOMBC)

#map visualtisation
library(rnaturalearth)
library(rnaturalearthdata)
library(patchwork)
```


<!--chapter:end:index.Rmd-->


## Load data

Load the original data files outputted by the bioinformatic pipeline.

### Sample metadata

```{r load_sample_metadata, warning=FALSE, comments="", message=FALSE, eval=FALSE}
sample_metadata <- read_tsv("data/merged_metadata.tsv") %>%
    rename(sample=1)
```

## load_read_counts
```{r load_read_counts, warning=FALSE, comments="", message=FALSE}
read_counts <- read_tsv("data/DMB0167_counts.tsv.gz") %>%
    rename(genome=1) %>% 
    select(one_of(c("genome",sample_metadata$sample)))  # Select specific columns from the data
```

## load_genome_metadata
```{r load_genome_metadata, warning=FALSE, comments="", message=FALSE}
genome_metadata <- read_tsv("data/DMB0167_mag_info.tsv.gz") %>%
    rename(length=mag_size)%>%
  semi_join(., read_counts, by = "genome") %>% 
  arrange(match(genome,read_counts$genome))
```

##  Genome base hits
```{r load_genome_hits, warning=FALSE, comments="", message=FALSE}
genome_coverage <- read_tsv("data/DMB0167_coverage.tsv.gz") %>%
    rename(genome=1) %>% 
    select(one_of(c("genome",sample_metadata$sample)))%>%   # Select specific columns from the data
  semi_join(., genome_metadata, by = "genome")%>%
  arrange(match(genome, read_counts$genome))
```

## Genome tree
```{r load_genome_tree, warning=FALSE, comments="", message=FALSE}
genome_tree <- read_tree("data/DMB0167.tree.gz")
genome_tree$tip.label <- str_replace_all(genome_tree$tip.label,"'", "") #remove single quotes in MAG names
genome_tree <- keep.tip(genome_tree, tip=genome_metadata$genome) # keep only MAG tips
```

## Genome annotations
Downloading individual annotation files from ERDA using information in Airtable and writing them to a single compressed table takes a while. The following chunk only needs to be run once, to generate the ***genome_annotations*** table that is saved in the data directory. Note that the airtable connection requires a personal access token.

```{r download_genome_annotations, warning=FALSE, comments="", message=FALSE, eval=FALSE}
airtable("MAGs", "appWbHBNLE6iAsMRV") %>% #get base ID from Airtable browser URL
  read_airtable(., fields = c("ID","mag_name","number_genes","anno_url"), id_to_col = TRUE) %>% #get 3 columns from MAGs table
  filter(mag_name %in% paste0(genome_metadata$genome,".fa")) %>% #filter by MAG name
  filter(number_genes > 0) %>% #genes need to exist
  select(anno_url) %>% #list MAG annotation urls
  pull() %>%
  read_tsv() %>% #load all tables
  rename(gene=1, genome=2, contig=3) %>% #rename first 3 columns
  write_tsv(file="data/genome_annotations.tsv.xz") #write to overall compressed file
```


```{r load_genome_annotations, warning=FALSE, comments="", message=FALSE}
genome_annotations <- read_tsv("data/genome_annotations.tsv.xz") %>%
    rename(gene=1, genome=2, contig=3)
```

## Filter reads by coverage
```{r filter_coverage, warning=FALSE, comments="", message=FALSE}
min_coverage=0.3
read_counts_filt <- genome_coverage %>%
  mutate(across(where(is.numeric), ~ ifelse(. > min_coverage, 1, 0))) %>%  # Add or modify columns in the dataset
  mutate(across(-1, ~ . * read_counts[[cur_column()]]))  # Add or modify columns in the dataset
```

## Transform reads into genome counts
```{r calculate_genome_counts_unfiltered, warning=FALSE, comments="", message=FALSE}
readlength=150
genome_counts <- read_counts %>%
  mutate(across(where(is.numeric), ~ . / (genome_metadata$length / readlength) ))  # Add or modify columns in the dataset
```

```{r calculate_genome_counts_filtered_gut, warning=FALSE, comments="", message=FALSE}
readlength=150
genome_counts_filt <- read_counts_filt %>%
  mutate(across(where(is.numeric), ~ . / (genome_metadata$length / readlength) ))  # Add or modify columns in the dataset
```

### Distill annotations into GIFTs 

```{r distill_annotations, warning=FALSE, comments="", message=FALSE, eval=FALSE}
 genome_gifts <- distill(genome_annotations,GIFT_db,genomecol=2,annotcol=c(9,10,19), verbosity=F)
```


## Prepare color scheme
```{r get_ehi_colors, warning=FALSE, comments="", message=FALSE}
phylum_colors <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
    right_join(genome_metadata, by=join_by(phylum == phylum)) %>%
    arrange(match(genome, genome_tree$tip.label)) %>%
    select(phylum, colors) %>%
    unique() %>%
    arrange(phylum) %>%
    pull(colors, name=phylum)
```

## Wrap working objects

All working objects are wrapped into a single Rdata object to facilitate downstream usage.

```{r wrap_working_objects, warning=FALSE, comments="", message=FALSE}
save(sample_metadata,
     genome_metadata,
     read_counts,
     genome_counts,
     genome_counts_filt,
     genome_tree,
     genome_gifts,
     phylum_colors,
     file = "data/data.Rdata")
```


<!--chapter:end:01_prepare_data.Rmd-->

# Data statistics

```{r load_data_stats}
load("data/data.Rdata")
```

#Visualisation of geographical location of samples and their respectiv envirotypes

## Filter Data

```{r filter_data}
# Define extended boundary to include all possum data points
lat_min <- -45.0  # Slightly smaller than -42.93
lat_max <- -28.0  # Slightly larger than -30.65
lon_min <- 110.0  # Slightly smaller than 116.47
lon_max <- 150.0  # Slightly larger than 148.28

# Full dataset with all points (Tasmania & Australia border)
full_possums <- sample_metadata %>%
  filter(latitude >= lat_min & latitude <= lat_max, 
         longitude >= lon_min & longitude <= lon_max)

# Filter for Tasmania only
tasmania_possums <- full_possums %>%
  filter(latitude < -38 & latitude > -45,  # Tasmania lat range
         longitude > 140 & longitude < 150)  # Tasmania lon range

# Aggregate possum count per location
full_possums_count <- full_possums %>%
  group_by(latitude, longitude, broad_environment) %>%
  summarise(count = n(), .groups = "drop")

tasmania_possums_count <- tasmania_possums %>%
  group_by(latitude, longitude, broad_environment) %>%
  summarise(count = n(), .groups = "drop")
```

## Load Map

```{r load_map}
# Load world map
australia_map <- ne_countries(scale = "medium", returnclass = "sf") %>%
  filter(admin == "Australia")
```

## Plot Possum Locations

```{r plot_maps, warning=FALSE, message=FALSE}

# Get Tasmania data range to set zoom
lat_range <- range(tasmania_possums$latitude, na.rm = TRUE)
lon_range <- range(tasmania_possums$longitude, na.rm = TRUE)

# Count total possums
total_full <- sum(full_possums_count$count)
total_tasmania <- sum(tasmania_possums_count$count)

# Plot 1: Full Dataset (Including Border Data)
map_plot_full <- ggplot() +
  geom_sf(data = australia_map, fill = "lightgray", color = "black") +  # Base map
  geom_point(data = full_possums_count, aes(x = longitude, y = latitude, 
                                            color = broad_environment, size = count), 
             alpha = 0.8) +
  theme_minimal() + 
  labs(title = paste("PD - Full Dataset (", total_full, ")"),
       x = "Longitude", y = "Latitude", color = "Environment Type", size = "Count", shape = "species") +
  theme(legend.position = "none",
        plot.title = element_text(size = 14, face = "bold"))

# Plot 2: Zoomed-in Tasmania (with entire landmass and cleaned longitude labels)
map_plot_zoomed <- ggplot() +
  geom_sf(data = australia_map, fill = "lightgray", color = "black") +  # Base map
  geom_point(data = tasmania_possums_count, aes(x = longitude, y = latitude, 
                                                color = broad_environment, size = count), 
             alpha = 0.8) + 
  coord_sf(xlim = c(143, 149), ylim = c(-44, -39)) +  # Full Tasmania view
  theme_minimal() + 
  labs(title = paste("PD - Tasmania (", total_tasmania, ")"),
       x = "Longitude", y = "Latitude",
       color = "Environment Type", size = "Count", shape = "species" ) +
  theme(legend.position = "right", 
        axis.text.x = element_text(angle = 0, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold"))

# Combine the plots side by side with shared legend and increased size
(map_plot_full + map_plot_zoomed) + plot_layout(guides = "collect", widths = c(1, 1.2))
```
```{r filter_data2}
# Define extended boundary to include all possum data points
lat_min <- -45.0  # Slightly smaller than -42.93
lat_max <- -28.0  # Slightly larger than -30.65
lon_min <- 110.0  # Slightly smaller than 116.47
lon_max <- 150.0  # Slightly larger than 148.28

# Full dataset with all points (Tasmania & Australia border)
full_possums <- sample_metadata %>%
  filter(latitude >= lat_min & latitude <= lat_max, 
         longitude >= lon_min & longitude <= lon_max)

# Filter for Tasmania only
tasmania_possums <- full_possums %>%
  filter(latitude < -38 & latitude > -45,  # Tasmania lat range
         longitude > 140 & longitude < 150)  # Tasmania lon range

# Aggregate possum count per location
full_possums_count <- full_possums %>%
  group_by(latitude, longitude, local_environment) %>%
  summarise(count = n(), .groups = "drop")

tasmania_possums_count <- tasmania_possums %>%
  group_by(latitude, longitude, local_environment) %>%
  summarise(count = n(), .groups = "drop")
```

## Load Map

```{r load_map2}
# Load world map
australia_map <- ne_countries(scale = "medium", returnclass = "sf") %>%
  filter(admin == "Australia")
```

## Plot Possum Locations

```{r plot_maps2, warning=FALSE, message=FALSE}
library(RColorBrewer)

# Get Tasmania data range to set zoom
lat_range <- range(tasmania_possums$latitude, na.rm = TRUE)
lon_range <- range(tasmania_possums$longitude, na.rm = TRUE)

# Count total possums
total_full <- sum(full_possums_count$count)
total_tasmania <- sum(tasmania_possums_count$count)

# Plot 1: Full Dataset (Including Border Data)
map_plot_full <- ggplot() +
  geom_sf(data = australia_map, fill = "lightgray", color = "black") +
  geom_point(data = full_possums_count, aes(x = longitude, y = latitude,
                                            color = local_environment, size = count),
             alpha = 0.8) +
  scale_color_viridis_d(name = "Environment Type", option = "D") +
  theme_minimal() +
  labs(title = paste("PD - Full Dataset (", total_full, ")"),
       x = "Longitude", y = "Latitude") +
  theme(
    plot.title = element_text(size = 10, face = "bold"),
    legend.position = "none"
  )

# Plot 2: Zoomed-in Tasmania
map_plot_zoomed <- ggplot() +
  geom_sf(data = australia_map, fill = "lightgray", color = "black") +
  geom_point(data = tasmania_possums_count, aes(x = longitude, y = latitude,
                                                color = local_environment, size = count),
             alpha = 0.8) +
  coord_sf(xlim = c(143, 149), ylim = c(-44, -39)) +
  scale_color_viridis_d(name = "Environment Type", option = "D") +
  theme_minimal() +
  labs(title = paste("PD - Tasmania (", total_tasmania, ")"),
       x = "Longitude", y = "Latitude") +
  theme(
    plot.title = element_text(size = 10, face = "bold"),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    legend.position = "none"
  )

# Combine the plots side by side
(map_plot_full + map_plot_zoomed) +
  plot_layout(widths = c(1, 1.2))

```

```{r combined_legend, warning=FALSE, message=FALSE}

# Step 1: Create simplified/aggregated legend data
legend_data <- tasmania_possums_count %>%
  group_by(local_environment) %>%
  summarise(mean_count = mean(count, na.rm = TRUE)) %>%
  filter(!is.na(local_environment)) %>%
  arrange(desc(mean_count)) %>%
  mutate(env_label = paste0(local_environment))

# Step 2: Plot custom "legend" with clean layout
custom_legend_plot <- ggplot(legend_data, aes(x = 1, y = reorder(env_label, mean_count),
                                              color = env_label, size = mean_count)) +
  geom_point(show.legend = FALSE) +
  scale_size_continuous(range = c(3, 6)) +  # tweak dot size scaling
  scale_color_viridis_d(name = "Environment Type", option = "D") +
  theme_minimal() +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(10, 30, 10, 10),
    axis.text.y = element_text(size = 9, hjust = 0)
  )

# Show it
custom_legend_plot
```


## Sequencing reads statistics

```{r reads_stats2}
sample_metadata %>% 
    summarise(Total=sum(reads_post_fastp * 150 / 1000000000) %>% round(2), 
              mean=mean(reads_post_fastp * 150 / 1000000000) %>% round(2),
              sd=sd(reads_post_fastp * 150 / 1000000000) %>% round(2)) %>%
    unite("Average",mean, sd, sep = " ± ", remove = TRUE) %>%
    tt()
```

## DNA fractions
```{r dna_fractions_stats2}
sequence_fractions <- read_counts %>%
  pivot_longer(-genome, names_to = "sample", values_to = "value") %>%
  group_by(sample) %>%
  summarise(mags = sum(value)) %>%
	left_join(sample_metadata, by = join_by(sample == sample)) %>%
	select(sample,mags,metagenomic_bases,host_bases,bases_lost_fastp_percent) %>%
	mutate(mags_bases = mags*146) %>%
	mutate(lowqual_bases = ((metagenomic_bases+host_bases)/(1-bases_lost_fastp_percent))-(metagenomic_bases+host_bases)) %>%
	mutate(unmapped_bases = metagenomic_bases - mags_bases) %>%
	mutate(unmapped_bases = ifelse(unmapped_bases < 0, 0, unmapped_bases)) %>%
	select(sample, lowqual_bases, host_bases, unmapped_bases, mags_bases)

sequence_fractions %>%
  mutate_at(vars(-sample), ~./1000000000) %>%
  rename("Sample"=1, "Low quality"=2, "Mapped to host"=3, "Unmapped"=4, "Mapped to MAGs"=5) %>%
  tt()

sequence_fractions %>%
  mutate_at(vars(-sample), ~./1000000000) %>%
  rename("Sample"=1, "Low quality"=2, "Mapped to host"=3, "Unmapped"=4, "Mapped to MAGs"=5) %>%
  summarise(across(where(is.numeric), mean, na.rm = TRUE)) %>%
  tt()

```


```{r dna_fractions_plot, message=FALSE, warning=FALSE, fig.height=6, fig.width=10, fig.fullwidth=TRUE}
sequence_fractions %>%
	pivot_longer(!sample, names_to = "fraction", values_to = "value") %>%
	mutate(value = value / 1000000000) %>%
	mutate(fraction = factor(fraction, levels = c("lowqual_bases","host_bases","unmapped_bases","mags_bases"))) %>%
  
	ggplot(., aes(x = sample, y = value, fill=fraction)) +
	    geom_bar(position="stack", stat = "identity") +
      scale_fill_manual(name="Sequence type",
                    breaks=c("lowqual_bases","host_bases","unmapped_bases","mags_bases"),
                    labels=c("Low quality","Mapped to host","Unmapped","Mapped to MAGs"),
                    values=c("#CCCCCC", "#bcdee1", "#d8b8a3","#93655c"))+
	    labs(x = "Samples", y = "Amount of data (GB)") +
	    theme_classic() +
	    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size=6),legend.position = "bottom")
```

## Recovered microbial fraction

```{r data_estimations_plot1, message=FALSE, warning=FALSE, fig.height=6, fig.width=10, fig.fullwidth=TRUE}
singlem_table <- sequence_fractions %>%
	mutate(mags_proportion = round((mags_bases / (mags_bases + unmapped_bases))*100,2)) %>%
	left_join(sample_metadata, by = join_by(sample == sample))  %>%
	mutate(singlem_proportion = round(singlem_fraction,2)) %>%
	select(sample,mags_proportion,singlem_proportion) %>%
	mutate(mags_proportion = ifelse(singlem_proportion == 0, 0, mags_proportion)) %>% #convert zeros to NA
	mutate(singlem_proportion = ifelse(singlem_proportion == 0, NA, singlem_proportion)) %>% #convert zeros to NA
	mutate(singlem_proportion = ifelse(singlem_proportion < mags_proportion, NA, singlem_proportion)) %>% #if singlem is smaller, then NA, to simplify plot
	mutate(singlem_proportion = ifelse(singlem_proportion > 100, 100, singlem_proportion)) #simplify

singlem_table %>%
	pivot_longer(!sample, names_to = "proportion", values_to = "value") %>%
	mutate(proportion = factor(proportion, levels = c("mags_proportion","singlem_proportion"))) %>%
	ggplot(., aes(x = value, y = sample, color=proportion)) +
			geom_line(aes(group = sample), color = "#f8a538") +
			geom_point() +
      scale_color_manual(name="Proportion",
                    breaks=c("mags_proportion","singlem_proportion"),
                    labels=c("Recovered","Estimated"),
                    values=c("#52e1e8", "#876b53"))+
			theme_classic() +
			labs(y = "Samples", x = "Prokaryotic fraction (%)") +
	    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size=6),legend.position = "right")

```


  

<!--chapter:end:02_data_statistics.Rmd-->


# MAG catalogue

## Gut microbiota

```{r gut_load_data_mag}
load("data/data.Rdata")
```

### Genome phylogeny

```{r gut_genome_phylogeny, message=FALSE, warning=FALSE, fig.height=10, fig.width=10, fig.fullwidth=TRUE}

# Generate the phylum color heatmap
phylum_heatmap <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
    right_join(genome_metadata, by=join_by(phylum == phylum)) %>%
    arrange(match(genome, genome_tree$tip.label)) %>%

    select(genome,phylum) %>%
    mutate(phylum = factor(phylum, levels = unique(phylum))) %>%
    column_to_rownames(var = "genome")

# Generate new species table
newspecies_table <- genome_metadata %>%
  mutate(newspecies=ifelse(species=="s__","Y","N")) %>%
  select(genome,newspecies) %>%
  column_to_rownames(var = "genome")

# Generate  basal tree
circular_tree <- force.ultrametric(genome_tree, method="extend") %>% # extend to ultrametric for the sake of visualisation
    ggtree(., layout="fan", open.angle=10, size=0.5)


# Add phylum ring
# circular_tree <- gheatmap(circular_tree, phylum_heatmap, offset=0.55, width=0.1, colnames=FALSE) +
#         scale_fill_manual(values=phylum_colors) +
#         geom_tiplab2(size=1, hjust=-0.1) +
#         theme(legend.position = "none", plot.margin = margin(0, 0, 0, 0), panel.margin = margin(0, 0, 0, 0))
circular_tree <- gheatmap(circular_tree, phylum_heatmap, offset=0.05, width=0.05, colnames=FALSE) +
        scale_fill_manual(values=phylum_colors) +
  labs(fill="Phylum")
        #theme(legend.position = "none", plot.margin = margin(0, 0, 0, 0), panel.margin = margin(0, 0, 0, 0))

# Flush color scale to enable a new color scheme in the next ring
circular_tree <- circular_tree + new_scale_fill()

# Add completeness ring
circular_tree <- circular_tree +
        new_scale_fill() +
        scale_fill_gradient(low = "#d1f4ba", high = "#f4baba") +
        geom_fruit(
                data=genome_metadata,
                geom=geom_bar,
                mapping = aes(x=completeness, y=genome, fill=contamination),
                offset = 0.24,
                pwidth = 0.1,
                orientation="y",
              stat="identity")+
  labs(fill="Contamination")

# Add genome-size ring
circular_tree <-  circular_tree + new_scale_fill()

circular_tree <- gheatmap(circular_tree, newspecies_table, offset=0.3, width=0.05, colnames=FALSE) +
  scale_fill_manual(values=c("#f4f4f4","#74C8AE"))+
  labs(fill="New species")
        #theme(legend.position = "none", plot.margin = margin(0, 0, 0, 0), panel.margin = margin(0, 0, 0, 0))


circular_tree <-  circular_tree +
  geom_fruit(
    data=genome_metadata,
    geom=geom_bar,
    mapping = aes(x=length, y=genome),
    fill = "#1e6e55",
    offset = 0.05,
    orientation="y",
    stat="identity")


# Add text
circular_tree <-  circular_tree +
        annotate('text', x=3.1, y=0, label='            Phylum', family='arial', size=3.5) +
        annotate('text', x=3.7, y=0, label='                         Genome quality', family='arial', size=3.5) +
        annotate('text', x=4.1, y=0, label='                     Genome size', family='arial', size=3.5) +
        annotate('text', x=3.4, y=0, label='                     New species', family='arial', size=3.5)

#Plot circular tree
circular_tree %>% open_tree(30) %>% rotate_tree(90)
```

### Taxonomy overview

```{r genome_taxonomy_bacteria}
tax_mag <-genome_metadata %>%
  group_by(phylum) %>%
  summarise(mag_n=n())

tax_mag %>%
  mutate(percetage_mag=round(mag_n*100/sum(mag_n), 2)) %>%
  arrange(-percetage_mag) %>%
  tt()
```

### Mag size (MB)
```{r}
genome_metadata <-genome_metadata %>%
  mutate(corrected_size=100*length/completeness) %>%
  arrange(completeness)
```

Mags average size (MB)
```{r mag_size_all_mean, message=FALSE, warning=FALSE}
genome_metadata %>%
  summarise(Average_corrected_size=mean(corrected_size))
```

### Genome quality

```{r gut_genome_quality}
genome_metadata %>%
    summarise(completeness_mean=mean(completeness) %>% round(2) %>% as.character(),
              completeness_sd=sd(completeness) %>% round(2) %>% as.character(),
              contamination_mean=mean(contamination) %>% round(2),
              contamination_sd=sd(contamination) %>% round(2)) %>%
    unite("Completeness",completeness_mean, completeness_sd, sep = " ± ", remove = TRUE) %>%
    unite("Contamination",contamination_mean, contamination_sd, sep = " ± ", remove = TRUE) %>%
    tt()
```

```{r gut_genome_quality_plot, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}

#Generate quality biplot
genome_biplot <- genome_metadata %>%
  select(c(genome,domain,phylum,completeness,contamination,length)) %>%
  arrange(match(genome, rev(genome_tree$tip.label))) %>% #sort MAGs according to phylogenetic tree
  ggplot(aes(x=completeness,y=contamination,size=length,color=phylum)) +
              geom_point(alpha=0.7) +
                    ylim(c(10,0)) +
                    scale_color_manual(values=phylum_colors) +
                    labs(y= "Contamination", x = "Completeness") +
                    theme_classic() +
                    theme(legend.position = "none")

#Generate contamination boxplot
genome_contamination <- genome_metadata %>%
            ggplot(aes(y=contamination)) +
                    ylim(c(10,0)) +
                    geom_boxplot(colour = "#999999", fill="#cccccc") +
                    theme_void() +
                    theme(legend.position = "none",
                        axis.title.x = element_blank(),
                        axis.title.y = element_blank(),
                        axis.text.y=element_blank(),
                        axis.ticks.y=element_blank(),
                        axis.text.x=element_blank(),
                        axis.ticks.x=element_blank(),
                        plot.margin = unit(c(0, 0, 0.40, 0),"inches")) #add bottom-margin (top, right, bottom, left)

#Generate completeness boxplot
genome_completeness <- genome_metadata %>%
        ggplot(aes(x=completeness)) +
                xlim(c(50,100)) +
                geom_boxplot(colour = "#999999", fill="#cccccc") +
                theme_void() +
                theme(legend.position = "none",
                    axis.title.x = element_blank(),
                    axis.title.y = element_blank(),
                    axis.text.y=element_blank(),
                    axis.ticks.y=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank(),
                    plot.margin = unit(c(0, 0, 0, 0.50),"inches")) #add left-margin (top, right, bottom, left)

#Render composite figure
grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination),
        layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3)))

```

### Functional overview

***Predicted genes***
```{r predicted_stats_gut, message=FALSE, warning=FALSE}
genome_annotations <- read_tsv("data/genome_annotations.tsv.xz") %>%
    rename(gene=1, genome=2, contig=3)

# Predicted genes
pred_genes <- genome_annotations %>%
  nrow()

cat(pred_genes)
```

***Number of annotated genes and percentages***
```{r annotation_stats, message=FALSE, warning=FALSE, fig.height=10, fig.width=10, fig.fullwidth=TRUE, eval = FALSE}

# Some annotation
genome_annota <- genome_annotations %>%
  filter(if_any(c(kegg_id, pfam_hits, cazy_hits), ~ !is.na(.))) %>%
  nrow()

cat(genome_annota)

# Some annotation percentage
genome_annota*100/pred_genes
```

***Number of KEGG annotatated genes and percentages***
```{r kegg_stats, message=FALSE, warning=FALSE, fig.height=10, fig.width=10, fig.fullwidth=TRUE, eval = FALSE}
# KEGG annotation
kegg_annota <- genome_annotations %>%
  filter(!is.na(kegg_id)) %>%
  nrow()
cat(kegg_annota)

# KEGG annotation percentage
kegg_annota*100/genome_annota
```

```{r function_heatmap, message=FALSE, warning=FALSE, fig.height=10, fig.width=10, fig.fullwidth=TRUE}

# Aggregate basal GIFT into elements
function_table <- genome_gifts %>%
    to.elements(., GIFT_db)

# Generate  basal tree
function_tree <- force.ultrametric(genome_tree, method="extend") %>%
                ggtree(., size = 0.3)

#Add phylum colors next to the tree tips
function_tree <- gheatmap(function_tree, phylum_heatmap, offset=0, width=0.1, colnames=FALSE) +
            scale_fill_manual(values=phylum_colors) +
            labs(fill="Phylum")

#Reset fill scale to use a different colour profile in the heatmap
function_tree <- function_tree + new_scale_fill()

#Add functions heatmap
function_tree <- gheatmap(function_tree, function_table, offset=0.5, width=3.5, colnames=FALSE) +
            vexpand(.08) +
            coord_cartesian(clip = "off") +
            scale_fill_gradient(low = "#f4f4f4", high = "steelblue", na.value="white") +
            labs(fill="GIFT")

#Reset fill scale to use a different colour profile in the heatmap
function_tree <- function_tree + new_scale_fill()

# Add completeness barplots
function_tree <- function_tree +
            geom_fruit(data=genome_metadata,
            geom=geom_bar,
            grid.params=list(axis="x", text.size=2, nbreak = 1),
            axis.params=list(vline=TRUE),
            mapping = aes(x=length, y=genome, fill=completeness),
                 offset = 3.8,
                 orientation="y",
                 stat="identity") +
            scale_fill_gradient(low = "#cf8888", high = "#a2cc87") +
            labs(fill="Genome\ncompleteness")

function_tree
```

### Functional ordination

```{r function_ordination, message=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
# Generate the tSNE ordination
tSNE_function <- Rtsne(X=function_table, dims = 2, check_duplicates = FALSE)

# Plot the ordination
function_ordination <- tSNE_function$Y %>%
                as.data.frame() %>%
                mutate(genome=rownames(function_table)) %>%
                inner_join(genome_metadata, by="genome") %>%
                rename(tSNE1="V1", tSNE2="V2") %>%
                select(genome,phylum,tSNE1,tSNE2, length) %>%
                ggplot(aes(x = tSNE1, y = tSNE2, color = phylum, size=length))+
                            geom_point(shape=16, alpha=0.7) +
                            scale_color_manual(values=phylum_colors) +
                            theme_minimal() +
                labs(color="Phylum", size="Genome size") +
                guides(color = guide_legend(override.aes = list(size = 5))) # enlarge Phylum dots in legend

function_ordination
```

<!--chapter:end:03_MAGs_Catalouge.Rmd-->


# Community composition

## Gut microbiota

```{r gut_load_data_tax}
load("data/data.Rdata")
```

### Taxonomy overview 

#### Phylum level

```{r taxonomy_barplot, fig.height=6, fig.width=10, fig.fullwidth=TRUE}
genome_counts_filt %>%
  mutate_at(vars(-genome),~./sum(.)) %>% #apply TSS nornalisation
  pivot_longer(-genome, names_to = "sample", values_to = "count") %>% #reduce to minimum number of columns
  left_join(., genome_metadata, by = join_by(genome == genome)) %>% #append genome metadata
  left_join(., sample_metadata, by = join_by(sample == sample)) %>% #append sample metadata
  filter(count > 0) %>% #filter 0 counts
  ggplot(., aes(x=sample,y=count, fill=phylum, group=phylum)) + #grouping enables keeping the same sorting of taxonomic units
    geom_bar(stat="identity", colour="white", linewidth=0.1) + #plot stacked bars with white borders
    scale_fill_manual(values=phylum_colors) +
    guides(fill = guide_legend(ncol = 1)) +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.x = element_blank(),
          panel.background = element_blank(),
          panel.border = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          strip.background = element_rect(fill = "white"),
          strip.text = element_text(size = 12, lineheight = 0.6,face="bold"),
          axis.line = element_line(linewidth = 0.5, linetype = "solid", colour = "black")) +
   labs(fill="Phylum",y = "Relative abundance",x="Samples")
```

**Number of MAGs**
```{r mag, comment="", echo=FALSE, message=FALSE, warning=FALSE}
nmags <- nrow(genome_counts)
cat(nmags)
```

**Number of bacteria phyla**

```{r phyla, comment="", echo=FALSE, message=FALSE, warning=FALSE}
genome_metadata %>% 
  filter(domain == "d__Bacteria")%>%
  dplyr::select(phylum) %>%
  unique() %>%
  pull() %>%
  length() %>% 
  cat()
```

**Number of Archaea phyla**

```{r arch, comment="", echo=FALSE, message=FALSE, warning=FALSE}
genome_metadata %>% 
  filter(domain == "d__Archaea")%>%
  dplyr::select(phylum) %>%
  unique() %>%
  pull() %>%
  length()%>% 
  cat()
```

***Phylum relative abundances***

```{r taxonomy_phylum_summary, warning=FALSE, comments="", message=FALSE}
phylum_summary <- genome_counts_filt %>%
  mutate_at(vars(-genome),~./sum(.)) %>%
  pivot_longer(-genome, names_to = "sample", values_to = "count") %>%
  left_join(sample_metadata, by = join_by(sample == sample)) %>%
  left_join(genome_metadata, by = join_by(genome == genome)) %>%
  group_by(sample,phylum,broad_environment, sex) %>%
  summarise(relabun=sum(count))
```

```{r taxonomy_phylum_summary_envir, warning=FALSE, comments="", message=FALSE}
phylum_summary %>%
  group_by(phylum) %>%
  summarise(
    total_mean = mean(relabun * 100, na.rm = TRUE),
    total_sd = sd(relabun * 100, na.rm = TRUE)
  ) %>%
  mutate(Total = str_c(round(total_mean, 3), "±", round(total_sd, 3))) %>%
  arrange(-total_mean) %>%
  dplyr::select(phylum, Total)

```

```{r taxonomy_jitterplot_phylum, warning=FALSE, comments="", message=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
phylum_arrange <- phylum_summary %>%
    group_by(phylum) %>%
    summarise(mean=sum(relabun)) %>%
    arrange(-mean) %>%
    select(phylum) %>%
    pull()

phylum_summary %>%
    left_join(genome_metadata %>% select(phylum,phylum) %>% unique(),by=join_by(phylum==phylum)) %>%
#    left_join(sample_metadata,by=join_by(sample==sample)) %>%
    filter(phylum %in% phylum_arrange[1:20]) %>%
    mutate(phylum=factor(phylum,levels=rev(phylum_arrange[1:20]))) %>%
    filter(relabun > 0) %>%
    ggplot(aes(x=relabun, y=phylum, group=phylum, color=phylum)) +
        scale_color_manual(values=phylum_colors[-8]) +
        geom_jitter(alpha=0.5) +
        theme_minimal() + 
        labs(y="phylum", x="Relative abundance", color="Phylum")
```
**Bacteria phyla in individuals from females**

```{r phyla_nat_female, comment="", echo=FALSE, message=FALSE, warning=FALSE}

female_sample <- sample_metadata %>% 
  filter(sex=="Female") %>% 
  dplyr::select(sample) %>% 
  pull()

female_genomes <- genome_counts_filt %>% 
  column_to_rownames("genome") %>% 
  select(all_of(female_sample)) %>%
  as.data.frame() %>%
  filter(rowSums(across(where(is.numeric)))!=0)%>% 
  rownames_to_column("genome")%>% 
  dplyr::select(genome) %>% 
  pull()

genome_metadata %>% 
  filter(genome %in% female_genomes) %>% 
  filter(domain == "d__Bacteria")%>%
  dplyr::select(phylum) %>%
  unique() %>%
  pull() %>%
  length() %>% 
  cat()
```

```{r phyla_nat_male, comment="", echo=FALSE, message=FALSE, warning=FALSE}

male_sample <- sample_metadata %>% 
  filter(sex=="Male") %>% 
  dplyr::select(sample) %>% 
  pull()

male_genomes <- genome_counts_filt %>% 
  column_to_rownames("genome") %>% 
  select(all_of(male_sample)) %>%
  as.data.frame() %>%
  filter(rowSums(across(where(is.numeric)))!=0)%>% 
  rownames_to_column("genome")%>% 
  dplyr::select(genome) %>% 
  pull()

genome_metadata %>% 
  filter(genome %in% male_genomes) %>% 
  filter(domain == "d__Bacteria")%>%
  dplyr::select(phylum) %>%
  unique() %>%
  pull() %>%
  length() %>% 
  cat()
```



**Bacteria phyla in individuals from Temperate woodland**

```{r phyla_nat, comment="", echo=FALSE, message=FALSE, warning=FALSE}

Temperate_woodland_samples <- sample_metadata %>% 
  filter(broad_environment=="1000221 - Temperate woodland") %>% 
  dplyr::select(sample) %>% 
  pull()

Temperate_woodland_genomes <- genome_counts_filt %>% 
  column_to_rownames("genome") %>% 
  select(all_of(Temperate_woodland_samples)) %>%
  as.data.frame() %>%
  filter(rowSums(across(where(is.numeric)))!=0)%>% 
  rownames_to_column("genome")%>% 
  dplyr::select(genome) %>% 
  pull()

genome_metadata %>% 
  filter(genome %in% Temperate_woodland_genomes) %>% 
  filter(domain == "d__Bacteria")%>%
  dplyr::select(phylum) %>%
  unique() %>%
  pull() %>%
  length() %>% 
  cat()
```


**Bacteria phyla in individuals from Xeric shrubland**

```{r phyla_cap_xeric, comment="", echo=FALSE, message=FALSE, warning=FALSE}

xeric_shrubland_samples <- sample_metadata %>% 
  filter(broad_environment=="1000218 - Xeric shrubland") %>% 
  dplyr::select(sample) %>% 
  pull()

xeric_shrubland_genomes <- genome_counts_filt %>% 
  column_to_rownames("genome") %>% 
  select(all_of(xeric_shrubland_samples)) %>%
  as.data.frame() %>%
  filter(rowSums(across(where(is.numeric)))!=0)%>% 
  rownames_to_column("genome")%>% 
  dplyr::select(genome) %>% 
  pull()

genome_metadata %>% 
  filter(genome %in% xeric_shrubland_genomes) %>% 
  filter(domain == "d__Bacteria")%>%
  dplyr::select(phylum) %>%
  unique() %>%
  pull() %>%
  length() %>% 
  cat()
```
**Bacteria phyla in individuals from mixed_forest**
```{r phyla_cap_forest, comment="", echo=FALSE, message=FALSE, warning=FALSE}

mixed_forest_samples <- sample_metadata %>% 
  filter(broad_environment=="1000198 - Mixed forest") %>% 
  dplyr::select(sample) %>% 
  pull()

mixed_forest_genomes <- genome_counts_filt %>% 
  column_to_rownames("genome") %>% 
  select(all_of(mixed_forest_samples)) %>%
  as.data.frame() %>%
  filter(rowSums(across(where(is.numeric)))!=0)%>% 
  rownames_to_column("genome")%>% 
  dplyr::select(genome) %>% 
  pull()

genome_metadata %>% 
  filter(genome %in% mixed_forest_genomes) %>% 
  filter(domain == "d__Bacteria")%>%
  dplyr::select(phylum) %>%
  unique() %>%
  pull() %>%
  length() %>% 
  cat()
```

**Bacteria phyla in individuals from cropland**
```{r phyla_cap_cropland, comment="", echo=FALSE, message=FALSE, warning=FALSE}

cropland_samples <- sample_metadata %>% 
  filter(broad_environment=="1000245 - Cropland") %>% 
  dplyr::select(sample) %>% 
  pull()

cropland_genomes <- genome_counts_filt %>% 
  column_to_rownames("genome") %>% 
  select(all_of(cropland_samples)) %>%
  as.data.frame() %>%
  filter(rowSums(across(where(is.numeric)))!=0)%>% 
  rownames_to_column("genome")%>% 
  dplyr::select(genome) %>% 
  pull()

genome_metadata %>% 
  filter(genome %in% cropland_genomes) %>% 
  filter(domain == "d__Bacteria")%>%
  dplyr::select(phylum) %>%
  unique() %>%
  pull() %>%
  length() %>% 
  cat()
```

```{r taxonomy_phylum_summary_broad_environment, warning=FALSE, comments="", message=FALSE}
phylum_summary %>%
  group_by(phylum) %>%
  summarise(
    total_mean = mean(relabun * 100, na.rm = TRUE),
    total_sd = sd(relabun * 100, na.rm = TRUE),
    le_mean = mean(ifelse(broad_environment == "1000245 - Cropland", relabun * 100, NA), na.rm = TRUE),
    le_sd = sd(ifelse(broad_environment == "1000245 - Cropland", relabun * 100, NA), na.rm = TRUE),
    ha_mean = mean(ifelse(broad_environment == "1000198 - Mixed forest", relabun * 100, NA), na.rm = TRUE),
    ha_sd = sd(ifelse(broad_environment == "1000198 - Mixed forest", relabun * 100, NA), na.rm = TRUE),
    er_mean = mean(ifelse(broad_environment == "1000218 - Xeric shrubland", relabun * 100, NA), na.rm = TRUE),
    er_sd = sd(ifelse(broad_environment == "1000218 - Xeric shrubland", relabun * 100, NA), na.rm = TRUE),
    go_mean = mean(ifelse(broad_environment == "1000221 - Temperate woodland", relabun * 100, NA), na.rm = TRUE),
    go_sd = sd(ifelse(broad_environment == "1000221 - Temperate woodland", relabun * 100, NA), na.rm = TRUE)
  ) %>%
  mutate(
    Total = str_c(round(total_mean, 3), "±", round(total_sd, 3)),
    Cropland = str_c(round(le_mean, 3), "±", round(le_sd, 3)),
    Mixed_forest = str_c(round(ha_mean, 3), "±", round(ha_sd, 3)),
    Xeric_shrubland = str_c(round(er_mean, 3), "±", round(er_sd, 3)),
    Temperate_woodland = str_c(round(go_mean, 3), "±", round(go_sd, 3))
  ) %>%
  arrange(-total_mean) %>%
  select(phylum, Total, Cropland, Temperate_woodland, Mixed_forest, Xeric_shrubland)

```

```{r taxonomy_phylum_summary_sex, warning=FALSE, comments="", message=FALSE}
phylum_summary %>%
  group_by(phylum) %>%
  summarise(
    total_mean = mean(relabun * 100, na.rm = TRUE),
    total_sd = sd(relabun * 100, na.rm = TRUE),
    le_mean = mean(ifelse(sex == "Female", relabun * 100, NA), na.rm = TRUE),
    le_sd = sd(ifelse(sex == "Female", relabun * 100, NA), na.rm = TRUE),
    ha_mean = mean(ifelse( sex== "Male", relabun * 100, NA), na.rm = TRUE),
    ha_sd = sd(ifelse(sex == "Male", relabun * 100, NA), na.rm = TRUE)
  ) %>%
  mutate(
    Total = str_c(round(total_mean, 3), "±", round(total_sd, 3)),
    Female = str_c(round(le_mean, 3), "±", round(le_sd, 3)),
    Male = str_c(round(ha_mean, 3), "±", round(ha_sd, 3))
  ) %>%
  arrange(-total_mean) %>%
  select(phylum, Total, Female, Male)

```

#### Family level

***Percentange of families in each group of environment***

```{r taxonomy_family_summary, warning=FALSE, comments="", message=FALSE}
family_summary <- genome_counts_filt %>%
  mutate_at(vars(-genome),~./sum(.)) %>% #apply TSS nornalisation
  pivot_longer(-genome, names_to = "sample", values_to = "count") %>% #reduce to minimum number of columns
  left_join(sample_metadata, by = join_by(sample == sample)) %>% #append sample metadata
  left_join(genome_metadata, by = join_by(genome == genome)) %>% #append genome metadata
  group_by(sample,family, broad_environment, sex) %>%
  summarise(relabun=sum(count))
```

```{r taxonomy_family_summary_origin_environment, warning=FALSE, comments="", message=FALSE}
family_summary %>%
    group_by(family) %>%
    summarise(
    total_mean = mean(relabun * 100, na.rm = TRUE),
    total_sd = sd(relabun * 100, na.rm = TRUE),
    le_mean = mean(ifelse(broad_environment == "1000245 - Cropland", relabun * 100, NA), na.rm = TRUE),
    le_sd = sd(ifelse(broad_environment == "1000245 - Cropland", relabun * 100, NA), na.rm = TRUE),
    ha_mean = mean(ifelse(broad_environment == "1000198 - Mixed forest", relabun * 100, NA), na.rm = TRUE),
    ha_sd = sd(ifelse(broad_environment == "1000198 - Mixed forest", relabun * 100, NA), na.rm = TRUE),
    er_mean = mean(ifelse(broad_environment == "1000218 - Xeric shrubland", relabun * 100, NA), na.rm = TRUE),
    er_sd = sd(ifelse(broad_environment == "1000218 - Xeric shrubland", relabun * 100, NA), na.rm = TRUE),
    go_mean = mean(ifelse(broad_environment == "1000221 - Temperate woodland", relabun * 100, NA), na.rm = TRUE),
    go_sd = sd(ifelse(broad_environment == "1000221 - Temperate woodland", relabun * 100, NA), na.rm = TRUE)
  ) %>%
  mutate(
    Total = str_c(round(total_mean, 3), "±", round(total_sd, 3)),
    Cropland = str_c(round(le_mean, 3), "±", round(le_sd, 3)),
    Mixed_forest = str_c(round(ha_mean, 3), "±", round(ha_sd, 3)),
    Xeric_shrubland = str_c(round(er_mean, 3), "±", round(er_sd, 3)),
    Temperate_woodland = str_c(round(go_mean, 3), "±", round(go_sd, 3))
  ) %>%
    dplyr::select(family,Total,Cropland, Temperate_woodland, Mixed_forest, Xeric_shrubland)
```

```{r taxonomy_jitterplot_family, warning=FALSE, comments="", message=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
family_arrange <- family_summary %>%
    group_by(family) %>%
    summarise(mean=sum(relabun)) %>%
    arrange(-mean) %>%
    select(family) %>%
    pull()

# Per environment
family_summary %>%
    left_join(genome_metadata %>% select(family,phylum) %>% unique(),by=join_by(family==family)) %>%
    filter(family %in% family_arrange[1:20]) %>%
    mutate(family=factor(family,levels=rev(family_arrange[1:20]))) %>%
    filter(relabun > 0) %>%
    ggplot(aes(x=relabun, y=family, group=family, color=phylum)) +
        scale_color_manual(values=phylum_colors[-8]) +
        geom_jitter(alpha=0.5) + 
        facet_grid(.~broad_environment)+
        theme_minimal() + 
        labs(y="Family", x="Relative abundance", color="Phylum")

```

```{r taxonomy_family_summary_broad_environment, warning=FALSE, comments="", message=FALSE}
family_summary %>%
    group_by(family) %>%
    summarise(total_mean=mean(relabun*100, na.rm=T),
              total_sd=sd(relabun*100, na.rm=T),
              le_mean=mean(relabun[broad_environment=="1000245 - Cropland"]*100, na.rm=T),
             le_sd=sd(relabun[broad_environment=="1000245 - Cropland"]*100, na.rm=T),
              ha_mean=mean(relabun[broad_environment=="1000198 - Mixed forest"]*100, na.rm=T),
              ha_sd=sd(relabun[broad_environment=="1000198 - Mixed forest"]*100, na.rm=T),
              er_mean=mean(relabun[broad_environment=="1000218 - Xeric shrubland"]*100, na.rm=T),
              er_sd=sd(relabun[broad_environment=="1000218 - Xeric shrubland"]*100, na.rm=T),
              go_mean=mean(relabun[broad_environment=="1000221 - Temperate woodland"]*100, na.rm=T),
              go_sd=sd(relabun[broad_environment=="1000221 - Temperate woodland"]*100, na.rm=T)) %>%
    mutate(Total=str_c(round(total_mean,3),"±",round(total_sd,3)),
          Cropland=str_c(round(le_mean,3),"±",round(le_sd,3)),
          Mixed_forest=str_c(round(ha_mean,3),"±",round(ha_sd,3)),
          Xeric_shrubland=str_c(round(er_mean,3),"±",round(er_sd,3)),
          Temperate_woodland=str_c(round(go_mean,3),"±",round(go_sd,3))) %>% 
    arrange(-total_mean) %>% 
    dplyr::select(family,Total,Cropland,Temperate_woodland, Mixed_forest,Xeric_shrubland)
```
***Family summary grouped by sex***

```{r taxonomy_family_summary_origin_sex, warning=FALSE, comments="", message=FALSE}
family_summary %>%
    group_by(family) %>%
   summarise(
    total_mean = mean(relabun * 100, na.rm = TRUE),
    total_sd = sd(relabun * 100, na.rm = TRUE),
    le_mean = mean(ifelse(sex == "Female", relabun * 100, NA), na.rm = TRUE),
    le_sd = sd(ifelse(sex == "Female", relabun * 100, NA), na.rm = TRUE),
    ha_mean = mean(ifelse( sex== "Male", relabun * 100, NA), na.rm = TRUE),
    ha_sd = sd(ifelse(sex == "Male", relabun * 100, NA), na.rm = TRUE)
  ) %>%
  mutate(
    Total = str_c(round(total_mean, 3), "±", round(total_sd, 3)),
    Female = str_c(round(le_mean, 3), "±", round(le_sd, 3)),
    Male = str_c(round(ha_mean, 3), "±", round(ha_sd, 3))
  ) %>%
  arrange(-total_mean) %>%
  select(family, Total, Female, Male)
```
```{r taxonomy_jitterplot_family_sex, warning=FALSE, comments="", message=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
family_arrange <- family_summary %>%
    group_by(family) %>%
    summarise(mean=sum(relabun)) %>%
    arrange(-mean) %>%
    select(family) %>%
    pull()

# Per environment
family_summary %>%
    left_join(genome_metadata %>% select(family,phylum) %>% unique(),by=join_by(family==family)) %>%
    filter(family %in% family_arrange[1:20]) %>%
    mutate(family=factor(family,levels=rev(family_arrange[1:20]))) %>%
    filter(relabun > 0) %>%
    ggplot(aes(x=relabun, y=family, group=family, color=phylum)) +
        scale_color_manual(values=phylum_colors[-8]) +
        geom_jitter(alpha=0.5) + 
        facet_grid(.~sex)+
        theme_minimal() + 
        labs(y="Family", x="Relative abundance", color="Phylum")

```

```{r taxonomy_family_summary_sex, warning=FALSE, comments="", message=FALSE}
family_summary %>%
    group_by(family) %>%
    summarise(
    total_mean = mean(relabun * 100, na.rm = TRUE),
    total_sd = sd(relabun * 100, na.rm = TRUE),
    le_mean = mean(ifelse(sex == "Female", relabun * 100, NA), na.rm = TRUE),
    le_sd = sd(ifelse(sex == "Female", relabun * 100, NA), na.rm = TRUE),
    ha_mean = mean(ifelse( sex== "Male", relabun * 100, NA), na.rm = TRUE),
    ha_sd = sd(ifelse(sex == "Male", relabun * 100, NA), na.rm = TRUE)
  ) %>%
  mutate(
    Total = str_c(round(total_mean, 3), "±", round(total_sd, 3)),
    Female = str_c(round(le_mean, 3), "±", round(le_sd, 3)),
    Male = str_c(round(ha_mean, 3), "±", round(ha_sd, 3))
  ) %>%
  arrange(-total_mean) %>%
    dplyr::select(family,Total,Female, Male)
```
#### Genus level

*** Percetange of genera in each group of environment***

```{r taxonomy_genus_summary, warning=FALSE, comments="", message=FALSE}
genus_summary <- genome_counts_filt %>%
  mutate_at(vars(-genome),~./sum(.)) %>% #apply TSS nornalisation
  pivot_longer(-genome, names_to = "sample", values_to = "count") %>% #reduce to minimum number of columns
  left_join(sample_metadata, by = join_by(sample == sample)) %>% #append sample metadata
  left_join(genome_metadata, by = join_by(genome == genome)) %>% #append genome metadata
  group_by(sample,phylum,genus,broad_environment) %>%
  summarise(relabun=sum(count)) 
# %>%
#   filter(genus != "g__") %>%
#   mutate(genus= sub("^g__", "", genus))

genus_summary %>%
    group_by(genus) %>%
    summarise(total_mean=mean(relabun*100, na.rm=T),
              total_sd=sd(relabun*100, na.rm=T),
              le_mean=mean(relabun[broad_environment=="1000245 - Cropland"]*100, na.rm=T),
             le_sd=sd(relabun[broad_environment=="1000245 - Cropland"]*100, na.rm=T),
              ha_mean=mean(relabun[broad_environment=="1000198 - Mixed forest"]*100, na.rm=T),
              ha_sd=sd(relabun[broad_environment=="1000198 - Mixed forest"]*100, na.rm=T),
              er_mean=mean(relabun[broad_environment=="1000218 - Xeric shrubland"]*100, na.rm=T),
              er_sd=sd(relabun[broad_environment=="1000218 - Xeric shrubland"]*100, na.rm=T),
              go_mean=mean(relabun[broad_environment=="1000221 - Temperate woodland"]*100, na.rm=T),
              go_sd=sd(relabun[broad_environment=="1000221 - Temperate woodland"]*100, na.rm=T)) %>%
    mutate(Total=str_c(round(total_mean,3),"±",round(total_sd,3)),
          Cropland=str_c(round(le_mean,3),"±",round(le_sd,3)),
          Mixed_forest=str_c(round(ha_mean,3),"±",round(ha_sd,3)),
          Xeric_shrubland=str_c(round(er_mean,3),"±",round(er_sd,3)),
          Temperate_woodland=str_c(round(go_mean,3),"±",round(go_sd,3))) %>% 
    arrange(-total_mean) %>% 
    dplyr::select(genus,Total, Cropland,Temperate_woodland, Mixed_forest,Xeric_shrubland) 
```

```{r taxonomy_jitterplot_genus, fig.height=14, fig.width=10, fig.fullwidth=TRUE}
genus_summary_sort <- genus_summary %>%
    group_by(genus) %>%
    summarise(mean=mean(relabun, na.rm=T),sd=sd(relabun, na.rm=T)) %>%
    arrange(-mean) 

genus_summary %>%
  mutate(genus=factor(genus, levels=rev(genus_summary_sort %>% pull(genus)))) %>%
  filter(relabun > 0) %>%
  ggplot(aes(x=relabun, y=genus, group=genus, color=phylum)) +
  scale_color_manual(values=phylum_colors) +
  geom_jitter(alpha=0.5) + 
  facet_grid(.~broad_environment)+
  theme_minimal() + 
  theme(axis.text.y = element_text(size=6))+
  labs(y="Family", x="Relative abundance", color="Phylum")

```
*** Percetange of genera in each group of sex***

```{r taxonomy_genus_summary_sex, warning=FALSE, comments="", message=FALSE}
genus_summary <- genome_counts_filt %>%
  mutate_at(vars(-genome),~./sum(.)) %>% #apply TSS nornalisation
  pivot_longer(-genome, names_to = "sample", values_to = "count") %>% #reduce to minimum number of columns
  left_join(sample_metadata, by = join_by(sample == sample)) %>% #append sample metadata
  left_join(genome_metadata, by = join_by(genome == genome)) %>% #append genome metadata
  group_by(sample,phylum,genus,sex) %>%
  summarise(relabun=sum(count)) 
# %>%
#   filter(genus != "g__") %>%
#   mutate(genus= sub("^g__", "", genus))

genus_summary %>%
    group_by(genus) %>%
    summarise(total_mean=mean(relabun*100, na.rm=T),
              total_sd=sd(relabun*100, na.rm=T),
              le_mean=mean(relabun[sex=="Female"]*100, na.rm=T),
             le_sd=sd(relabun[sex=="Female"]*100, na.rm=T),
              ha_mean=mean(relabun[sex=="Male"]*100, na.rm=T),
              ha_sd=sd(relabun[sex=="Male"]*100, na.rm=T)) %>%
    mutate(Total=str_c(round(total_mean,3),"±",round(total_sd,3)),
          Female=str_c(round(le_mean,3),"±",round(le_sd,3)),
          Male=str_c(round(ha_mean,3),"±",round(ha_sd,3))) %>% 
    arrange(-total_mean) %>% 
    dplyr::select(genus,Total,Male,Female) 
```

```{r taxonomy_jitterplot_genus_sex, fig.height=14, fig.width=10, fig.fullwidth=TRUE}
genus_summary_sort <- genus_summary %>%
    group_by(genus) %>%
    summarise(mean=mean(relabun, na.rm=T),sd=sd(relabun, na.rm=T)) %>%
    arrange(-mean) 

genus_summary %>%
  mutate(genus=factor(genus, levels=rev(genus_summary_sort %>% pull(genus)))) %>%
  filter(relabun > 0) %>%
  ggplot(aes(x=relabun, y=genus, group=genus, color=phylum)) +
  scale_color_manual(values=phylum_colors) +
  geom_jitter(alpha=0.5) + 
  facet_grid(.~sex)+
  theme_minimal() + 
  theme(axis.text.y = element_text(size=6))+
  labs(y="Family", x="Relative abundance", color="Phylum")

```

**Number of MAGs without genera-level annotation**
```{r nongenera_gut, comment="", echo=FALSE, message=FALSE, warning=FALSE}
genome_metadata %>%
  filter(genus == "g__") %>%
  nrow() %>% 
  cat()
```

```{r nongene_phylum_gut, comment="", echo=FALSE, message=FALSE, warning=FALSE}
total_mag_phylum <- genome_metadata %>%
  group_by(phylum) %>%
  summarize(count_total = n())
genome_metadata %>%
  filter(genus == "g__") %>%
  group_by(phylum) %>%
  summarize(count_nogene = n()) %>% 
  left_join(total_mag_phylum, by = join_by(phylum == phylum)) %>% 
  mutate(percentage=100*count_nogene/count_total) %>% 
  tt()
```

**Percentage of MAGs without genus-level annotation**
```{r gen_percet, comment="", echo=FALSE, message=FALSE, warning=FALSE}
nongenera <- genome_metadata %>%
  filter(genus == "g__") %>%
  summarize(Mag_nogenera = n()) %>% 
  pull()
perct <- nongenera*100/nmags
cat(perct)
```


**Number of MAGs without species-level annotation**
```{r nonspe, comment="", echo=FALSE, message=FALSE, warning=FALSE}
genome_metadata %>%
  filter(species == "s__") %>%
  summarize(Mag_nospecies = n())

```

```{r nonspe_phylum, comment="", echo=FALSE, message=FALSE, warning=FALSE}
total_mag_phylum <- genome_metadata %>%
  group_by(phylum) %>%
  summarize(count_total = n())
genome_metadata %>%
  filter(species == "s__") %>%
  group_by(phylum) %>%
  summarize(count_nospecies = n()) %>% 
  left_join(total_mag_phylum, by = join_by(phylum == phylum)) %>%
  mutate(species_annotated=count_total-count_nospecies) %>% 
  mutate(percentage=100*count_nospecies/count_total) %>% 
  mutate(percentage_species=100-100*count_nospecies/count_total)%>% 
  tt()
```

**Percentage of MAGs without species-level annotation**
```{r sp_percet, comment="", echo=FALSE, message=FALSE, warning=FALSE}
nonspecies <- genome_metadata %>%
  filter(species == "s__") %>%
  summarize(Mag_nospecies = n()) %>% 
  pull()
perct <- nonspecies*100/nmags
cat(perct)
```

<!--chapter:end:04_Community.Rmd-->


# Alpha diversity

## Gut microbiota

```{r load_data_alpha}
load("data/data.Rdata")
treatment_colors <- c("#f56042","#429ef5", "#42f58d", "#b142f5")
sample_metadata$broad_environment <- factor(sample_metadata$broad_environment, levels=c("1000198 - Mixed forest", "1000221 - Temperate woodland", "1000218 - Xeric shrubland", "1000245 - Cropland"))
```

```{r alpha_div, comment="", message=FALSE, warning=FALSE}
# Calculate Hill numbers
richness <- genome_counts_filt %>%
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 0) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(richness = 1) %>%
  rownames_to_column(var = "sample")

neutral <- genome_counts_filt %>%
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 1) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(neutral = 1) %>%
  rownames_to_column(var = "sample")

phylogenetic <- genome_counts_filt %>%
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 1, tree = genome_tree) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(phylogenetic = 1) %>%
  rownames_to_column(var = "sample")

# Aggregate basal GIFT into elements
dist <- genome_gifts %>%
  to.elements(., GIFT_db) %>%
  traits2dist(., method = "gower")

functional <- genome_counts_filt %>%
  filter(genome %in% rownames(dist)) %>% 
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 1, dist = dist) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(functional = 1) %>%
  rownames_to_column(var = "sample") %>%
  mutate(functional = if_else(is.nan(functional), 1, functional))

# Merge all metrics
alpha_div <- richness %>%
  full_join(neutral, by = join_by(sample == sample)) %>%
  full_join(phylogenetic, by = join_by(sample == sample)) %>%
  full_join(functional, by = join_by(sample == sample))
```

```{r alpha_div_diets_summary_all, comment="",echo=FALSE, message=FALSE, warning=FALSE}
alpha_div %>%
  pivot_longer(-sample, names_to = "alpha", values_to = "value") %>%
  left_join(sample_metadata, by = join_by(sample == sample)) %>%
    group_by(alpha)%>%
    summarise(total_mean=mean(value, na.rm=T),
              total_sd=sd(value, na.rm=T),
              Xeric_shrubland_mean=mean(value[broad_environment=="1000218 - Xeric shrubland"], na.rm=T),
             Xeric_shrubland_sd=sd(value[broad_environment=="1000218 - Xeric shrubland"], na.rm=T),
             Cropland_mean=mean(value[broad_environment=="1000245 - Cropland"], na.rm=T),
             Cropland_sd=sd(value[broad_environment=="1000245 - Cropland"], na.rm=T),
              Mixed_forest_mean=mean(value[broad_environment=="1000198 - Mixed forest"], na.rm=T),
             Mixed_forest_sd=sd(value[broad_environment=="1000198 - Mixed forest"], na.rm=T),
              Temperate_woodland_mean=mean(value[broad_environment=="1000221 - Temperate woodland"], na.rm=T),
              Temperate_woodland_sd=sd(value[broad_environment=="1000221 - Temperate woodland"], na.rm=T)) %>%
    mutate(Total=str_c(round(total_mean,2),"±",round(total_sd,2)),
           Xeric_shrubland=str_c(round(Xeric_shrubland_mean,2),"±",round(Xeric_shrubland_sd,2)),
           Cropland=str_c(round(Cropland_mean,2),"±",round(Cropland_sd,2)),
           Mixed_forest=str_c(round(Mixed_forest_mean,2),"±",round(Mixed_forest_sd,2)),
           Temperate_woodland=str_c(round(Temperate_woodland_mean,2),"±",round(Temperate_woodland_sd,2))) %>% 
    arrange(-total_mean) %>% 
    dplyr::select(alpha,Total,Xeric_shrubland,Temperate_woodland,Cropland,Mixed_forest) %>% 
  tt()
```

```{r alpha_div_boxplot, comment="", message=FALSE, warning=FALSE, fig.height=3, fig.width=10, fig.fullwidth=TRUE}
#Richness
plot1 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(metric=="richness") %>%
  ggplot(aes(y = value, x = broad_environment, group=broad_environment, color=broad_environment, fill=broad_environment)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=treatment_colors)+
  scale_fill_manual(values=treatment_colors) +
  scale_x_discrete(labels=c("1000218 - Xeric shrubland" = "Xeric shrubland", "1000245 - Cropland" = "Cropland", "1000198 - Mixed forest" = "Mixed forest", "1000221 - Temperate woodland" = "Temperate woodland")) +
  stat_compare_means(method = "wilcox.test", show.legend = F, size = 3, label.y = c(300), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    axis.title.x = element_blank(),
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))
    )+
  labs(y = "Richness")


plot2 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(metric=="neutral") %>%
  ggplot(aes(y = value, x = broad_environment, group=broad_environment, color=broad_environment, fill=broad_environment)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=treatment_colors)+
  scale_fill_manual(values=treatment_colors) +
  scale_x_discrete(labels=c("1000218 - Xeric shrubland" = "Xeric shrubland", "1000245 - Cropland" = "Cropland", "1000198 - Mixed forest" = "Mixed forest", "1000221 - Temperate woodland" = "Temperate woodland")) +
  stat_compare_means(method = "wilcox.test", show.legend = F, size = 3, label.y = c(190), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    axis.title.x = element_blank(),
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))
    )+
  labs(y = "Neutral alpha diversity")

plot3 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(metric=="phylogenetic") %>%
  ggplot(aes(y = value, x = broad_environment, group=broad_environment, color=broad_environment, fill=broad_environment)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=treatment_colors)+
  scale_fill_manual(values=treatment_colors) +
  scale_x_discrete(labels=c("1000218 - Xeric shrubland" = "Xeric shrubland", "1000245 - Cropland" = "Cropland", "1000198 - Mixed forest" = "Mixed forest", "1000221 - Temperate woodland" = "Temperate woodland")) +
  stat_compare_means(method = "wilcox.test", show.legend = F, size = 3, label.y = c(12), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    axis.title.x = element_blank(),
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))
    )+
  labs(y = "Phylogenetic alpha diversity")


plot4 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(metric=="functional") %>%
  ggplot(aes(y = value, x = broad_environment, group=broad_environment, color=broad_environment, fill=broad_environment)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=treatment_colors)+
  scale_fill_manual(values=treatment_colors) +
  scale_x_discrete(labels=c("1000218 - Xeric shrubland" = "Xeric shrubland", "1000245 - Cropland" = "Cropland", "1000198 - Mixed forest" = "Mixed forest", "1000221 - Temperate woodland" = "Temperate woodland")) +
  stat_compare_means(method = "wilcox.test", show.legend = F, size = 3, label.y = c(2), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    axis.title.x = element_blank(),
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))
    )+
  labs(y = "Functional alpha diversity")
```
```{r div_plot_together, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
grid.arrange(arrangeGrob(plot1,plot2,plot3, plot4, ncol = 2))
```

```{r alpha_div_boxplot_sex, comment="", message=FALSE, warning=FALSE, fig.height=3, fig.width=10, fig.fullwidth=TRUE}
#Richness
plot1 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(metric=="richness") %>%
  ggplot(aes(y = value, x = sex, group=sex, color=broad_environment, fill=broad_environment)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=treatment_colors)+
  scale_fill_manual(values=treatment_colors) +
  facet_grid(~factor(broad_environment, labels=c("1000218 - Xeric shrubland" = "Xeric shrubland", "1000245 - Cropland" = "Cropland", "1000198 - Mixed forest" = "Mixed forest", "1000221 - Temperate woodland" = "Temperate woodland")), scale="free", space = "free")+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    axis.title.x = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, lineheight = 0.6),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))
    )+
  labs(y = "Richness")


plot2 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(metric=="neutral") %>%
  ggplot(aes(y = value, x = sex, group=sex, color=broad_environment, fill=broad_environment)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=treatment_colors)+
  scale_fill_manual(values=treatment_colors) +
  facet_grid(~factor(broad_environment, labels=c("1000218 - Xeric shrubland" = "Xeric shrubland", "1000245 - Cropland" = "Cropland", "1000198 - Mixed forest" = "Mixed forest", "1000221 - Temperate woodland" = "Temperate woodland")), scale="free", space = "free")+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    axis.title.x = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, lineheight = 0.6),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))
    )+
  labs(y = "Neutral alpha diversity")

plot3 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(metric=="phylogenetic") %>%
  ggplot(aes(y = value, x = sex, group=sex, color=broad_environment, fill=broad_environment)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=treatment_colors)+
  scale_fill_manual(values=treatment_colors) +
  facet_grid(~factor(broad_environment, labels=c("1000218 - Xeric shrubland" = "Xeric shrubland", "1000245 - Cropland" = "Cropland", "1000198 - Mixed forest" = "Mixed forest", "1000221 - Temperate woodland" = "Temperate woodland")), scale="free", space = "free")+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    axis.title.x = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, lineheight = 0.6),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))
    )+
  labs(y = "Phylogenetic alpha diversity")


plot4 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(metric=="functional") %>%
  ggplot(aes(y = value, x = sex, group=sex, color=broad_environment, fill=broad_environment)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=treatment_colors)+
  scale_fill_manual(values=treatment_colors) +
  facet_grid(~factor(broad_environment, labels=c("1000218 - Xeric shrubland" = "Xeric shrubland", "1000245 - Cropland" = "Cropland", "1000198 - Mixed forest" = "Mixed forest", "1000221 - Temperate woodland" = "Temperate woodland")), scale="free", space = "free")+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    axis.title.x = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, lineheight = 0.6),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))
    )+
  labs(y = "Functional alpha diversity")
```

```{r div_plot_together_sex, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
grid.arrange(arrangeGrob(plot1,plot2,plot3, plot4, ncol = 2))
```

### Mixed models

```{r rich_MM, comment="", message=FALSE, warning=FALSE}

alpha_div_meta <- alpha_div %>%
  left_join(sample_metadata, by = join_by(sample == sample))

alpha_div_meta_clean <- alpha_div_meta %>%
  filter(!is.na(richness), !is.na(broad_environment), !is.na(sex))

alpha_dic_meta_filtered_out <- anti_join(alpha_div_meta, alpha_div_meta_clean)

Model_richness_random <- lme(fixed = richness ~ broad_environment, data = alpha_div_meta_clean,
               random = ~ 1 | sex)
summary(Model_richness_random)

Model_richness<- lm(formula = richness ~ broad_environment+sex, data = alpha_div_meta_clean) 
summary(Model_richness)

Model_richness_sex_random <- lme(fixed = richness ~ sex, data = alpha_div_meta_clean,
               random = ~ 1 | broad_environment)
summary(Model_richness_sex_random)
emmeans(Model_richness_sex_random, pairwise ~ sex)
```

```{r neutral_MM, comment="", message=FALSE, warning=FALSE}
Model_neutral_random <- lme(fixed = neutral ~ broad_environment, data = alpha_div_meta_clean,
               random = ~ 1 | sex)
summary(Model_neutral_random)

Model_neutral<- lm(formula = neutral ~ broad_environment+sex, data = alpha_div_meta_clean) 
summary(Model_neutral)

Model_neutral_sex_random <- lme(fixed = neutral ~ sex, data = alpha_div_meta_clean,
               random = ~ 1 | broad_environment)
summary(Model_neutral_sex_random)
emmeans(Model_neutral_sex_random, pairwise ~ sex)
```

```{r phylo_MM, comment="", message=FALSE, warning=FALSE}

Model_phylogenetic<- lm(formula = phylogenetic ~ broad_environment+sex, data = alpha_div_meta_clean) 
summary(Model_phylogenetic)

Model_phylogenetic_sex_random <- lme(fixed = phylogenetic ~ sex, data = alpha_div_meta_clean,
               random = ~ 1 | broad_environment)

Model_phylogenetic_sex_random <- lme(fixed = phylogenetic ~ sex, data = alpha_div_meta_clean,
               random = ~ 1 | broad_environment)
summary(Model_phylogenetic_sex_random)
emmeans(Model_phylogenetic_sex_random, pairwise ~ sex)

```

```{r funct_MM, comment="", message=FALSE, warning=FALSE}
Model_functional_random <- lme(fixed = functional ~ broad_environment, data = alpha_div_meta_clean,
               random = ~ 1 | sex)
summary(Model_functional_random)

Model_functional<- lm(formula = functional ~ broad_environment+sex, data = alpha_div_meta_clean) 
summary(Model_functional)

Model_functional_sex_random <- lme(fixed = functional ~ sex, data = alpha_div_meta_clean,
               random = ~ 1 | broad_environment)
summary(Model_functional_sex_random)
emmeans(Model_functional_sex_random, pairwise ~ sex)
```

<!--chapter:end:05_Differential_abundance.Rmd-->


# Beta diversity
## Gut microbiota
```{r load_data_beta}
load("data/data.Rdata")
#load("data/beta_all.Rdata")

treatment_colors <- c("#f56042","#429ef5", "#42f58d", "#b142f5", "#f5e642")
```

```{r filter_NAs}
sample_metadata_without_NA <- sample_metadata %>%
  filter(!is.na(broad_environment))
```

***beta_div***
```{r beta_div, comment="", message=FALSE, warning=FALSE, eval=FALSE}
#Presence/Absence
beta_q0n <- genome_counts_filt %>% 
  column_to_rownames(., "genome") %>%
  filter(rowSums(. != 0, na.rm = TRUE) > 0) %>%
  select_if(~!all(. == 0)) %>%
  hillpair(., q = 0)
#Abundance-sensitive
beta_q1n <- genome_counts_filt %>%
  column_to_rownames(., "genome") %>%
  filter(rowSums(. != 0, na.rm = TRUE) > 0) %>%
  select_if(~!all(. == 0)) %>%
  hillpair(., q = 1)
#Abundance + Phylogeny
genome_counts_filt_beta <- genome_counts_filt %>%
  column_to_rownames(., "genome") %>% 
  filter(rowSums(. != 0, na.rm = TRUE) > 0) %>%
  select_if(~!all(. == 0))%>%
  rownames_to_column(., "genome")
#Abundance + Trait Distance
genome_tree <- keep.tip(genome_tree, tip=genome_counts_filt_beta$genome)
beta_q1p <- genome_counts_filt %>%  
  column_to_rownames(., "genome") %>%
  filter(rowSums(. != 0, na.rm = TRUE) > 0) %>%
  select_if(~!all(. == 0)) %>%
  hillpair(., q = 1, tree = genome_tree)
```

```{r beta_div2, comment="", message=FALSE, warning=FALSE, eval=TRUE}

# 1. Only use genomes that also occur in genome_gifts
valid_genomes <- genome_counts_filt_beta$genome[genome_counts_filt_beta$genome %in% rownames(genome_gifts)]

# 2. filter genome_gifts on these genomes
genome_gifts1 <- genome_gifts[valid_genomes, ]
genome_gifts1 <- genome_gifts1[, colSums(genome_gifts1 != 0) > 0]

# 3. Calculate functional distance matrix
dist <- genome_gifts1 %>%
  to.elements(., GIFT_db) %>%
  traits2dist(., method = "gower")

# 4. Determine genomes that exist in both genome_counts_filt_beta and dist
common_genomes <- intersect(
  genome_counts_filt_beta$genome,
  rownames(dist)
)

# 5. genome_counts_filt to filter and sort the shared genomes
genome_counts_filt_matched <- genome_counts_filt %>%
  column_to_rownames("genome") %>%
  filter(rownames(.) %in% common_genomes) %>%
  select_if(~!all(. == 0))  # optional: leere Spalten raus

# 6. Limit and sort dist matrix to common genomes
dist_matched <- dist[common_genomes, common_genomes]


beta_q1f <- genome_counts_filt_matched %>%
  hillpair(q = 1, dist = dist_matched)


```

```{r save_beta, comment="", message=FALSE,echo=FALSE,warning=FALSE, eval=FALSE}
save(beta_q0n, 
     beta_q1n, 
     beta_q1p, 
     beta_q1f, 
     file = "data/data.Rdata")
```


```{r seed, comment="", message=FALSE,echo=FALSE,warning=FALSE, eval=FALSE}

set.seed(2025)
```

### Permanova

```{r Funktion für PERMANOVA Analysen, comment="", message=FALSE, warning=FALSE}
run_permanova <- function(beta_matrix, metadata, sample_col = "sample", group_col, group_vars, pairwise = FALSE) {
  
  # 1. Sample labels from Beta-Matrix
  sample_labels <- labels(beta_matrix$S)
  
  # 2. Metadata filtered and sorted
  metadata_matched <- metadata %>%
    filter(!!sym(sample_col) %in% sample_labels) %>%
    arrange(match(!!sym(sample_col), sample_labels))
  
  # 3. Synchronize beta_matrix$S to metadata
  common_samples <- intersect(sample_labels, metadata_matched[[sample_col]])
  beta_matrix$S <- beta_matrix$S[common_samples, common_samples]
  metadata_matched <- metadata_matched %>%
    filter(!!sym(sample_col) %in% common_samples) %>%
    arrange(match(!!sym(sample_col), common_samples))
  
  # 4. Remove samples with NA in group_col
  valid_idx <- !is.na(metadata_matched[[group_col]])
  beta_matrix$S <- beta_matrix$S[valid_idx, valid_idx]
  metadata_matched <- metadata_matched[valid_idx, ]
  
  # 5. Betadisper and Permutest
  cat("\n===== Beta Dispersion Test =====\n")
  dispersion_result <- betadisper(beta_matrix$S, metadata_matched[[group_col]])
  print(permutest(dispersion_result))
  
  # 6. Dynamic formula building
  formula_str <- paste0("beta_matrix$S ~ ", paste(group_vars, collapse = " + "))
  cat("\n===== PERMANOVA Test (adonis2) =====\n")
  permanova_result <- adonis2(as.formula(formula_str),
                              data = metadata_matched,
                              permutations = 999,
                              by = "terms")
  print(broom::tidy(permanova_result))
  
  # 7. (Optional) Pairwise Adonis
  if (pairwise) {
    cat("\n===== Pairwise PERMANOVA =====\n")
    print(pairwise.adonis(beta_matrix$S, metadata_matched[[group_col]], perm = 999))
  }
  
  # 8. Return outputs
  return(list(
    dispersion = dispersion_result,
    permanova = permanova_result
  ))
}
```

# Richness

```{r permanova_richness, comment="", message=FALSE, warning=FALSE, eval = FALSE}

run_permanova(
  beta_matrix = beta_q0n$S,
  metadata = sample_metadata_without_NA,
  sample_col = "sample",
  group_col = "broad_environment",
  group_vars = c("broad_environment","sex", "broad_environment:sex"),
  pairwise = FALSE
)

```

#Neutral diversity

```{r permanova_neutral, comment="", message=FALSE, warning=FALSE, eval = FALSE}
run_permanova(
  beta_matrix = beta_q1n,
  metadata = sample_metadata_without_NA,
  sample_col = "sample",
  group_col = "broad_environment",
  group_vars = c("broad_environment","sex", "broad_environment:sex"),
  pairwise = TRUE
)
```

# Phylogenetic diversity (beta_q1p)

```{r permanova_phylo, comment="", message=FALSE, warning=FALSE, eval = FALSE}

run_permanova(
  beta_matrix = beta_q1p,
  metadata = sample_metadata_without_NA,
  sample_col = "sample",
  group_col = "broad_environment",
  group_vars = c("broad_environment","sex", "broad_environment:sex"),
  pairwise = FALSE  # no pairwise comparisons here
)
```

# Functional diversity (beta_q1f)

```{r permanova_func, comment="", message=FALSE, warning=FALSE, eval = FALSE}

run_permanova(
  beta_matrix = beta_q1f,
  metadata = sample_metadata_without_NA,
  sample_col = "sample",
  group_col = "broad_environment",
  group_vars = c("broad_environment","sex", "broad_environment:sex"),
  pairwise = TRUE  
)
```

### NMDS
####Richness
```{r beta_div_nmds_richness_plot, comment="", message=FALSE, warning=FALSE, fig.height=7, fig.width=10, fig.fullwidth=TRUE}
beta_q0n$S %>%
  vegan::metaMDS(., trymax = 500, k = 2, trace=0) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %>%
  group_by(broad_environment) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = NMDS1, y = NMDS2, color = broad_environment, shape = as.factor(sex))) +
  geom_point(size = 4) +
  scale_color_manual(values = treatment_colors,labels=c("high" = "High-altitude", "low" = "Low-altitude")) +
  geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9, show.legend = FALSE) +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    panel.background = element_blank(),
    axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.position = "right", legend.box = "vertical"
    ) +
    labs(color="Environmental context", shape="sex")+geom_text_repel(aes(label = sample), size=3)

```


#### Neutral diversity

```{r beta_div_nmds_neutral_plot, comment="", message=FALSE, warning=FALSE, fig.height=7, fig.width=10, fig.fullwidth=TRUE}
beta_q1n$S %>%
  vegan::metaMDS(., trymax = 500, k = 2, trace=0) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %>%
  group_by(broad_environment) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = NMDS1, y = NMDS2, color = broad_environment, shape = as.factor(sex))) +
  geom_point(size = 4) +
  scale_color_manual(values = treatment_colors,labels=c("high" = "High-altitude", "low" = "Low-altitude")) +
  geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9, show.legend = FALSE) +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    panel.background = element_blank(),
    axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.position = "right", legend.box = "vertical"
    ) +
    labs(color="Evironmental context", shape="sex")
```

#### Phylogenetic diversity

```{r beta_div_nmds_phylo_plot, comment="", message=FALSE, warning=FALSE, fig.height=7, fig.width=10, fig.fullwidth=TRUE}
beta_q1p$S %>%
  vegan::metaMDS(., trymax = 500, k = 2, trace=0) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %>%
  group_by(broad_environment) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = NMDS1, y = NMDS2, color = broad_environment, shape = as.factor(sex))) +
  geom_point(size = 4) +
  scale_color_manual(values = treatment_colors,labels=c("high" = "High-altitude", "low" = "Low-altitude")) +
  geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9, show.legend = FALSE) +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    panel.background = element_blank(),
    axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.position = "right", legend.box = "vertical"
    ) +
    labs(color="environment context", shape="sex")+geom_text_repel(aes(label = sample), size=3)
```


#### Functional diversity

```{r beta_div_nmds_funct_plot, comment="", message=FALSE, warning=FALSE, fig.height=7, fig.width=10, fig.fullwidth=TRUE}
beta_q1f$S %>%
  vegan::metaMDS(., trymax = 500, k = 2, trace=0) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %>%
  group_by(broad_environment) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = NMDS1, y = NMDS2, color = broad_environment, shape = as.factor(sex))) +
  geom_point(size = 4) +
  scale_color_manual(values = treatment_colors,labels=c("high" = "High-altitude", "low" = "Low-altitude")) +
  geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9, show.legend = FALSE) +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    panel.background = element_blank(),
    axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.position = "right", legend.box = "vertical"
    ) +
    labs(color="broad_environment", shape="sex")+geom_text_repel(aes(label = sample), size=3)
```


<!--chapter:end:06_Functional_diffrences.Rmd-->

# Gut microbiota: Differential abundance analysis

```{r load_data_mag_filtdamr_diffe, comment="", echo=FALSE, message=FALSE, warning=FALSE}
load("data/data.Rdata")

genome_counts_filt <- genome_counts_filt %>%
  select(one_of(c("genome",sample_metadata$sample))) %>%
  filter(rowSums(. != 0, na.rm = TRUE) > 0) %>%
  select_if(~!all(. == 0))
```

```{r phyloseq, comment="", echo=FALSE, message=FALSE, warning=FALSE}
#Phyloseq object
count_phy <- genome_counts_filt %>%
  column_to_rownames(var="genome")%>%
  otu_table(., taxa_are_rows=T)

sample_info_tab_phy <- sample_metadata%>%
  column_to_rownames(var="sample")%>%
  sample_data()

TAX <- genome_metadata%>%
  column_to_rownames(var="genome")%>%
  select(1:7)%>%
  as.matrix()%>%
  tax_table()
tree <- phy_tree(genome_tree)

physeq_all = phyloseq(count_phy, TAX, sample_info_tab_phy, tree)
```

## Structural zeros
#complett absence of a microbe/genome/function in one group

```{r struct_zero, comment="", echo=FALSE, message=FALSE, warning=FALSE}
Female_samples <- sample_metadata %>% 
  filter(sex == "Female") %>%
  dplyr::select(sample) %>%
  pull()

Male_samples <- sample_metadata %>% 
  filter(sex == "Female") %>%
  dplyr::select(sample) %>% pull()

existing_samples <- colnames(genome_counts_filt)

Female_samples <- Female_samples[Female_samples %in% existing_samples]
Male_samples <- Male_samples[Male_samples %in% existing_samples]



structural_zeros <- genome_counts_filt %>% 
   rowwise() %>% #compute for each row (genome)
   mutate(all_zeros_Female = all(c_across(all_of(Female_samples)) == 0)) %>% # set true if all samples in TJ1 have zeros
   mutate(all_zeros_Male = all(c_across(all_of(Male_samples)) == 0)) %>% # set true if all samples in TJ2 have zeros
   mutate(average_Female = mean(c_across(all_of(Female_samples)), na.rm = TRUE)) %>% # get average genome counts across TJ1
   mutate(average_Male = mean(c_across(all_of(Male_samples)), na.rm = TRUE)) %>% # get average genome counts across TJ2
  
   filter(all_zeros_Female == TRUE || all_zeros_Male==TRUE )  %>% # filter only genomes with structural zeros
   mutate(present = case_when(
      all_zeros_Female & !all_zeros_Male  ~ "Female",
      all_zeros_Female & !all_zeros_Male  ~ "Male",
      TRUE ~ NA_character_
    )) %>%
  mutate(average = case_when(
  present == "Female" ~ average_Female,
  present == "Male" ~ average_Male,
  TRUE ~ NA_real_
))

```

```{r structu_Zero_plot, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
#Get phylum colors from the EHI standard
phylum_colors <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
#  mutate_at(vars(phylum), ~ str_replace(., "[dpcofgs]__", "")) %>%
  right_join(structural_zeros, by=join_by(phylum == phylum)) %>%
  dplyr::select(phylum, colors) %>%
  mutate(colors = str_c(colors, "80"))  %>% #add 80% alpha
  unique() %>%
  arrange(phylum) %>%
  dplyr::select(colors) %>%
  pull()

structural_zeros %>%
    mutate(average = ifelse(present == "Male", average * -1, average)) %>%
  mutate(genome = factor(genome, levels = genome))%>% #convert TJ1 genome counts to negative 
    ggplot(., aes(x=average, y=forcats::fct_reorder(genome,average), fill=phylum)) +
  geom_col()+
#      geom_jitter(height = 0.01, size=3) +
      geom_vline(xintercept=0) + 
      xlim(-max(structural_zeros$average)-3,max(structural_zeros$average)+3) +
      scale_fill_manual(values=phylum_colors) +
      geom_text(aes(-20, 25), label = "Only present\nin Male", color="#666666") +
      geom_text(aes(30, 25), label = "Only present\nin Female", color="#666666") +
     theme(
          panel.background = element_blank(),
        axis.text.y = element_text(size = 6),
          axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"))+
      labs(y="Mags",x="Genome counts") + 
      guides(col=guide_legend("Phylum"))

```


## MAGs in different locations and shared among locations

```{r chart1, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
locationcolors=c('#408892','#c04062')
locationcolors=c('#408892','#c04062')

genome_counts_rel <- genome_counts %>%
  mutate_at(vars(-genome),~./sum(.)) %>%
  column_to_rownames(., "genome")

genome_counts_rel_fil<- genome_counts_filt%>% 
    select(one_of(c("genome",sample_metadata$sample))) %>% 
  column_to_rownames(., "genome")
  
genome_counts_rel_pa=1*(genome_counts_rel_fil>0)
#MAGrel_pa[1:6,1:6]
table_upset_analysis_cont=t(aggregate(t(genome_counts_rel_pa),by=list(sample_metadata$sex),FUN=sum)[,-1])
colnames(table_upset_analysis_cont)=levels(as.factor(sample_metadata$sex))
table_upset_analysis=(table_upset_analysis_cont>0)*1
table_upset_analysis=data.frame(table_upset_analysis)
table_upset_analysis=apply(table_upset_analysis,2,as.integer)
rownames(table_upset_analysis) <- rownames(genome_counts_rel_pa)

#pdf("figures/MAG_intersection.pdf",width=8,height=6, onefile=F)
upset(as.data.frame(table_upset_analysis),
  keep.order = T,
  sets = rev(c("Erlan","Harpea","Leitzaran","Goizueta")),
  sets.bar.color= rev(locationcolors),
  mb.ratio = c(0.55, 0.45), order.by = "freq")
#dev.off()
```

## Enrichment analysis between male and female: Ancombc2

```{r zero_phylo, comment="", echo=FALSE, message=FALSE, warning=FALSE}
#phyloseq object considering structual zeros
phylo_samples <- sample_metadata %>% 
                    column_to_rownames("sample") %>% 
                    sample_data() #convert to phyloseq sample_data object
phylo_genome <- genome_counts_filt %>% 
                    filter(!genome %in% structural_zeros$genome) %>% # remove structural zeros
                    column_to_rownames("genome") %>% 
                    mutate_all(~ replace(., . == 0, 0.00001)) %>% 
                    otu_table(., taxa_are_rows = TRUE)
phylo_taxonomy <- genome_metadata %>% 
                    filter(genome %in% rownames(phylo_genome)) %>% # remove structural zeros
                    mutate(genome2=genome) %>% #create a pseudo genome name column
                    column_to_rownames("genome2") %>% 
                    dplyr::select(domain,phylum,class,order,family,genus,species,genome) %>% #add an additional taxonomic level to ensure genome-level analysis (as no all genomes have species-level taxonomic assignments. Otherwise, ANCOMBC2 aggregates analyses per species)
                    as.matrix() %>% 
                    tax_table() #convert to phyloseq tax_table object

physeq_genome_filtered <- phyloseq(phylo_genome, phylo_taxonomy, phylo_samples)

```

### With random effect
#### MAG level

```{r ancom_rand_pond, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
set.seed(1234) #set seed for reproducibility
ancom_rand_output = ancombc2(data = physeq_genome_filtered, 
                  assay_name = "counts", 
                  tax_level = NULL, #change to agglomerate analysis to a higher taxonomic range
                  fix_formula = "sex", #fixed variable(s)
                  rand_formula = "(1|broad_environment)",
                  p_adj_method = "holm", 
                  pseudo_sens = TRUE,
                  prv_cut =0, 
                  lib_cut = 0, 
                  s0_perc = 0.05,
                  group = NULL, 
                  struc_zero = FALSE, 
                  neg_lb = FALSE,
                  alpha = 0.05, 
                  n_cl = 2, 
                  verbose = TRUE,
                  global = FALSE, 
                  pairwise = FALSE, 
                  dunnet = FALSE, 
                  trend = FALSE,
                  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = lme4::lmerControl(),
                  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100), 
                  trend_control = NULL)

```

```{r ancom_rand, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
taxonomy <- data.frame(physeq_genome_filtered@tax_table) %>%
  rownames_to_column(., "taxon") %>%
  mutate_at(vars(order, phylum, family, genus, species), ~ str_replace(., "[dpcofgs]__", ""))%>%
  mutate(across(c(family,genus, species), na_if, ""))%>%
    mutate(family = coalesce(family, paste('Unclassified', order)),
           genus = coalesce(genus, 
                              if_else(grepl('^Unclassified', family),
                                      family, paste('Unclassified', family))),
           species = coalesce(species, 
                              if_else(grepl('^Unclassified', genus),
                                      genus, paste('Unclassified', genus))))

ancombc_rand_table_mag <- ancom_rand_output$res %>%
  dplyr::select(taxon, lfc_sexMale, p_sexMale) %>%
  filter(p_sexMale < 0.05) %>%
  dplyr::arrange(p_sexMale) %>%
  merge(., taxonomy, by="taxon") %>%
  mutate_at(vars(phylum, species), ~ str_replace(., "[dpcofgs]__", ""))%>%
  dplyr::arrange(lfc_sexMale)

ancombc_rand_table_mag
  
colors_alphabetic <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
  mutate_at(vars(phylum), ~ str_replace(., "[dpcofgs]__", ""))  %>%
  right_join(taxonomy, by=join_by(phylum == phylum)) %>%
  dplyr::select(phylum, colors) %>%
  mutate(colors = str_c(colors, "80"))  %>% #add 80% alpha
	unique() %>%
	dplyr::arrange(phylum)

tax_table <- as.data.frame(unique(ancombc_rand_table_mag$phylum))
  
colnames(tax_table)[1] <- "phylum"
tax_color <- merge(tax_table, colors_alphabetic, by="phylum")%>%
	dplyr::arrange(phylum) %>%
	dplyr::select(colors) %>%
	pull()
```
```{r ancombc_rand_plot_phy, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=8, fig.fullwidth=TRUE, eval = FALSE}
ancombc_rand_table_mag%>%
      mutate(genome=factor(genome,levels=ancombc_rand_table_mag$genome)) %>%
ggplot(., aes(x=lfc_sexMale, y=forcats::fct_reorder(genome,lfc_sexMale), fill=phylum)) + #forcats::fct_rev()
  geom_col() + 
  scale_fill_manual(values=tax_color) + 
  geom_hline(yintercept=0) + 
#  coord_flip()+
  theme(panel.background = element_blank(),
        axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 8),
        axis.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14, face = "bold"),
        legend.position = "right", legend.box = "vertical")+
  xlab("log2FoldChange") + 
  ylab("Species")+
  guides(fill=guide_legend(title="Phylum"))
```


```{r ancom_rand_volcano, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
phylum_colors <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
    right_join(genome_metadata, by=join_by(phylum == phylum)) %>%
    arrange(match(genome, genome_tree$tip.label)) %>%
    select(phylum, colors) %>%
    unique() %>%
    arrange(phylum) %>%
    pull(colors, name=phylum)

#pdf("figures/different_species_StrucZero_new_violin.pdf",width=12, height=6)
ancom_rand_output$res %>%
  na.omit() %>%
  dplyr::select(genome=taxon, lfc_sexMale, p_sexMale) %>%
  left_join(genome_metadata, by = join_by(genome == genome)) %>%
  mutate(phylum = ifelse(p_sexMale < 0.05, phylum, NA)) %>%
  ggplot(., aes(x = lfc_sexMale, y = -log(p_sexMale), color = phylum)) +
  geom_point(size=3, show.legend = FALSE) +
  #xlim(c(-10,4)) +
  scale_color_manual(values = phylum_colors) +
  labs(color = "Significant phylum", x = "Log-fold difference between sample types", y = "p-value") +
  theme_classic()
#dev.off()
```

##### Controling structural components in Ancombc
```{r ancom_rand_season, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
set.seed(1234) #set seed for reproducibility
ancom_rand_output_mag_Struc = ancombc2(data = physeq_all, 
                  assay_name = "counts", 
                  tax_level = NULL,
                  fix_formula = "sex",
                  rand_formula = "(1|broad_environment)",
                  p_adj_method = "holm", 
                  pseudo_sens = TRUE,
                  prv_cut =0, 
                  lib_cut = 0, 
                  s0_perc = 0.05,
                  group = "sex", 
                  struc_zero = TRUE, 
                  neg_lb = FALSE,
                  alpha = 0.05, 
                  n_cl = 2, 
                  verbose = TRUE,
                  global = FALSE, 
                  pairwise = FALSE, 
                  dunnet = FALSE, 
                  trend = FALSE,
                  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = lme4::lmerControl(),
                  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100), 
                  trend_control = NULL)

```

```{r ancom_rand1, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
taxonomy <- data.frame(physeq_genome_filtered@tax_table) %>%
  rownames_to_column(., "taxon")%>%
  mutate_at(vars(order, phylum, family, genus, species), ~ str_replace(., "[dpcofgs]__", ""))

ancombc_rand_table_mag_Struc <- ancom_rand_output_mag_Struc$res %>%
  dplyr::select(taxon, lfc_sexMale, p_sexMale) %>%
  filter(p_sexMale < 0.05) %>%
  dplyr::arrange(p_sexMale) %>%
  merge(., taxonomy, by="taxon") %>%
  mutate_at(vars(phylum, species), ~ str_replace(., "[dpcofgs]__", ""))%>%
  dplyr::arrange(lfc_sexMale)

ancombc_rand_table_mag_Struc

colors_alphabetic <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
  mutate_at(vars(phylum), ~ str_replace(., "[dpcofgs]__", ""))  %>%
  right_join(taxonomy, by=join_by(phylum == phylum)) %>%
  dplyr::select(phylum, colors) %>%
  mutate(colors = str_c(colors, "80"))  %>% #add 80% alpha
	unique() %>%
	dplyr::arrange(phylum)

tax_table <- as.data.frame(unique(ancombc_rand_table_mag_Struc$phylum))
  
  
colnames(tax_table)[1] <- "phylum"
tax_color <- merge(tax_table, colors_alphabetic, by="phylum")%>%
	dplyr::arrange(phylum) %>%
	dplyr::select(colors) %>%
	pull()
```
```{r ancombc_rand_plot_mag, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=8, fig.fullwidth=TRUE, eval = FALSE}
ancombc_rand_table_mag_Struc%>%
      mutate(genome=factor(genome,levels=ancombc_rand_table_mag_Struc$genome)) %>%
ggplot(., aes(x=lfc_sexMale, y=forcats::fct_reorder(genome,lfc_sexMale), fill=phylum)) + #forcats::fct_rev()
  geom_col() + 
  scale_fill_manual(values=tax_color) + 
  geom_hline(yintercept=0) + 
#  coord_flip()+
  theme(panel.background = element_blank(),
        axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 8),
        axis.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14, face = "bold"),
        legend.position = "right", legend.box = "vertical")+
  xlab("log2FoldChange") + 
  ylab("Species")+
  guides(fill=guide_legend(title="Phylum"))
```

```{r ancom_rand_volcano_mag, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
phylum_colors <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
    right_join(genome_metadata, by=join_by(phylum == phylum)) %>%
    arrange(match(genome, genome_tree$tip.label)) %>%
    select(phylum, colors) %>%
    unique() %>%
    arrange(phylum) %>%
    pull(colors, name=phylum)

#pdf("figures/different_species_StrucZero_new_violin.pdf",width=12, height=6)
ancom_rand_output_mag_Struc$res %>%
  na.omit() %>%
  dplyr::select(genome=taxon, lfc_sexMale, p_sexMale) %>%
  left_join(genome_metadata, by = join_by(genome == genome)) %>%
  mutate(phylum = ifelse(p_sexMale < 0.05, phylum, NA)) %>%
  ggplot(., aes(x = lfc_sexMale, y = -log(p_sexMale), color = phylum)) +
  geom_point(size=3, show.legend = FALSE) +
  #xlim(c(-10,4)) +
  scale_color_manual(values = phylum_colors) +
  labs(color = "Significant phylum", x = "Log-fold difference between sample types", y = "p-value") +
  theme_classic()
#dev.off()
```

#### Phylum level

```{r ancom_phylum, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
ancom_rand_output_phylum = ancombc2(data = physeq_genome_filtered, 
                  assay_name = "counts", 
                  tax_level = "phylum", #change to agglomerate analysis to a higher taxonomic range
                  fix_formula = "sex", #fixed variable(s)
                  rand_formula = "(1|broad_environment)",
                  p_adj_method = "holm", 
                  pseudo_sens = TRUE,
                  prv_cut = 0, 
                  lib_cut = 0, 
                  s0_perc = 0.05,
                  group = NULL, 
                  struc_zero = FALSE, 
                  neg_lb = FALSE,
                  alpha = 0.05, 
                  n_cl = 2, 
                  verbose = TRUE,
                  global = FALSE, 
                  pairwise = FALSE, 
                  dunnet = FALSE, 
                  trend = FALSE,
                  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = lme4::lmerControl(),
                  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100), 
                  trend_control = NULL)
```

```{r ancom_rand_phylum, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
ancom_rand_output_phylum$res %>%
  dplyr::select(taxon, lfc_sexMale, p_sexMale) %>%
  filter(p_sexMale < 0.05) %>%
  dplyr::arrange(p_sexMale) 
```

#### Family level
```{r ancom_family, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
ancom_rand_output_family = ancombc2(data = physeq_genome_filtered, 
                  assay_name = "counts", 
                  tax_level = "family", #change to agglomerate analysis to a higher taxonomic range
                  fix_formula = "sex", #fixed variable(s)
                  rand_formula = "(1|broad_environment)",
                  p_adj_method = "holm", 
                  pseudo_sens = TRUE,
                  prv_cut = 0, 
                  lib_cut = 0, 
                  s0_perc = 0.05,
                  group = NULL, 
                  struc_zero = FALSE, 
                  neg_lb = FALSE,
                  alpha = 0.05, 
                  n_cl = 2, 
                  verbose = TRUE,
                  global = FALSE, 
                  pairwise = FALSE, 
                  dunnet = FALSE, 
                  trend = FALSE,
                  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = lme4::lmerControl(),
                  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100), 
                  trend_control = NULL)
```

```{r ancom_rand_family, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
ancom_rand_output_family$res %>%
  dplyr::select(taxon, lfc_sexMale, p_sexMale) %>%
  filter(p_sexMale < 0.05) %>%
  dplyr::arrange(p_sexMale) 
```

#### Genera
```{r ancom_genera, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
ancom_rand_output_gen = ancombc2(data = physeq_genome_filtered, 
                  assay_name = "counts", 
                  tax_level = "genus", #change to agglomerate analysis to a higher taxonomic range
                  fix_formula = "sex", #fixed variable(s)
                  rand_formula = "(1|broad_environment)",
                  p_adj_method = "holm", 
                  pseudo_sens = TRUE,
                  prv_cut = 0, 
                  lib_cut = 0, 
                  s0_perc = 0.05,
                  group = NULL, 
                  struc_zero = FALSE, 
                  neg_lb = FALSE,
                  alpha = 0.05, 
                  n_cl = 2, 
                  verbose = TRUE,
                  global = FALSE, 
                  pairwise = FALSE, 
                  dunnet = FALSE, 
                  trend = FALSE,
                  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = lme4::lmerControl(),
                  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100), 
                  trend_control = NULL)
```

```{r ancom_rand_genera, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
ancom_rand_output_gen$res %>%
  dplyr::select(taxon, lfc_sexMale, p_sexMale) %>%
  filter(p_sexMale < 0.05) %>%
  dplyr::arrange(p_sexMale) 
```



### Without random effect
#### MAG level

```{r ancom_rand_pond2, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
set.seed(1234) #set seed for reproducibility
ancom_rand_output_norand = ancombc2(data = physeq_genome_filtered, 
                  assay_name = "counts", 
                  tax_level = NULL, #change to agglomerate analysis to a higher taxonomic range
                  fix_formula = "sex", #fixed variable(s)
 #                 rand_formula = "(1|broad_environment)",
                  p_adj_method = "holm", 
                  pseudo_sens = TRUE,
                  prv_cut =0, 
                  lib_cut = 0, 
                  s0_perc = 0.05,
                  group = NULL, 
                  struc_zero = FALSE, 
                  neg_lb = FALSE,
                  alpha = 0.05, 
                  n_cl = 2, 
                  verbose = TRUE,
                  global = FALSE, 
                  pairwise = FALSE, 
                  dunnet = FALSE, 
                  trend = FALSE,
                  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = NULL,
                  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100), 
                  trend_control = NULL)

```

```{r ancom_rand2, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
taxonomy <- data.frame(physeq_genome_filtered@tax_table) %>%
  rownames_to_column(., "taxon") %>%
  mutate_at(vars(order, phylum, family, genus, species), ~ str_replace(., "[dpcofgs]__", ""))%>%
  mutate(across(c(family,genus, species), na_if, ""))%>%
    mutate(family = coalesce(family, paste('Unclassified', order)),
           genus = coalesce(genus, 
                              if_else(grepl('^Unclassified', family),
                                      family, paste('Unclassified', family))),
           species = coalesce(species, 
                              if_else(grepl('^Unclassified', genus),
                                      genus, paste('Unclassified', genus))))

ancombc_rand_table_mag_norand <- ancom_rand_output_norand$res %>%
  dplyr::select(taxon, lfc_sexMale, p_sexMale) %>%
  filter(p_sexMale < 0.05) %>%
  dplyr::arrange(p_sexMale) %>%
  merge(., taxonomy, by="taxon") %>%
  mutate_at(vars(phylum, species), ~ str_replace(., "[dpcofgs]__", ""))%>%
  dplyr::arrange(lfc_sexMale)
  
colors_alphabetic <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
  mutate_at(vars(phylum), ~ str_replace(., "[dpcofgs]__", ""))  %>%
  right_join(taxonomy, by=join_by(phylum == phylum)) %>%
  dplyr::select(phylum, colors) %>%
  mutate(colors = str_c(colors, "80"))  %>% #add 80% alpha
	unique() %>%
	dplyr::arrange(phylum)

tax_table <- as.data.frame(unique(ancombc_rand_table_mag_norand$phylum))
  
  
colnames(tax_table)[1] <- "phylum"
tax_color <- merge(tax_table, colors_alphabetic, by="phylum")%>%
	dplyr::arrange(phylum) %>%
	dplyr::select(colors) %>%
	pull()
```

```{r ancombc_rand_plot_mag2, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=8, fig.fullwidth=TRUE, eval = FALSE}
ancombc_rand_table_mag_norand%>%
      mutate(genome=factor(genome,levels=ancombc_rand_table_mag_norand$genome)) %>%
ggplot(., aes(x=lfc_sexMale, y=forcats::fct_reorder(genome,lfc_sexMale), fill=phylum)) + #forcats::fct_rev()
  geom_col() + 
  scale_fill_manual(values=tax_color) + 
  geom_hline(yintercept=0) + 
#  coord_flip()+
  theme(panel.background = element_blank(),
        axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 8),
        axis.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14, face = "bold"),
        legend.position = "right", legend.box = "vertical")+
  xlab("log2FoldChange") + 
  ylab("Species")+
  guides(fill=guide_legend(title="Phylum"))
```


```{r ancom_rand_volcano2, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
phylum_colors <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
    right_join(genome_metadata, by=join_by(phylum == phylum)) %>%
    arrange(match(genome, genome_tree$tip.label)) %>%
    select(phylum, colors) %>%
    unique() %>%
    arrange(phylum) %>%
    pull(colors, name=phylum)

#pdf("figures/different_species_StrucZero_new_violin.pdf",width=12, height=6)
ancom_rand_output_norand$res %>%
  na.omit() %>%
  dplyr::select(genome=taxon, lfc_sexMale, p_sexMale) %>%
  left_join(genome_metadata, by = join_by(genome == genome)) %>%
  mutate(phylum = ifelse(p_sexMale < 0.05, phylum, NA)) %>%
  ggplot(., aes(x = lfc_sexMale, y = -log(p_sexMale), color = phylum)) +
  geom_point(size=3, show.legend = FALSE) +
  #xlim(c(-10,4)) +
  scale_color_manual(values = phylum_colors) +
  labs(color = "Significant phylum", x = "Log-fold difference between sample types", y = "p-value") +
  theme_classic()
#dev.off()
```

##### Controling structural components in Ancombc
```{r ancom_rand_struct12, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
ancom_rand_output_mag_Struc_norand = ancombc2(data = physeq_all, 
                  assay_name = "counts", 
                  tax_level = NULL, #change to agglomerate analysis to a higher taxonomic range
                  fix_formula = "sex", #fixed variable(s)
 #                 rand_formula = "(1|broad_environment)",
                  p_adj_method = "holm", 
                  pseudo_sens = TRUE,
                  prv_cut =0, 
                  lib_cut = 0, 
                  s0_perc = 0.05,
                  group = "sex", 
                  struc_zero = TRUE, 
                  neg_lb = FALSE,
                  alpha = 0.05, 
                  n_cl = 2, 
                  verbose = TRUE,
                  global = FALSE, 
                  pairwise = FALSE, 
                  dunnet = FALSE, 
                  trend = FALSE,
                  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = NULL,
                  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100), 
                  trend_control = NULL)

```

```{r ancom_rand12, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
taxonomy <- data.frame(physeq_genome_filtered@tax_table) %>%
  rownames_to_column(., "taxon")%>%
  mutate_at(vars(order, phylum, family, genus, species), ~ str_replace(., "[dpcofgs]__", ""))%>%
  mutate(across(c(family,genus, species), na_if, ""))

ancombc_rand_table_mag_Struc_norand <- ancom_rand_output_mag_Struc_norand$res %>%
  dplyr::select(taxon, lfc_sexMale, p_sexMale) %>%
  filter(p_sexMale < 0.05) %>%
  dplyr::arrange(p_sexMale) %>%
  merge(., taxonomy, by="taxon") %>%
  mutate_at(vars(phylum, species), ~ str_replace(., "[dpcofgs]__", ""))%>%
  dplyr::arrange(lfc_sexMale)
  
colors_alphabetic <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
  mutate_at(vars(phylum), ~ str_replace(., "[dpcofgs]__", ""))  %>%
  right_join(taxonomy, by=join_by(phylum == phylum)) %>%
  dplyr::select(phylum, colors) %>%
  mutate(colors = str_c(colors, "80"))  %>% #add 80% alpha
	unique() %>%
	dplyr::arrange(phylum)

tax_table <- as.data.frame(unique(ancombc_rand_table_mag_Struc_norand$phylum))
  
  
colnames(tax_table)[1] <- "phylum"
tax_color <- merge(tax_table, colors_alphabetic, by="phylum")%>%
	dplyr::arrange(phylum) %>%
	dplyr::select(colors) %>%
	pull()
```

```{r ancombc_rand_plot_mag12, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=8, fig.fullwidth=TRUE, eval = FALSE}
ancombc_rand_table_mag_Struc_norand%>%
      mutate(genome=factor(genome,levels=ancombc_rand_table_mag_Struc_norand$genome)) %>%
ggplot(., aes(x=lfc_sexMale, y=forcats::fct_reorder(genome,lfc_sexMale), fill=phylum)) + #forcats::fct_rev()
  geom_col() + 
  scale_fill_manual(values=tax_color) + 
  geom_hline(yintercept=0) + 
#  coord_flip()+
  theme(panel.background = element_blank(),
        axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 8),
        axis.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14, face = "bold"),
        legend.position = "right", legend.box = "vertical")+
  xlab("log2FoldChange") + 
  ylab("Species")+
  guides(fill=guide_legend(title="Phylum"))
```

```{r ancom_rand_volcano_mag12, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
phylum_colors <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
    right_join(genome_metadata, by=join_by(phylum == phylum)) %>%
    arrange(match(genome, genome_tree$tip.label)) %>%
    select(phylum, colors) %>%
    unique() %>%
    arrange(phylum) %>%
    pull(colors, name=phylum)

#pdf("figures/different_species_StrucZero_new_violin.pdf",width=12, height=6)
ancom_rand_output_mag_Struc_norand$res %>%
  na.omit() %>%
  dplyr::select(genome=taxon, lfc_sexMale, p_sexMale) %>%
  left_join(genome_metadata, by = join_by(genome == genome)) %>%
  mutate(phylum = ifelse(p_sexMale < 0.05, phylum, NA)) %>%
  ggplot(., aes(x = lfc_sexMale, y = -log(p_sexMale), color = phylum)) +
  geom_point(size=3, show.legend = FALSE) +
  #xlim(c(-10,4)) +
  scale_color_manual(values = phylum_colors) +
  labs(color = "Significant phylum", x = "Log-fold difference between sample types", y = "p-value") +
  theme_classic()
#dev.off()
```

### Phylum level

```{r ancom_phylum2, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
ancom_rand_output_phylum_norand = ancombc2(data = physeq_genome_filtered, 
                  assay_name = "counts", 
                  tax_level = "phylum", #change to agglomerate analysis to a higher taxonomic range
                  fix_formula = "sex", #fixed variable(s)
  #                rand_formula = "(1|broad_environment)",
                  p_adj_method = "holm", 
                  pseudo_sens = TRUE,
                  prv_cut = 0, 
                  lib_cut = 0, 
                  s0_perc = 0.05,
                  group = NULL, 
                  struc_zero = FALSE, 
                  neg_lb = FALSE,
                  alpha = 0.05, 
                  n_cl = 2, 
                  verbose = TRUE,
                  global = FALSE, 
                  pairwise = FALSE, 
                  dunnet = FALSE, 
                  trend = FALSE,
                  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = NULL,
                  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100), 
                  trend_control = NULL)
```

```{r ancom_rand_phylum2, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
ancom_rand_output_phylum_norand$res %>%
  dplyr::select(taxon, lfc_sexMale, p_sexMale) %>%
  filter(p_sexMale < 0.05) %>%
  dplyr::arrange(p_sexMale) 
```

### Family level
```{r ancom_family2, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
ancom_rand_output_family_norand = ancombc2(data = physeq_genome_filtered, 
                  assay_name = "counts", 
                  tax_level = "family", #change to agglomerate analysis to a higher taxonomic range
                  fix_formula = "sex", #fixed variable(s)
   #               rand_formula = "(1|broad_environment)",
                  p_adj_method = "holm", 
                  pseudo_sens = TRUE,
                  prv_cut = 0, 
                  lib_cut = 0, 
                  s0_perc = 0.05,
                  group = NULL, 
                  struc_zero = FALSE, 
                  neg_lb = FALSE,
                  alpha = 0.05, 
                  n_cl = 2, 
                  verbose = TRUE,
                  global = FALSE, 
                  pairwise = FALSE, 
                  dunnet = FALSE, 
                  trend = FALSE,
                  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = NULL,
                  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100), 
                  trend_control = NULL)
```

```{r ancom_rand_family2, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
ancom_rand_output_family_norand$res %>%
  dplyr::select(taxon, lfc_sexMale, p_sexMale) %>%
  filter(p_sexMale < 0.05) %>%
  dplyr::arrange(p_sexMale) 
```

### Genera
```{r ancom_genera2, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
ancom_rand_output_gen_norand = ancombc2(data = physeq_genome_filtered, 
                  assay_name = "counts", 
                  tax_level = "genus", #change to agglomerate analysis to a higher taxonomic range
                  fix_formula = "sex", #fixed variable(s)
 #                 rand_formula = "(1|broad_environment)",
                  p_adj_method = "holm", 
                  pseudo_sens = TRUE,
                  prv_cut = 0, 
                  lib_cut = 0, 
                  s0_perc = 0.05,
                  group = NULL, 
                  struc_zero = FALSE, 
                  neg_lb = FALSE,
                  alpha = 0.05, 
                  n_cl = 2, 
                  verbose = TRUE,
                  global = FALSE, 
                  pairwise = FALSE, 
                  dunnet = FALSE, 
                  trend = FALSE,
                  iter_control = list(tol = 1e-5, max_iter = 20, verbose = FALSE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = NULL,
                  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100), 
                  trend_control = NULL)
```

```{r ancom_rand_genera2, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
ancom_rand_output_gen_norand$res %>%
  dplyr::select(taxon, lfc_sexMale, p_sexMale) %>%
  filter(p_sexMale < 0.05) %>%
  dplyr::arrange(p_sexMale) 
```

```{r ancom_save, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
save(ancom_rand_output,
     ancom_rand_output_mag_Struc,
     ancom_rand_output_phylum,
     ancom_rand_output_family,
     ancom_rand_output_gen,
     ancom_rand_output_norand,
     ancom_rand_output_mag_Struc_norand,
     ancom_rand_output_phylum_norand,
     ancom_rand_output_family_norand,
     ancom_rand_output_gen_norand,
     file="data/ancombc_all.Rdata")
```

<!--chapter:end:07_microbiota_abundance_analysis_sex.Rmd-->


# Gut microbiota: functional analysis

```{r load_data_func,comment="", echo=FALSE, message=FALSE, warning=FALSE}
load("data/data.Rdata")

sample_metadata$sex <- factor(sample_metadata$sex, levels=c("Male", "Female"))
treatment_colors <- c("#f56042","#429ef5")
genome_counts_filt <- genome_counts_filt[genome_counts_filt$genome %in% rownames(genome_gifts),] 
rownames(genome_counts_filt) <- NULL

```

```{r gift, comment="", echo=FALSE, message=FALSE, warning=FALSE}
#Aggregate bundle-level GIFTs into the compound level
GIFTs_elements <- to.elements(genome_gifts,GIFT_db)
GIFTs_elements_filtered <- GIFTs_elements[rownames(GIFTs_elements) %in% genome_counts_filt$genome,]
GIFTs_elements_filtered <- as.data.frame(GIFTs_elements_filtered) %>% 
  select_if(~ !is.numeric(.) || sum(.) != 0)

#Aggregate element-level GIFTs into the function level
GIFTs_functions <- to.functions(GIFTs_elements_filtered,GIFT_db)

#Aggregate function-level GIFTs into overall Biosynthesis, Degradation and Structural GIFTs
GIFTs_domains <- to.domains(GIFTs_functions,GIFT_db)

#Get community-weighed average GIFTs per sample
genome_counts_row <- genome_counts_filt %>%
  mutate_at(vars(-genome),~./sum(.)) %>% 
  column_to_rownames(., "genome") 
#genome_counts_row <- rownames_to_column(genome_counts_row, "genome")
GIFTs_elements_community <- to.community(GIFTs_elements_filtered,genome_counts_row,GIFT_db)
GIFTs_functions_community <- to.community(GIFTs_functions,genome_counts_row,GIFT_db)
GIFTs_domains_community <- to.community(GIFTs_domains,genome_counts_row,GIFT_db)
```

## MCI
```{r gitfs_functional_wild, echo=TRUE,results=TRUE}
GIFTs_functions_community %>%
  rowMeans() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(sample_metadata, by = join_by(sample == sample)) %>%
#  filter(time_point=="0_Wild") %>%
  group_by(sex) %>%
  summarise(MCI = mean(value), sd = sd(value))

MCI <- GIFTs_functions_community %>%
  rowMeans() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(sample_metadata, by = join_by(sample == sample)) 
# %>% 
#   filter(diet!="Post_grass")

shapiro.test(MCI$value)
wilcox.test(value ~ sex, data=MCI)

```

```{r comunity_elem_plot, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=12, fig.width=10, fig.fullwidth=TRUE}
GIFTs_elements_community %>%
    as.data.frame() %>%
    rownames_to_column(var="sample")%>%
    pivot_longer(!sample,names_to="trait",values_to="gift") %>%
    left_join(sample_metadata, by = join_by(sample == sample)) %>%
    mutate(functionid = substr(trait, 1, 3)) %>%
    mutate(trait = case_when(
      trait %in% GIFT_db$Code_element ~ GIFT_db$Element[match(trait, GIFT_db$Code_element)],
      TRUE ~ trait
    )) %>%
    mutate(functionid = case_when(
      functionid %in% GIFT_db$Code_function ~ GIFT_db$Function[match(functionid, GIFT_db$Code_function)],
      TRUE ~ functionid
    )) %>%
    mutate(trait=factor(trait,levels=unique(GIFT_db$Element))) %>%
    mutate(functionid=factor(functionid,levels=unique(GIFT_db$Function))) %>%
    ggplot(aes(x=sample,y=trait,fill=gift)) +
        geom_tile(colour="white", linewidth=0.2)+
        scale_fill_gradientn(colours=rev(c("#d53e4f", "#f46d43", "#fdae61", "#fee08b", "#e6f598", "#abdda4", "#ddf1da")))+
        facet_grid(functionid ~ sex, scales="free",space="free") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
              axis.text.y = element_text(size=8),
              strip.text.y = element_text(angle = 0)
              ) +
        labs(y="Traits",x="Samples",fill="GIFT")
```
```{r comunity_funct_plot, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
unique_funct_db<- GIFT_db[c(3,4,5)] %>% 
  distinct(Code_function, .keep_all = TRUE)

GIFTs_functions_community %>%
   t() %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Code_function")  %>%
  left_join(.,unique_funct_db[c(1,3)],by = join_by(Code_function == Code_function))  %>%
  select(-Code_function) %>%
  column_to_rownames(., "Function")%>%
   t()  %>%
    as.data.frame() %>%
    rownames_to_column(var="sample") %>%
    pivot_longer(!sample,names_to="trait",values_to="gift") %>%
    left_join(sample_metadata, by = join_by(sample == sample)) %>%
    ggplot(aes(x=trait,y=sample,fill=gift)) +
        geom_tile(colour="white", linewidth=0.2)+
        scale_fill_gradientn(colours=rev(c("#d53e4f", "#f46d43", "#fdae61", "#fee08b", "#e6f598", "#abdda4", "#ddf1da")))+
        facet_grid(sex ~ ., scales="free",space="free")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10),
        axis.text.y = element_text(size=8),
        strip.background = element_blank(),
        strip.text = element_text(size = 12, color="black",face="bold"),
        axis.title = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0)),
        panel.background= element_blank()
              ) +
        labs(x="Function", y="Sample",fill="GIFT")
```

```{r comunity_dom_plot, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
GIFTs_domains_community %>%
    as.data.frame() %>%
    rownames_to_column(var="sample") %>%
    pivot_longer(!sample,names_to="trait",values_to="gift") %>%
    left_join(sample_metadata, by = join_by(sample == sample)) %>%
    ggplot(aes(x=trait,y=sample,fill=gift)) +
        geom_tile(colour="white", linewidth=0.2)+
        scale_fill_gradientn(colours=rev(c("#d53e4f", "#f46d43", "#fdae61", "#fee08b", "#e6f598", "#abdda4", "#ddf1da")))+
        facet_grid(sex ~ ., scales="free",space="free")+
  theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size=8),
        strip.background = element_blank(),
        strip.text = element_text(size = 12, color="black",face="bold"),
        axis.title = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0)),
        panel.background= element_blank()
        ) +
        labs(x="Function", y="Sample",fill="GIFT")
```

## Wilcoxon

### Community elements differences:
```{r comunity_elem, comment="", echo=FALSE, message=FALSE, warning=FALSE}
element_gift <- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "sample") %>% 
  left_join(sample_metadata %>% select(sample,sex, broad_environment), by=join_by("sample"=="sample"))
```

```{r commun_wilcox_elem, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
uniqueGIFT_db<- unique(GIFT_db[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements <- element_gift %>%
    pivot_longer(-c(sample,sex, broad_environment), names_to = "trait", values_to = "value") %>%
    group_by(trait) %>%
    summarise(p_value = wilcox.test(value ~ sex)$p.value) %>%
    mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
    filter(p_adjust < 0.05)%>%
  rownames_to_column(., "Elements")  %>%
  left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element))

element_gift_t <- element_gift  %>% 
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "trait")

element_gift_filt <- subset(element_gift_t, trait %in% significant_elements$trait) %>% 
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric) %>%
  rownames_to_column(., "sample") %>%
  left_join(sample_metadata %>% select(sample, sex, broad_environment), by = join_by(sample == sample)) %>%
  filter(!is.na(sex)) 

element_gift_filt %>%
  select(-c(sample,broad_environment))%>%
  group_by(sex) %>%
  summarise(across(everything(), mean))%>%
   t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Elements")  %>%
  left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(Elements == Code_element))

difference_table <- element_gift_filt %>%
  select(-sample) %>%
  group_by(sex) %>%
  summarise(across(everything(), mean)) %>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric) %>%
  rownames_to_column(., "Elements") %>%
    left_join(.,uniqueGIFT_db[c(1,3,4)],by = join_by(Elements == Code_element)) %>% 
  arrange(Function) %>% 
  mutate(Difference=Female-Male)%>% 
  mutate(group_color = ifelse(Difference <0, "Male","Female")) 

```

```{r log_fold_calc, comment="", echo=FALSE, message=FALSE, warning=FALSE}
means_gift <- element_gift_filt %>% 
  select(-c(sex,broad_environment)) %>% 
  pivot_longer(!sample, names_to = "elements", values_to = "abundance") %>% 
  left_join(sample_metadata, by=join_by(sample==sample)) %>% 
  group_by(sex, elements) %>%
  summarise(mean=mean(abundance))

log_fold <- means_gift %>%
  group_by(elements) %>%
  summarise(
    logfc_high_low = log2(mean[sex == "Male"] / mean[sex == "Female"])
    )
```

```{r elements_plot, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
element_gift_names <- element_gift_filt%>%
  select(-c(sex,broad_environment)) %>%
   t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Elements")  %>%
  left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(Elements == Code_element))%>%
  select(-Elements)%>%
  select(Function, everything())%>%
   t()%>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "sample")%>% 
  left_join(sample_metadata %>% select(sample,sex,broad_environment), by = join_by(sample == sample))



colNames <- names(element_gift_names %>% select(-c(sample,sex,broad_environment)))
for(i in colNames){
  plt <- ggplot(element_gift_names, aes(x=sex, y=.data[[i]], color = sex, fill=sex)) +
    geom_boxplot(alpha = 0.2, outlier.shape = NA, width = 0.3, show.legend = FALSE) +
    geom_jitter(width = 0.1, show.legend = TRUE) +
  scale_color_manual(values=treatment_colors)+
  scale_fill_manual(values=treatment_colors) +
  theme_minimal() +
  theme(
    axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())
print(plt)
}
```
```{r commun_wilcox_elem_plot_gut, comment="", message=FALSE, warning=FALSE, fig.height=6, fig.width=12, fig.fullwidth=TRUE, eval=FALSE}
difference_table %>%
  ggplot(aes(x=forcats::fct_reorder(Function,Difference), y=Difference, fill=group_color)) + 
  geom_col() +
#  geom_point(size=4) + 
  scale_fill_manual(values=treatment_colors) +
  geom_hline(yintercept=0) + 
  coord_flip()+
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12),
        legend.position = "right", 
        panel.background = element_blank(),
          panel.grid.major = element_line(size = 0.15, linetype = 'solid',
                                colour = "grey"))+
  xlab("Microbial Functional Capacity") + 
  ylab("Mean difference")+
  labs(fill="Elevation")
```


```{r plot3, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=14, fig.fullwidth=TRUE}

uniqueGIFT <- unique(GIFT_db[c(2,3,4,5,6)])

code_function <- difference_table %>%
  left_join(uniqueGIFT[c(1:3)], by=join_by(Elements==Code_element))

unique_codes<-unique(code_function$Code_function)

gift_colors <- read_tsv("data/gift_colors.tsv") %>% 
  filter(Code_function %in% unique_codes)%>% 
  mutate(legend=str_c(Code_function," - ",Function))

code_function %>%
#  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements, by=join_by(Elements==trait)) %>%
  left_join(log_fold, by=join_by(Elements==elements)) %>% 
  left_join(gift_colors, by=join_by(Code_function==Code_function)) %>% 
  ggplot(., aes(x = logfc_high_low, y = -log(p_adjust), color=legend, size=abs(Difference))) +
  geom_jitter(width = 0.2, height = 0.2)+
  geom_vline(xintercept=0) +
  scale_color_manual(values = gift_colors$Color)+
  #xlim(c(-10,4)) +
  theme_classic()+
  labs(size="Mean difference (abs)", color="Functional trait")+
  labs(x = "Log-fold change", y="-Log adjusted p-value") +
  geom_text_repel(aes(label = Element), min.segment.length = 0.4, size=2.5, max.overlaps = Inf)
```

### Community functions differences

```{r comunity_func_gut, comment="", message=FALSE, warning=FALSE}
function_gift <- GIFTs_functions_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "sample") %>% 
  merge(., sample_metadata %>% select(sample,sex,broad_environment), by="sample")
```

```{r commun_wilcox_func_gut, comment="", message=FALSE, warning=FALSE, eval = FALSE}
unique_funct_db<- GIFT_db[c(3,4,5)] %>% 
  distinct(Code_function, .keep_all = TRUE)

significant_functional <- function_gift %>%
    pivot_longer(-c(sample,sex,broad_environment), names_to = "trait", values_to = "value") %>%
    group_by(trait) %>%
    summarise(p_value = wilcox.test(value ~ sex)$p.value) %>%
    mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
    filter(p_adjust < 0.05)%>%
  left_join(.,unique_funct_db[c(1,3)],by = join_by(trait == Code_function))
```

```{r  function_sig_gut, comment="", message=FALSE, warning=FALSE, eval=FALSE}
function_gift_t <- function_gift  %>% 
  select(-sex)  %>% 
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "trait")

function_gift_filt <- subset(function_gift_t, trait %in% significant_functional$trait) %>% 
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "sample")%>% 
  left_join(., sample_metadata %>% select(sample,sex,broad_environment), by = join_by(sample == sample)) %>%
  filter(!is.na(sex))

function_gift_filt %>%
  select(-c(sample,broad_environment)) %>%
  group_by(sex)  %>%
  summarise(across(everything(), mean))%>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Code_function")  %>%
  left_join(unique_funct_db[c(1,3)],by = join_by(Code_function == Code_function))
```

```{r function_plot_gut, comment="", message=FALSE, warning=FALSE, eval = FALSE}
function_gift_names <- function_gift_filt%>%
  select(-c(sex,broad_environment)) %>%
   t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Code_function")  %>%
  left_join(.,unique_funct_db[c(1,3)],by = join_by(Code_function == Code_function))%>%
  select(-Code_function)%>%
  select(Function, everything())%>%
   t()%>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "sample")%>% 
  left_join(sample_metadata %>% select(sample,sex,broad_environment), by = join_by(sample == sample))


colNames <- names(function_gift_names)[2]
for(i in colNames){
  plt <- ggplot(function_gift_names, aes(x=sex, y=.data[[i]], color = sex, fill=sex)) +
    geom_boxplot(alpha = 0.2, outlier.shape = NA, width = 0.3, show.legend = FALSE) +
  geom_jitter(width = 0.1, show.legend = TRUE) +
    scale_color_manual(values=treatment_colors)+
    scale_fill_manual(values=treatment_colors)+
  theme_minimal() +
  theme(
    axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())
print(plt)
}
```

### Community domains differences

```{r comunity_dom_gut, comment="", message=FALSE, warning=FALSE}
domain_gift <- GIFTs_domains_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "sample") %>% 
  merge(sample_metadata %>% select(sample,sex,broad_environment), by="sample")
```

```{r commun_wilcox_dom_gut, comment="", message=FALSE, warning=FALSE}
unique_domain_db<- GIFT_db[c(4)] %>% 
  distinct(Domain, .keep_all = TRUE)

significant_domain <- domain_gift %>%
    pivot_longer(-c(sample,sex,broad_environment), names_to = "trait", values_to = "value") %>%
    group_by(trait) %>%
    summarise(p_value = wilcox.test(value ~ sex)$p.value) %>%
    mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
    filter(p_adjust < 0.05)
```

```{r  domain_sig, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
domain_gift_t <- domain_gift  %>% 
  select(-sex)  %>% 
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "trait")

domain_gift_filt <- subset(domain_gift_t, trait %in% significant_domain$trait) %>% 
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric) %>%
  rownames_to_column(., "sample") %>%
  left_join(sample_metadata[c("sample", "sex", "broad_environment")], by = join_by(sample == sample)) %>%
  filter(!is.na(sex))

  
domain_gift_filt %>%
  select(-sample)%>%
  group_by(sex)  %>%
  summarise(across(everything(), mean))%>%
   t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Code_domain")

```

```{r domain_plot, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
domain_gift_names <- domain_gift_filt%>%
  select(-sex)%>%
   t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Code_domain")  %>%
  # select(-Code_domain)%>%
  # select(domain, everything())%>%
   t()%>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "sample")%>% 
  left_join(., sample_metadata[c("sample", "sex", "broad_environment")], by = join_by(sample == sample))


colNames <- names(domain_gift_names)[2:3]
for(i in colNames){
  plt <- ggplot(domain_gift_names, aes(x=sex, y=.data[[i]], color = sex, fill=sex)) +
    geom_boxplot(alpha = 0.2, outlier.shape = NA, width = 0.3, show.legend = FALSE) +
  geom_jitter(width = 0.1, show.legend = TRUE) +
    scale_color_manual(values=treatment_colors)+
    scale_fill_manual(values=treatment_colors)+
  theme_minimal() +
  theme(
    axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())
print(plt)
}
```

<!--chapter:end:08_microbiota_functional_analysis.Rmd-->

#Enviromentypes

##Landcover percentage

# Load libraries

# required libraries
```{r load_libraries_enviroment, warning=FALSE, comments="", message=FALSE}      
library(sf)
library(terra)
library(exactextractr)
```


# 1. sample points
```{r sample_points, warning=FALSE, comments="", message=FALSE}
sample_points <- read.csv("sample_points.csv")
points_sf <- st_as_sf(sample_points, coords = c("longitude", "latitude"), crs = 4326)
points_proj <- st_transform(points_sf, 28355)  # GDA94 / MGA Zone 55 — meters
```
# 2. 150-meter buffer zones
```{r buffer_zones, warning=FALSE, comment="", message=FALSE, eval=FALSE}
   buffers <- st_buffer(points_proj, dist = 150)

landcover <- rast("Merged.tif")  # adjust if name differs
landcover <- project(landcover, "EPSG:28355")  # match CRS to buffer layer

extracted <- exact_extract(landcover, buffers)

summary_list <- lapply(seq_along(extracted), function(i) {
  df <- extracted[[i]]
  agg <- aggregate(df$coverage_fraction, by = list(class = round(df$value)), sum)
  colnames(agg) <- c("land_cover_class", "fraction")
  agg$percent <- round(100 * agg$fraction / sum(agg$fraction), 2)
  agg$id <- sample_points$id[i]
  agg
})
```


# 3. Combine buffer summaries with landcover classes
```{r buffer_table, warning=FALSE, comments="", message=FALSE}
result_df <- do.call(rbind, summary_list)

# Load legend CSV
legend <- read.csv("C:\\Users\\Lukas\\Documents\\GitHub\\btp_metagenomics\\Full_Legend_with_Simplified_Labels.csv")
groupinglabels <- read.csv("C:/Users/Lukas/Documents/GitHub/btp_metagenomics/Detailed_Land_Cover_Groupings.csv")



result_df <- result_df %>%
  left_join(legend[, c("land_cover_class", "land_cover_description")], by = "land_cover_class")

result_df <- result_df %>%
  left_join(groupinglabels[, c("land_cover_description", "detailed_category_group")], by = "land_cover_description")


```

#4 Production of contious variabels  (TODO : Check for the NAs in the landcover - where do they come from)
```{r continous variables, warning=FALSE, comments="", message=FALSE}

# Remove rows with missing land_cover_description
result_df_clean <- result_df %>%
  filter(!is.na(land_cover_description))

# Pivot to wide format using full land cover descriptions
landcover_wide <- result_df_clean %>%
  pivot_wider(
    id_cols = id,
    names_from = land_cover_description,
    values_from = percent,
    values_fill = list(percent = 0)
  )

# Make sure all percent columns are numeric
landcover_wide <- landcover_wide %>%
  mutate(across(-id, ~ as.numeric(unlist(.))))

# Create continuous summary variables per buffer
landcover_wide <- landcover_wide %>%
  mutate(
    Cultivated_Total          = rowSums(select(., starts_with("Cultivated"))),
    Native_Terrestrial_Total  = rowSums(select(., starts_with("Natural Terrestrial Vegetated"))),
    Native_Aquatic_Total      = rowSums(select(., starts_with("Natural Aquatic Vegetated"))),
    Water      = rowSums(select(., starts_with("Water"))),
    Bare_Urban                = rowSums(select(., starts_with("Natural Surface")), na.rm = TRUE)
  )

```

#5 Visualisation
```{r stackedbarplot, warning=FALSE, comments="", message=FALSE}

# Set order of categories
result_df$detailed_category_group <- factor(
  result_df$detailed_category_group,
  levels = c(
    "Cultivated Vegetation - Woody",
    "Cultivated Vegetation - Herbaceous",
    "Natural Vegetation - Woody",
    "Natural Vegetation - Herbaceous",
    "Natural Vegetation - General",
    "Natural Vegetation - Sparse",
    "Bare Surface",
    "Urban/Artificial",
    "Aquatic Vegetation",
    "Water",
    "Other"
  )
)

# Define colors (same order as above)
group_colors <- c(
  "Cultivated Vegetation - Woody"      = "#6a51a3",
  "Cultivated Vegetation - Herbaceous" = "#9e9ac8",

  "Natural Vegetation - Woody"         = "#006400",
  "Natural Vegetation - Herbaceous"    = "#1b9e77",
  "Natural Vegetation - Sparse"        = "#e6c229",  
  "Natural Vegetation - General"       = "#b2df8a",

  "Aquatic Vegetation"                 = "#41b6c4",
  "Bare Surface"                       = "#e6ab02",
  "Urban/Artificial"                   = "#757575",
  "Water"                              = "#1f78b4",
  "Other"                              = "#cccccc"
)





# Generate the plot
p <- ggplot(result_df, aes(x = id, y = percent, fill = detailed_category_group)) +
  geom_bar(stat = "identity", position = "stack", width = 0.8) +
  scale_fill_manual(values = group_colors, na.value = "gray90") +
  labs(
    title = "Land Cover Composition per Sample",
    x = "Sample ID",
    y = "Land Cover (%)",
    fill = "Land Cover Category"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 10),
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    panel.grid.major.x = element_blank()
  )

print(p)

# Save high-res output
ggsave("land_cover_composition_per_sample.png", p, width = 12, height = 6, dpi = 300)

```
#Merging Metadata with Landcover



# Join with landcover data by sample ID
```{r fusing, warning=FALSE, comments="", message=FALSE}
NaturalvsCultivated <- left_join(sample_metadata, landcover_wide, by = c("sample" = "id"))
```


```{r Cultivated_diversity, warning=FALSE, comments="", message=FALSE}
ggplot(NaturalvsCultivated, aes(x = Cultivated_Total, y = diversity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Microbiome Diversity vs. Cultivated Land")
```

```{r Native_diversity, warning=FALSE, comments="", message=FALSE}
ggplot(NaturalvsCultivated, aes(x = Native_Terrestrial_Total, y = diversity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Microbiome Diversity vs. Native_Land")
```

```{r Cultivated_diversity2, warning=FALSE, comments="", message=FALSE}
ggplot(NaturalvsCultivated, aes(x = Bare_Urban, y = diversity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Microbiome Diversity vs. Urban_Land")
```

```{r model_diversitys, warning=FALSE, comments="", message=FALSE}
lm_mod <- lm(diversity ~ Cultivated_Total + Native_Terrestrial_Total + Bare_Urban, data = NaturalvsCultivated)
summary(lm_mod)



ggplot(NaturalvsCultivated, aes(x = broad_environment, y = diversity)) +
  geom_boxplot() +
  theme_minimal()
```

```{r model_diversitys_2, warning=FALSE, comments="", message=FALSE}
NaturalvsCultivated$native_group <- cut(
  NaturalvsCultivated$Native_Terrestrial_Total,
  breaks = c(-1, 25, 75, 100),
  labels = c("Low", "Medium", "High")
)

ggplot(NaturalvsCultivated, aes(x = native_group, y = diversity)) +
  geom_boxplot(fill = "#1b9e77") +
  theme_minimal() +
  labs(title = "Diversity by Native Vegetation Group", x = "Native Cover Group", y = "Diversity")

aov_model <- aov(diversity ~ native_group, data = NaturalvsCultivated)
summary(aov_model)
```

```{r model_diversitys_3, warning=FALSE, comments="", message=FALSE}
NaturalvsCultivated$native_group <- cut(
  NaturalvsCultivated$Cultivated_Total,
  breaks = c(-1, 25, 75, 100),
  labels = c("Low", "Medium", "High")
)

ggplot(NaturalvsCultivated, aes(x = native_group, y = diversity)) +
  geom_boxplot(fill = "#1b9e77") +
  theme_minimal() +
  labs(title = "Diversity by Native Vegetation Group", x = "Native Cover Group", y = "Diversity")

aov_model <- aov(diversity ~ native_group, data = NaturalvsCultivated)
summary(aov_model)
```

```{r continous_enviroment, warning=FALSE, comments="", message=FALSE}
# Select only percent cover columns
landcover_numeric <- landcover_wide %>%
  select(Cultivated_Total, Native_Terrestrial_Total, Native_Aquatic_Total, Bare_Urban, Water) %>%
  na.omit()  # Ensure no NAs

# Standardize (mean = 0, sd = 1) before PCA
landcover_scaled <- scale(landcover_numeric)

# Run PCA
pca_result <- prcomp(landcover_scaled)

# Inspect variance explained
summary(pca_result)

# Add first PC (environmental gradient) to landcover data
landcover_wide$EnvGradient_PC1 <- pca_result$x[, 1]
```

```{r continous_enviroment_2, warning=FALSE, comments="", message=FALSE}

# Merge PCA-derived gradient to microbiome data
NaturalvsCultivated <- left_join(sample_metadata, landcover_wide, by = c("sample" = "id"))


ggplot(NaturalvsCultivated, aes(x = EnvGradient_PC1, y = diversity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Microbiome Diversity vs. Environmental Gradient (PC1)",
       x = "Environmental Gradient (PC1)",
       y = "Diversity") +
  theme_minimal()
```
```{r continous_woody_herbacous, warning=FALSE, comments="", message=FALSE}

# === 1. Define column groups ===

# Columns that represent woody vegetation cover
woody_cols <- c(
  "Natural Terrestrial Vegetated: Woody Closed (> 65 %)",
  "Natural Terrestrial Vegetated: Woody Open (40 to 65 %)",
  "Natural Terrestrial Vegetated: Woody Sparse (4 to 15 %)",
  "Natural Terrestrial Vegetated: Woody Scattered (1 to 4 %)"
)

# Columns that represent herbaceous vegetation cover
herbaceous_cols <- c(
  "Natural Terrestrial Vegetated: Herbaceous Closed (> 65 %)",
  "Natural Terrestrial Vegetated: Herbaceous Open (40 to 65 %)",
  "Natural Terrestrial Vegetated: Herbaceous Open (15 to 40 %)",
  "Natural Terrestrial Vegetated: Herbaceous Sparse (4 to 15 %)",
  "Natural Terrestrial Vegetated: Herbaceous Scattered (1 to 4 %)"
)

# === 2. Create gradients with PCA ===

# Scale and run PCA for woody
woody_pca <- prcomp(landcover_wide[, woody_cols], center = TRUE, scale. = TRUE)
landcover_wide$Woody_Gradient_PC1 <- woody_pca$x[, 1]

# Scale and run PCA for herbaceous
herb_pca <- prcomp(landcover_wide[, herbaceous_cols], center = TRUE, scale. = TRUE)
landcover_wide$Herbaceous_Gradient_PC1 <- herb_pca$x[, 1]

# === 3. View summary or write out ===
summary(woody_pca)
summary(herb_pca)

# Optional: write to CSV for merging later
write.csv(landcover_wide[, c("id", "Woody_Gradient_PC1", "Herbaceous_Gradient_PC1")],
          "environmental_gradients.csv", row.names = FALSE)
```


```{r weigthed_cover, warning=FALSE, comments="", message=FALSE}

# Add estimated % cover per class
landcover_wide_weighted <- landcover_wide %>%
  mutate(
    Woody_Cover = 
      `Natural Terrestrial Vegetated: Woody Closed (> 65 %)`       * 0.85 +
      `Natural Terrestrial Vegetated: Woody Open (40 to 65 %)`     * 0.525 +
      `Natural Terrestrial Vegetated: Woody Sparse (4 to 15 %)`    * 0.095 +
      `Natural Terrestrial Vegetated: Woody Scattered (1 to 4 %)`  * 0.025,

    Herbaceous_Cover = 
      `Natural Terrestrial Vegetated: Herbaceous Closed (> 65 %)`       * 0.85 +
      `Natural Terrestrial Vegetated: Herbaceous Open (40 to 65 %)`     * 0.525 +
      `Natural Terrestrial Vegetated: Herbaceous Open (15 to 40 %)`     * 0.275 +
      `Natural Terrestrial Vegetated: Herbaceous Sparse (4 to 15 %)`    * 0.095 +
      `Natural Terrestrial Vegetated: Herbaceous Scattered (1 to 4 %)`  * 0.025
  )


```

```{r true_cover_fuse, warning=FALSE, comments="", message=FALSE}
weigthed_continues <-left_join(sample_metadata, landcover_wide_weighted, by = c("sample" = "id"))
```
                                 
```{r true_cover_woddy, warning=FALSE, comments="", message=FALSE}                                 
ggplot(weigthed_continues, aes(x = Woody_Cover, y = diversity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Estimated Woody Cover (%)", y = "Microbiome Diversity")
```
```{r true%_cover_c_woody, warning=FALSE, comments="", message=FALSE, eval = FALSE}                                 
ggplot(weigthed_continues, aes(x = Woody_Cover, y = C)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Estimated Woody Cover (%)", y = "Microbiome Diversity")
```

```{r true%_cover_herbaceous, warning=FALSE, comments="", message=FALSE}                                 
ggplot(weigthed_continues, aes(x = Herbaceous_Cover, y = diversity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Estimated Herbaceous Cover (%)", y = "Microbiome Diversity")
```

```{r true%_cover_c_herbaceous, warning=FALSE, comments="", message=FALSE}                                 
ggplot(weigthed_continues, aes(x = Herbaceous_Cover, y = C)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Estimated Herbaceous Cover (%)", y = "Microbiome Diversity")
```


```{r true%_cover_div, warning=FALSE, comments="", message=FALSE}  

weigthed_continues$Total_Veg_Cover <- weigthed_continues$Woody_Cover + weigthed_continues$Herbaceous_Cover

ggplot(weigthed_continues, aes(x = Total_Veg_Cover, y = diversity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Total Vegetative Cover (%)", y = "Microbiome Diversity") +
  theme_minimal()
```

```{r true%_cover_c, warning=FALSE, comments="", message=FALSE}  

ggplot(weigthed_continues, aes(x = Total_Veg_Cover, y = C)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Total Vegetative Cover (%)", y = "Microbiome Diversity") +
  theme_minimal()
```

```{r true%_cover_regression_div, warning=FALSE, comments="", message=FALSE}  
model <- lm(diversity ~ Woody_Cover + Herbaceous_Cover, data = weigthed_continues)
summary(model)
```

```{r true%_cover_regression_c, warning=FALSE, comments="", message=FALSE}  
model <- lm(C ~ Woody_Cover + Herbaceous_Cover, data = weigthed_continues)
summary(model)
```
```{r genom_count_vegcover, comment="", echo=FALSE, message=FALSE, warning=FALSE}
# Prep genome counts
genome_counts_filt <- genome_counts_filt[genome_counts_filt$genome %in% rownames(genome_gifts),] 
rownames(genome_counts_filt) <- NULL
```

```{r gift2, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
# Aggregate GIFTs
GIFTs_elements <- to.elements(genome_gifts, GIFT_db)
GIFTs_elements_filtered <- GIFTs_elements[rownames(GIFTs_elements) %in% genome_counts_filt$genome, ] %>% 
  select_if(~ !is.numeric(.) || sum(.) != 0)

GIFTs_functions <- to.functions(GIFTs_elements_filtered, GIFT_db)
GIFTs_domains   <- to.domains(GIFTs_functions, GIFT_db)

# Community-weighted GIFTs
genome_counts_row <- genome_counts_filt %>%
  mutate_at(vars(-genome), ~ ./sum(.)) %>% 
  column_to_rownames("genome")

GIFTs_elements_community   <- to.community(GIFTs_elements_filtered, genome_counts_row, GIFT_db)
GIFTs_functions_community  <- to.community(GIFTs_functions, genome_counts_row, GIFT_db)
GIFTs_domains_community    <- to.community(GIFTs_domains, genome_counts_row, GIFT_db)
```

## Functional variation by Vegetational Gradient

```{r linear_models_gradient, echo=TRUE, results=TRUE, warning=FALSE, message=FALSE, eval = FALSE}
# Linear models per function using Total_Veg_Cover as predictor
lm_results <- apply(GIFTs_functions_community, 1, function(func) {
  summary(lm(func ~ sample_metadata$Total_Veg_Cover))$coefficients[2, ]
})

# Structure results
lm_df <- as.data.frame(t(lm_results))
colnames(lm_df) <- c("Estimate", "StdError", "t_value", "p_value")

# Sort by significance
lm_df <- lm_df %>% arrange(p_value)

# View top hits
head(lm_df)
```

```{r visualize_significant_functions, echo=TRUE, warning=FALSE, message=FALSE, eval = FALSE}
# Plot top functions
library(ggplot2)
lm_df$Function <- rownames(lm_df)
top_hits <- lm_df %>% filter(p_value < 0.05) %>% head(10)

ggplot(top_hits, aes(x = reorder(Function, Estimate), y = Estimate)) +
  geom_col(fill = "#6a51a3") +
  coord_flip() +
  labs(title = "Top Functional Shifts by Vegetation Gradient",
       x = "Functional Category", y = "Effect Size (Estimate)") +
  theme_minimal()
```

```{r heatmap_significant_functions, echo=TRUE, warning=FALSE, message=FALSE, eval = FALSE}
# Heatmap of significant functions
library(pheatmap)

sig_functions <- rownames(lm_df)[lm_df$p_value < 0.05]
heat_data <- GIFTs_functions_community[sig_functions, ]

# Scale across samples for visualization
heat_data_scaled <- t(scale(t(heat_data)))

pheatmap(heat_data_scaled,
         main = "Heatmap of Significant Functional Shifts",
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         fontsize_row = 8,
         fontsize_col = 6)
```


```{r ancom_save2, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
save(weigthed_continues, Total_Veg_Cover, landcover_wide_weighted
     file="data/vegcover.Rdata")
```

<!--chapter:end:09_Enviroment_types.Rmd-->

